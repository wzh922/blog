<!DOCTYPE html>
<html data-color-mode="light" data-dark-theme="dark" data-light-theme="light" lang="zh-CN">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href='https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/Primer/21.0.7/primer.css' rel='stylesheet' />
    <script src='https://blog.meekdai.com/Gmeek/plugins/GmeekBSZ.js'></script>
    <link rel="icon" href="https://avatars.githubusercontent.com/u/210956220?s=400&u=c0d549ac9c109d6ad35fde23e0aff5b3213fc57e&v=4"><script>
        let theme = localStorage.getItem("meek_theme") || "light";
        document.documentElement.setAttribute("data-color-mode", theme);
    </script>
<meta name="description" content="# 实用代码

## geojson 转 shp

```python
import geopandas as gpd
import pandas as pd
import os
from shapely.geometry import shape
import fiona

def geojson_to_shp(geojson_file, shp_file):
    '''
    将GeoJSON文件转换为Shapefile文件
    
    参数:
    geojson_file: 输入的GeoJSON文件路径
    shp_file: 输出的Shapefile文件路径
    '''
    try:
        # 读取GeoJSON文件
        print(f'正在读取GeoJSON文件: {geojson_file}')
        gdf = gpd.read_file(geojson_file)
        
        # 确保输出目录存在
        output_dir = os.path.dirname(shp_file)
        if output_dir and not os.path.exists(output_dir):
            os.makedirs(output_dir)
        
        # 保存为Shapefile
        print(f'正在转换为Shapefile: {shp_file}')
        gdf.to_file(shp_file, encoding='utf-8')
        
        print('转换完成!')
        return True
        
    except Exception as e:
        print(f'转换过程中发生错误: {e}')
        return False
 def read_shp_info(shp_file):
    '''
    读取Shapefile文件并打印各种信息
    
    参数:
    shp_file: Shapefile文件路径
    '''
    try:
        # 读取Shapefile
        print(f'\n正在读取Shapefile文件: {shp_file}')
        gdf = gpd.read_file(shp_file)
        
        # 1. 基本信息
        print('\n' + '='*50)
        print('Shapefile基本信息')
        print('='*50)
        print(f'文件路径: {shp_file}')
        print(f'要素数量: {len(gdf)}')
        print(f'几何类型: {gdf.geometry.type.unique()}')
        print(f'坐标参考系(CRS): {gdf.crs}')
        
        # 2. 字段信息
        print('\n' + '='*50)
        print('字段信息')
        print('='*50)
        print(f'字段数量: {len(gdf.columns)}')
        print('字段详情:')
        for i, col in enumerate(gdf.columns, 1):
            dtype = gdf[col].dtype
            print(f'  {i}. {col} ({dtype})')
        
        # 3. 属性表预览
        print('\n' + '='*50)
        print('属性表前5行')
        print('='*50)
        print(gdf.head())
        
        # 4. 空间范围
        print('\n' + '='*50)
        print('空间范围')
        print('='*50)
        bounds = gdf.total_bounds
        print(f'最小X: {bounds[0]:.6f}')
        print(f'最小Y: {bounds[1]:.6f}')
        print(f'最大X: {bounds[2]:.6f}')
        print(f'最大Y: {bounds[3]:.6f}')
        
        # 5. 几何信息统计
        print('\n' + '='*50)
        print('几何信息统计')
        print('='*50)
        print(f'总面积: {gdf.area.sum():.6f} 平方单位')
        print(f'总长度: {gdf.length.sum():.6f} 单位')
        
        # 6. 各几何类型的数量统计
        print('\n' + '='*50)
        print('几何类型统计')
        print('='*50)
        geometry_counts = gdf.geometry.type.value_counts()
        for geom_type, count in geometry_counts.items():
            print(f'{geom_type}: {count} 个')
        
        # 7. 空间参考系统详细信息
        print('\n' + '='*50)
        print('坐标参考系详细信息')
        print('='*50)
        if gdf.crs is not None:
            crs_info = gdf.crs.to_dict()
            for key, value in crs_info.items():
                print(f'{key}: {value}')
        else:
            print('未定义坐标参考系')
            
        # 8. 内存使用情况
        print('\n' + '='*50)
        print('内存使用信息')
        print('='*50)
        memory_usage = gdf.memory_usage(deep=True).sum()
        print(f'总内存使用: {memory_usage / 1024:.2f} KB')
        
        return gdf
        
    except Exception as e:
        print(f'读取Shapefile时发生错误: {e}')
        return None
geojson_file = r'D:\DownLoad\chrome\黔东南苗族侗族自治州_县.geojson'  # 替换为您的GeoJSON文件路径
shp_file = '黔东南苗族侗族自治州_县.shp'

# 执行转换
print('\n开始GeoJSON到Shapefile的转换...')
success = geojson_to_shp(geojson_file, shp_file)

if success:
    # 读取并显示Shapefile信息
    gdf = read_shp_info(shp_file)
    
    # 可选: 显示更多详细信息
    if gdf is not None:
        print('\n' + '='*50)
        print('前3个要素的详细信息')
        print('='*50)
        for i, (idx, row) in enumerate(gdf.head(3).iterrows()):
            print(f'\n要素 {i+1}:')
            for col in gdf.columns:
                if col != 'geometry':
                    print(f'  {col}: {row[col]}')
            print(f'  几何类型: {row.geometry.geom_type}')
            print(f'  面积: {row.geometry.area:.2f}')
            print(f'  边界: {row.geometry.bounds}')

print('\n程序执行完成!')
```

## 切分shp，切分县

### 切分2块

#### 代码

```python
import geopandas as gpd
import pandas as pd
import numpy as np
from shapely.geometry import Polygon, MultiPolygon, LineString
from shapely.ops import split
import os
import math

def split_polygon_into_two(polygon, split_direction='longest'):
    '''
    将多边形切分为两部分
    '''
    try:
        if polygon.is_empty:
            return None, None
            
        # 获取多边形的边界框
        minx, miny, maxx, maxy = polygon.bounds
        
        if split_direction == 'longest':
            # 按最长边方向切分
            width = maxx - minx
            height = maxy - miny
            if width > height:
                split_direction = 'vertical'
            else:
                split_direction = 'horizontal'
        
        if split_direction == 'vertical':
            # 垂直切分（东西方向）
            mid_x = (minx + maxx) / 2
            split_line = LineString([(mid_x, miny - 1), (mid_x, maxy + 1)])
        else:
            # 水平切分（南北方向）
            mid_y = (miny + maxy) / 2
            split_line = LineString([(minx - 1, mid_y), (maxx + 1, mid_y)])
        
        # 执行切分
        split_parts = split(polygon, split_line)
        
        # 过滤有效的多边形
        valid_parts = [part for part in split_parts.geoms 
                      if isinstance(part, (Polygon, MultiPolygon)) and not part.is_empty]
        
        if len(valid_parts) >= 2:
            return valid_parts[0], valid_parts[1]
        else:
            # 如果切分不成功，尝试对角线切分
            return split_by_diagonal(polygon)
            
    except Exception as e:
        print(f'切分多边形时出错: {e}')
        return split_by_diagonal(polygon)

def split_by_diagonal(polygon):
    '''
    通过对角线切分的备选方法
    '''
    try:
        minx, miny, maxx, maxy = polygon.bounds
        # 从左上到右下
        split_line = LineString([(minx, maxy), (maxx, miny)])
        split_parts = split(polygon, split_line)
        
        valid_parts = [part for part in split_parts.geoms 
                      if isinstance(part, (Polygon, MultiPolygon)) and not part.is_empty]
        
        if len(valid_parts) >= 2:
            return valid_parts[0], valid_parts[1]
        else:
            # 从右上到左下
            split_line = LineString([(maxx, maxy), (minx, miny)])
            split_parts = split(polygon, split_line)
            valid_parts = [part for part in split_parts.geoms 
                          if isinstance(part, (Polygon, MultiPolygon)) and not part.is_empty]
            
            if len(valid_parts) >= 2:
                return valid_parts[0], valid_parts[1]
            else:
                print('所有切分方法都失败，返回原始多边形')
                return polygon, polygon
    except Exception as e:
        print(f'对角线切分也失败: {e}')
        return polygon, polygon

def auto_detect_town_field(gdf):
    '''
    自动检测乡镇名字段
    '''
    # 常见的中文乡镇字段名
    town_keywords = ['镇', '乡', '街道', 'town', 'TOWN', 'name', 'NAME', '名称', '地名']
    
    for field in gdf.columns:
        field_lower = str(field).lower()
        # 检查字段名是否包含乡镇相关关键词
        for keyword in town_keywords:
            if keyword.lower() in field_lower:
                return field
        
        # 检查字段内容是否包含乡镇特征
        sample_values = gdf[field].dropna().head(10)
        if len(sample_values) > 0:
            sample_str = ' '.join(str(x) for x in sample_values)
            if any(keyword in sample_str for keyword in ['镇', '乡', '街道']):
                return field
    
    # 如果没有找到，返回第一个非几何字段
    non_geom_fields = [col for col in gdf.columns if col != gdf.geometry.name]
    return non_geom_fields[0] if non_geom_fields else gdf.columns[0]

def auto_detect_county_field(gdf):
    '''
    自动检测县名字段
    '''
    # 常见的中文县字段名
    county_keywords = ['县', '区', '市', 'county', 'COUNTY', 'city', 'CITY']
    
    for field in gdf.columns:
        field_lower = str(field).lower()
        for keyword in county_keywords:
            if keyword.lower() in field_lower:
                return field
        
        # 检查字段内容是否包含县区特征
        sample_values = gdf[field].dropna().head(10)
        if len(sample_values) > 0:
            sample_str = ' '.join(str(x) for x in sample_values)
            if any(keyword in sample_str for keyword in ['县', '区', '市']):
                return field
    
    # 如果没有找到，尝试用乡镇字段名
    town_field = auto_detect_town_field(gdf)
    if town_field != gdf.columns[0]:
        return gdf.columns[0]
    else:
        return '未知县'

def clean_filename(name):
    '''
    清理文件名，移除非法字符
    '''
    import re
    # 移除Windows文件名中的非法字符
    illegal_chars = r'[<>:'/\\|?*]'
    cleaned = re.sub(illegal_chars, '_', str(name))
    # 移除开头和结尾的空格和点号
    cleaned = cleaned.strip().strip('.')
    # 限制文件名长度
    if len(cleaned) > 100:
        cleaned = cleaned[:100]
    return cleaned

def save_single_shapefile(gdf, output_path, file_name):
    '''
    保存单个Shapefile文件
    '''
    try:
        # 确保输出目录存在
        output_dir = os.path.dirname(output_path)
        if not os.path.exists(output_dir):
            os.makedirs(output_dir)
        
        # 完整的文件路径
        full_path = os.path.join(output_path, f'{file_name}.shp')
        
        # 保存为Shapefile
        gdf.to_file(full_path, encoding='utf-8')
        
        print(f'  已保存: {file_name}.shp')
        return True
        
    except Exception as e:
        print(f'  保存文件 {file_name}.shp 时出错: {e}')
        return False

def split_towns_to_individual_files(shp_file, output_dir):
    '''
    自动读取县级shp文件，将每个乡镇切分为两部分，并保存为单独的shp文件
    
    参数:
    shp_file: 输入的县级Shapefile文件路径
    output_dir: 输出目录
    '''
    
    # 确保输出目录存在
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)
    
    try:
        # 读取Shapefile
        print(f'正在读取文件: {shp_file}')
        gdf = gpd.read_file(shp_file)
        
        # 自动检测字段
        town_field = auto_detect_town_field(gdf)
        county_field = auto_detect_county_field(gdf)
        
        print(f'检测到县字段: {county_field}')
        print(f'检测到乡镇字段: {town_field}')
        
        # 显示字段信息
        print(f'\n所有字段: {list(gdf.columns)}')
        print(f'几何类型: {gdf.geometry.type.unique()}')
        print(f'要素数量: {len(gdf)}')
        
        # 显示乡镇列表
        towns = gdf[town_field].unique()
        print(f'\n发现 {len(towns)} 个乡镇:')
        for i, town in enumerate(towns, 1):
            print(f'  {i}. {town}')
        
        # 获取县名
        if county_field in gdf.columns and len(gdf[county_field].unique()) == 1:
            county_name = gdf[county_field].iloc[0]
        else:
            # 从文件名提取县名或使用默认值
            county_name = os.path.basename(shp_file).replace('.shp', '')
            print(f'使用文件名作为县名: {county_name}')
        
        # 清理县名用于文件名
        county_name_clean = clean_filename(county_name)
        
        # 创建县目录
        county_dir = os.path.join(output_dir, county_name_clean)
        if not os.path.exists(county_dir):
            os.makedirs(county_dir)
        
        print(f'\n开始切分并保存乡镇文件...')
        print('='*60)
        
        success_count = 0
        fail_count = 0
        total_files_created = 0
        
        for idx, row in gdf.iterrows():
            town_name = row[town_field]
            geometry = row.geometry
            
            print(f'\n处理乡镇: {town_name}')
            
            # 清理乡镇名用于文件名
            town_name_clean = clean_filename(town_name)
            
            # 处理MultiPolygon
            if isinstance(geometry, MultiPolygon):
                polygons = list(geometry.geoms)
            else:
                polygons = [geometry]
            
            town_parts = []
            
            for poly_idx, polygon in enumerate(polygons):
                # 切分多边形
                part1, part2 = split_polygon_into_two(polygon)
                
                if part1 is not None and part2 is not None and not part1.equals(part2):
                    town_parts.extend([part1, part2])
                    print(f'  ✓ 成功切分第{poly_idx+1}个多边形')
                else:
                    # 如果切分失败，使用边界框切分
                    print(f'  ⚠ 第{poly_idx+1}个多边形切分不理想，使用边界框切分')
                    part1, part2 = split_by_bounds(polygon)
                    if part1 is not None and part2 is not None and not part1.equals(part2):
                        town_parts.extend([part1, part2])
                    else:
                        print(f'  ✗ 第{poly_idx+1}个多边形切分完全失败，保留原状')
                        town_parts.append(polygon)
            
            # 为每个部分创建单独的shp文件
            for i, part in enumerate(town_parts[:2], 1):  # 只取前两个部分
                # 创建新的GeoDataFrame
                new_row = row.copy()
                new_row.geometry = part
                # 添加切分信息
                new_row['SPLIT_ID'] = f'{county_name}-{town_name}-{i}'
                new_row['ORIGINAL_TOWN'] = town_name
                new_row['SPLIT_PART'] = i
                new_row['COUNTY_NAME'] = county_name
                
                single_gdf = gpd.GeoDataFrame([new_row], crs=gdf.crs)
                
                # 生成文件名
                file_name = f'{county_name_clean}-{town_name_clean}-{i}'
                
                # 保存为单独的shp文件
                if save_single_shapefile(single_gdf, county_dir, file_name):
                    total_files_created += 1
                    print(f'  ✓ 保存: {file_name}.shp')
                else:
                    print(f'  ✗ 保存失败: {file_name}.shp')
            
            if len(town_parts) >= 2:
                success_count += 1
            else:
                fail_count += 1
        
        print(f'\n' + '='*60)
        print(f'处理完成!')
        print('='*60)
        print(f'原始乡镇数量: {len(gdf)}')
        print(f'成功切分: {success_count} 个乡镇')
        print(f'切分失败: {fail_count} 个乡镇')
        print(f'创建的shp文件总数: {total_files_created}')
        print(f'输出目录: {county_dir}')
        
        # 显示生成的文件列表
        print(f'\n生成的文件列表:')
        shp_files = [f for f in os.listdir(county_dir) if f.endswith('.shp')]
        for i, file in enumerate(shp_files[:20], 1):  # 只显示前20个文件
            print(f'  {i}. {file}')
        
        if len(shp_files) > 20:
            print(f'  ... 还有 {len(shp_files) - 20} 个文件')
        
        # 保存处理日志
        save_processing_log(county_dir, county_name, gdf, success_count, fail_count, total_files_created)
        
        return total_files_created
        
    except Exception as e:
        print(f'处理过程中发生错误: {e}')
        import traceback
        traceback.print_exc()
        return 0

def split_by_bounds(polygon):
    '''
    使用边界框进行切分
    '''
    try:
        minx, miny, maxx, maxy = polygon.bounds
        center_x, center_y = (minx + maxx) / 2, (miny + maxy) / 2
        
        # 创建四个象限的矩形
        rect1 = Polygon([(minx, miny), (center_x, miny), (center_x, center_y), (minx, center_y), (minx, miny)])
        rect2 = Polygon([(center_x, miny), (maxx, miny), (maxx, center_y), (center_x, center_y), (center_x, miny)])
        rect3 = Polygon([(minx, center_y), (center_x, center_y), (center_x, maxy), (minx, maxy), (minx, center_y)])
        rect4 = Polygon([(center_x, center_y), (maxx, center_y), (maxx, maxy), (center_x, maxy), (center_x, center_y)])
        
        # 与原始多边形求交
        parts = []
        for rect in [rect1, rect2, rect3, rect4]:
            intersection = polygon.intersection(rect)
            if not intersection.is_empty and intersection.area > 0:
                if isinstance(intersection, MultiPolygon):
                    parts.extend(list(intersection.geoms))
                else:
                    parts.append(intersection)
        
        # 按面积排序，取前两个最大的部分
        parts.sort(key=lambda x: x.area, reverse=True)
        if len(parts) >= 2:
            return parts[0], parts[1]
        elif len(parts) == 1:
            return parts[0], parts[0]
        else:
            return polygon, polygon
            
    except Exception as e:
        print(f'边界框切分失败: {e}')
        return polygon, polygon

def save_processing_log(output_dir, county_name, original_gdf, success_count, fail_count, total_files):
    '''
    保存处理日志
    '''
    try:
        log_file = os.path.join(output_dir, f'处理日志.txt')
        
        with open(log_file, 'w', encoding='utf-8') as f:
            f.write(f'乡镇切分处理日志\n')
            f.write(f'=' * 50 + '\n')
            f.write(f'处理时间: {pd.Timestamp.now().strftime('%Y-%m-%d %H:%M:%S')}\n')
            f.write(f'县名称: {county_name}\n')
            f.write(f'原始乡镇数量: {len(original_gdf)}\n')
            f.write(f'成功切分: {success_count} 个乡镇\n')
            f.write(f'切分失败: {fail_count} 个乡镇\n')
            f.write(f'生成的shp文件总数: {total_files}\n')
            f.write(f'\n原始乡镇列表:\n')
            
            town_field = auto_detect_town_field(original_gdf)
            for town in original_gdf[town_field].unique():
                f.write(f'  - {town}\n')
        
        print(f'处理日志已保存: {log_file}')
        
    except Exception as e:
        print(f'保存处理日志时出错: {e}')

# 使用示例
if __name__ == '__main__':
    # 输入文件路径 - 替换为您的县级Shapefile路径
    input_shp = '黔东南苗族侗族自治州_县.shp'  # 您的县级shp文件
    output_directory = input_shp.split('.')[0]
    
    print('开始自动切分乡镇并保存为单独文件...')
    print('='*60)
    
    # 执行切分
    files_created = split_towns_to_individual_files(
        shp_file=input_shp,
        output_dir=output_directory
    )
    
    if files_created > 0:
        print(f'\n' + '='*60)
        print('处理完成！')
        print('='*60)
        print(f'总共生成了 {files_created} 个shp文件')
        print(f'文件命名格式: 县名-镇名-编号.shp')
        print(f'示例: 某县-某镇-1.shp, 某县-某镇-2.shp')
    else:
        print('\n处理失败，请检查输入文件和错误信息。">
<meta property="og:title" content="实用代码">
<meta property="og:description" content="# 实用代码

## geojson 转 shp

```python
import geopandas as gpd
import pandas as pd
import os
from shapely.geometry import shape
import fiona

def geojson_to_shp(geojson_file, shp_file):
    '''
    将GeoJSON文件转换为Shapefile文件
    
    参数:
    geojson_file: 输入的GeoJSON文件路径
    shp_file: 输出的Shapefile文件路径
    '''
    try:
        # 读取GeoJSON文件
        print(f'正在读取GeoJSON文件: {geojson_file}')
        gdf = gpd.read_file(geojson_file)
        
        # 确保输出目录存在
        output_dir = os.path.dirname(shp_file)
        if output_dir and not os.path.exists(output_dir):
            os.makedirs(output_dir)
        
        # 保存为Shapefile
        print(f'正在转换为Shapefile: {shp_file}')
        gdf.to_file(shp_file, encoding='utf-8')
        
        print('转换完成!')
        return True
        
    except Exception as e:
        print(f'转换过程中发生错误: {e}')
        return False
 def read_shp_info(shp_file):
    '''
    读取Shapefile文件并打印各种信息
    
    参数:
    shp_file: Shapefile文件路径
    '''
    try:
        # 读取Shapefile
        print(f'\n正在读取Shapefile文件: {shp_file}')
        gdf = gpd.read_file(shp_file)
        
        # 1. 基本信息
        print('\n' + '='*50)
        print('Shapefile基本信息')
        print('='*50)
        print(f'文件路径: {shp_file}')
        print(f'要素数量: {len(gdf)}')
        print(f'几何类型: {gdf.geometry.type.unique()}')
        print(f'坐标参考系(CRS): {gdf.crs}')
        
        # 2. 字段信息
        print('\n' + '='*50)
        print('字段信息')
        print('='*50)
        print(f'字段数量: {len(gdf.columns)}')
        print('字段详情:')
        for i, col in enumerate(gdf.columns, 1):
            dtype = gdf[col].dtype
            print(f'  {i}. {col} ({dtype})')
        
        # 3. 属性表预览
        print('\n' + '='*50)
        print('属性表前5行')
        print('='*50)
        print(gdf.head())
        
        # 4. 空间范围
        print('\n' + '='*50)
        print('空间范围')
        print('='*50)
        bounds = gdf.total_bounds
        print(f'最小X: {bounds[0]:.6f}')
        print(f'最小Y: {bounds[1]:.6f}')
        print(f'最大X: {bounds[2]:.6f}')
        print(f'最大Y: {bounds[3]:.6f}')
        
        # 5. 几何信息统计
        print('\n' + '='*50)
        print('几何信息统计')
        print('='*50)
        print(f'总面积: {gdf.area.sum():.6f} 平方单位')
        print(f'总长度: {gdf.length.sum():.6f} 单位')
        
        # 6. 各几何类型的数量统计
        print('\n' + '='*50)
        print('几何类型统计')
        print('='*50)
        geometry_counts = gdf.geometry.type.value_counts()
        for geom_type, count in geometry_counts.items():
            print(f'{geom_type}: {count} 个')
        
        # 7. 空间参考系统详细信息
        print('\n' + '='*50)
        print('坐标参考系详细信息')
        print('='*50)
        if gdf.crs is not None:
            crs_info = gdf.crs.to_dict()
            for key, value in crs_info.items():
                print(f'{key}: {value}')
        else:
            print('未定义坐标参考系')
            
        # 8. 内存使用情况
        print('\n' + '='*50)
        print('内存使用信息')
        print('='*50)
        memory_usage = gdf.memory_usage(deep=True).sum()
        print(f'总内存使用: {memory_usage / 1024:.2f} KB')
        
        return gdf
        
    except Exception as e:
        print(f'读取Shapefile时发生错误: {e}')
        return None
geojson_file = r'D:\DownLoad\chrome\黔东南苗族侗族自治州_县.geojson'  # 替换为您的GeoJSON文件路径
shp_file = '黔东南苗族侗族自治州_县.shp'

# 执行转换
print('\n开始GeoJSON到Shapefile的转换...')
success = geojson_to_shp(geojson_file, shp_file)

if success:
    # 读取并显示Shapefile信息
    gdf = read_shp_info(shp_file)
    
    # 可选: 显示更多详细信息
    if gdf is not None:
        print('\n' + '='*50)
        print('前3个要素的详细信息')
        print('='*50)
        for i, (idx, row) in enumerate(gdf.head(3).iterrows()):
            print(f'\n要素 {i+1}:')
            for col in gdf.columns:
                if col != 'geometry':
                    print(f'  {col}: {row[col]}')
            print(f'  几何类型: {row.geometry.geom_type}')
            print(f'  面积: {row.geometry.area:.2f}')
            print(f'  边界: {row.geometry.bounds}')

print('\n程序执行完成!')
```

## 切分shp，切分县

### 切分2块

#### 代码

```python
import geopandas as gpd
import pandas as pd
import numpy as np
from shapely.geometry import Polygon, MultiPolygon, LineString
from shapely.ops import split
import os
import math

def split_polygon_into_two(polygon, split_direction='longest'):
    '''
    将多边形切分为两部分
    '''
    try:
        if polygon.is_empty:
            return None, None
            
        # 获取多边形的边界框
        minx, miny, maxx, maxy = polygon.bounds
        
        if split_direction == 'longest':
            # 按最长边方向切分
            width = maxx - minx
            height = maxy - miny
            if width > height:
                split_direction = 'vertical'
            else:
                split_direction = 'horizontal'
        
        if split_direction == 'vertical':
            # 垂直切分（东西方向）
            mid_x = (minx + maxx) / 2
            split_line = LineString([(mid_x, miny - 1), (mid_x, maxy + 1)])
        else:
            # 水平切分（南北方向）
            mid_y = (miny + maxy) / 2
            split_line = LineString([(minx - 1, mid_y), (maxx + 1, mid_y)])
        
        # 执行切分
        split_parts = split(polygon, split_line)
        
        # 过滤有效的多边形
        valid_parts = [part for part in split_parts.geoms 
                      if isinstance(part, (Polygon, MultiPolygon)) and not part.is_empty]
        
        if len(valid_parts) >= 2:
            return valid_parts[0], valid_parts[1]
        else:
            # 如果切分不成功，尝试对角线切分
            return split_by_diagonal(polygon)
            
    except Exception as e:
        print(f'切分多边形时出错: {e}')
        return split_by_diagonal(polygon)

def split_by_diagonal(polygon):
    '''
    通过对角线切分的备选方法
    '''
    try:
        minx, miny, maxx, maxy = polygon.bounds
        # 从左上到右下
        split_line = LineString([(minx, maxy), (maxx, miny)])
        split_parts = split(polygon, split_line)
        
        valid_parts = [part for part in split_parts.geoms 
                      if isinstance(part, (Polygon, MultiPolygon)) and not part.is_empty]
        
        if len(valid_parts) >= 2:
            return valid_parts[0], valid_parts[1]
        else:
            # 从右上到左下
            split_line = LineString([(maxx, maxy), (minx, miny)])
            split_parts = split(polygon, split_line)
            valid_parts = [part for part in split_parts.geoms 
                          if isinstance(part, (Polygon, MultiPolygon)) and not part.is_empty]
            
            if len(valid_parts) >= 2:
                return valid_parts[0], valid_parts[1]
            else:
                print('所有切分方法都失败，返回原始多边形')
                return polygon, polygon
    except Exception as e:
        print(f'对角线切分也失败: {e}')
        return polygon, polygon

def auto_detect_town_field(gdf):
    '''
    自动检测乡镇名字段
    '''
    # 常见的中文乡镇字段名
    town_keywords = ['镇', '乡', '街道', 'town', 'TOWN', 'name', 'NAME', '名称', '地名']
    
    for field in gdf.columns:
        field_lower = str(field).lower()
        # 检查字段名是否包含乡镇相关关键词
        for keyword in town_keywords:
            if keyword.lower() in field_lower:
                return field
        
        # 检查字段内容是否包含乡镇特征
        sample_values = gdf[field].dropna().head(10)
        if len(sample_values) > 0:
            sample_str = ' '.join(str(x) for x in sample_values)
            if any(keyword in sample_str for keyword in ['镇', '乡', '街道']):
                return field
    
    # 如果没有找到，返回第一个非几何字段
    non_geom_fields = [col for col in gdf.columns if col != gdf.geometry.name]
    return non_geom_fields[0] if non_geom_fields else gdf.columns[0]

def auto_detect_county_field(gdf):
    '''
    自动检测县名字段
    '''
    # 常见的中文县字段名
    county_keywords = ['县', '区', '市', 'county', 'COUNTY', 'city', 'CITY']
    
    for field in gdf.columns:
        field_lower = str(field).lower()
        for keyword in county_keywords:
            if keyword.lower() in field_lower:
                return field
        
        # 检查字段内容是否包含县区特征
        sample_values = gdf[field].dropna().head(10)
        if len(sample_values) > 0:
            sample_str = ' '.join(str(x) for x in sample_values)
            if any(keyword in sample_str for keyword in ['县', '区', '市']):
                return field
    
    # 如果没有找到，尝试用乡镇字段名
    town_field = auto_detect_town_field(gdf)
    if town_field != gdf.columns[0]:
        return gdf.columns[0]
    else:
        return '未知县'

def clean_filename(name):
    '''
    清理文件名，移除非法字符
    '''
    import re
    # 移除Windows文件名中的非法字符
    illegal_chars = r'[<>:'/\\|?*]'
    cleaned = re.sub(illegal_chars, '_', str(name))
    # 移除开头和结尾的空格和点号
    cleaned = cleaned.strip().strip('.')
    # 限制文件名长度
    if len(cleaned) > 100:
        cleaned = cleaned[:100]
    return cleaned

def save_single_shapefile(gdf, output_path, file_name):
    '''
    保存单个Shapefile文件
    '''
    try:
        # 确保输出目录存在
        output_dir = os.path.dirname(output_path)
        if not os.path.exists(output_dir):
            os.makedirs(output_dir)
        
        # 完整的文件路径
        full_path = os.path.join(output_path, f'{file_name}.shp')
        
        # 保存为Shapefile
        gdf.to_file(full_path, encoding='utf-8')
        
        print(f'  已保存: {file_name}.shp')
        return True
        
    except Exception as e:
        print(f'  保存文件 {file_name}.shp 时出错: {e}')
        return False

def split_towns_to_individual_files(shp_file, output_dir):
    '''
    自动读取县级shp文件，将每个乡镇切分为两部分，并保存为单独的shp文件
    
    参数:
    shp_file: 输入的县级Shapefile文件路径
    output_dir: 输出目录
    '''
    
    # 确保输出目录存在
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)
    
    try:
        # 读取Shapefile
        print(f'正在读取文件: {shp_file}')
        gdf = gpd.read_file(shp_file)
        
        # 自动检测字段
        town_field = auto_detect_town_field(gdf)
        county_field = auto_detect_county_field(gdf)
        
        print(f'检测到县字段: {county_field}')
        print(f'检测到乡镇字段: {town_field}')
        
        # 显示字段信息
        print(f'\n所有字段: {list(gdf.columns)}')
        print(f'几何类型: {gdf.geometry.type.unique()}')
        print(f'要素数量: {len(gdf)}')
        
        # 显示乡镇列表
        towns = gdf[town_field].unique()
        print(f'\n发现 {len(towns)} 个乡镇:')
        for i, town in enumerate(towns, 1):
            print(f'  {i}. {town}')
        
        # 获取县名
        if county_field in gdf.columns and len(gdf[county_field].unique()) == 1:
            county_name = gdf[county_field].iloc[0]
        else:
            # 从文件名提取县名或使用默认值
            county_name = os.path.basename(shp_file).replace('.shp', '')
            print(f'使用文件名作为县名: {county_name}')
        
        # 清理县名用于文件名
        county_name_clean = clean_filename(county_name)
        
        # 创建县目录
        county_dir = os.path.join(output_dir, county_name_clean)
        if not os.path.exists(county_dir):
            os.makedirs(county_dir)
        
        print(f'\n开始切分并保存乡镇文件...')
        print('='*60)
        
        success_count = 0
        fail_count = 0
        total_files_created = 0
        
        for idx, row in gdf.iterrows():
            town_name = row[town_field]
            geometry = row.geometry
            
            print(f'\n处理乡镇: {town_name}')
            
            # 清理乡镇名用于文件名
            town_name_clean = clean_filename(town_name)
            
            # 处理MultiPolygon
            if isinstance(geometry, MultiPolygon):
                polygons = list(geometry.geoms)
            else:
                polygons = [geometry]
            
            town_parts = []
            
            for poly_idx, polygon in enumerate(polygons):
                # 切分多边形
                part1, part2 = split_polygon_into_two(polygon)
                
                if part1 is not None and part2 is not None and not part1.equals(part2):
                    town_parts.extend([part1, part2])
                    print(f'  ✓ 成功切分第{poly_idx+1}个多边形')
                else:
                    # 如果切分失败，使用边界框切分
                    print(f'  ⚠ 第{poly_idx+1}个多边形切分不理想，使用边界框切分')
                    part1, part2 = split_by_bounds(polygon)
                    if part1 is not None and part2 is not None and not part1.equals(part2):
                        town_parts.extend([part1, part2])
                    else:
                        print(f'  ✗ 第{poly_idx+1}个多边形切分完全失败，保留原状')
                        town_parts.append(polygon)
            
            # 为每个部分创建单独的shp文件
            for i, part in enumerate(town_parts[:2], 1):  # 只取前两个部分
                # 创建新的GeoDataFrame
                new_row = row.copy()
                new_row.geometry = part
                # 添加切分信息
                new_row['SPLIT_ID'] = f'{county_name}-{town_name}-{i}'
                new_row['ORIGINAL_TOWN'] = town_name
                new_row['SPLIT_PART'] = i
                new_row['COUNTY_NAME'] = county_name
                
                single_gdf = gpd.GeoDataFrame([new_row], crs=gdf.crs)
                
                # 生成文件名
                file_name = f'{county_name_clean}-{town_name_clean}-{i}'
                
                # 保存为单独的shp文件
                if save_single_shapefile(single_gdf, county_dir, file_name):
                    total_files_created += 1
                    print(f'  ✓ 保存: {file_name}.shp')
                else:
                    print(f'  ✗ 保存失败: {file_name}.shp')
            
            if len(town_parts) >= 2:
                success_count += 1
            else:
                fail_count += 1
        
        print(f'\n' + '='*60)
        print(f'处理完成!')
        print('='*60)
        print(f'原始乡镇数量: {len(gdf)}')
        print(f'成功切分: {success_count} 个乡镇')
        print(f'切分失败: {fail_count} 个乡镇')
        print(f'创建的shp文件总数: {total_files_created}')
        print(f'输出目录: {county_dir}')
        
        # 显示生成的文件列表
        print(f'\n生成的文件列表:')
        shp_files = [f for f in os.listdir(county_dir) if f.endswith('.shp')]
        for i, file in enumerate(shp_files[:20], 1):  # 只显示前20个文件
            print(f'  {i}. {file}')
        
        if len(shp_files) > 20:
            print(f'  ... 还有 {len(shp_files) - 20} 个文件')
        
        # 保存处理日志
        save_processing_log(county_dir, county_name, gdf, success_count, fail_count, total_files_created)
        
        return total_files_created
        
    except Exception as e:
        print(f'处理过程中发生错误: {e}')
        import traceback
        traceback.print_exc()
        return 0

def split_by_bounds(polygon):
    '''
    使用边界框进行切分
    '''
    try:
        minx, miny, maxx, maxy = polygon.bounds
        center_x, center_y = (minx + maxx) / 2, (miny + maxy) / 2
        
        # 创建四个象限的矩形
        rect1 = Polygon([(minx, miny), (center_x, miny), (center_x, center_y), (minx, center_y), (minx, miny)])
        rect2 = Polygon([(center_x, miny), (maxx, miny), (maxx, center_y), (center_x, center_y), (center_x, miny)])
        rect3 = Polygon([(minx, center_y), (center_x, center_y), (center_x, maxy), (minx, maxy), (minx, center_y)])
        rect4 = Polygon([(center_x, center_y), (maxx, center_y), (maxx, maxy), (center_x, maxy), (center_x, center_y)])
        
        # 与原始多边形求交
        parts = []
        for rect in [rect1, rect2, rect3, rect4]:
            intersection = polygon.intersection(rect)
            if not intersection.is_empty and intersection.area > 0:
                if isinstance(intersection, MultiPolygon):
                    parts.extend(list(intersection.geoms))
                else:
                    parts.append(intersection)
        
        # 按面积排序，取前两个最大的部分
        parts.sort(key=lambda x: x.area, reverse=True)
        if len(parts) >= 2:
            return parts[0], parts[1]
        elif len(parts) == 1:
            return parts[0], parts[0]
        else:
            return polygon, polygon
            
    except Exception as e:
        print(f'边界框切分失败: {e}')
        return polygon, polygon

def save_processing_log(output_dir, county_name, original_gdf, success_count, fail_count, total_files):
    '''
    保存处理日志
    '''
    try:
        log_file = os.path.join(output_dir, f'处理日志.txt')
        
        with open(log_file, 'w', encoding='utf-8') as f:
            f.write(f'乡镇切分处理日志\n')
            f.write(f'=' * 50 + '\n')
            f.write(f'处理时间: {pd.Timestamp.now().strftime('%Y-%m-%d %H:%M:%S')}\n')
            f.write(f'县名称: {county_name}\n')
            f.write(f'原始乡镇数量: {len(original_gdf)}\n')
            f.write(f'成功切分: {success_count} 个乡镇\n')
            f.write(f'切分失败: {fail_count} 个乡镇\n')
            f.write(f'生成的shp文件总数: {total_files}\n')
            f.write(f'\n原始乡镇列表:\n')
            
            town_field = auto_detect_town_field(original_gdf)
            for town in original_gdf[town_field].unique():
                f.write(f'  - {town}\n')
        
        print(f'处理日志已保存: {log_file}')
        
    except Exception as e:
        print(f'保存处理日志时出错: {e}')

# 使用示例
if __name__ == '__main__':
    # 输入文件路径 - 替换为您的县级Shapefile路径
    input_shp = '黔东南苗族侗族自治州_县.shp'  # 您的县级shp文件
    output_directory = input_shp.split('.')[0]
    
    print('开始自动切分乡镇并保存为单独文件...')
    print('='*60)
    
    # 执行切分
    files_created = split_towns_to_individual_files(
        shp_file=input_shp,
        output_dir=output_directory
    )
    
    if files_created > 0:
        print(f'\n' + '='*60)
        print('处理完成！')
        print('='*60)
        print(f'总共生成了 {files_created} 个shp文件')
        print(f'文件命名格式: 县名-镇名-编号.shp')
        print(f'示例: 某县-某镇-1.shp, 某县-某镇-2.shp')
    else:
        print('\n处理失败，请检查输入文件和错误信息。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://wzh922.github.io/blog/post/shi-yong-dai-ma.html">
<meta property="og:image" content="https://avatars.githubusercontent.com/u/210956220?s=400&u=c0d549ac9c109d6ad35fde23e0aff5b3213fc57e&v=4">
<title>实用代码</title>
<link href="//unpkg.com/@wooorm/starry-night@2.1.1/style/both.css" rel="stylesheet" />


</head>
<style>
body{box-sizing: border-box;min-width: 200px;max-width: 900px;margin: 20px auto;padding: 45px;font-size: 16px;font-family: sans-serif;line-height: 1.25;}
#header{display:flex;padding-bottom:8px;border-bottom: 1px solid var(--borderColor-muted, var(--color-border-muted));margin-bottom: 16px;}
#footer {margin-top:64px; text-align: center;font-size: small;}

</style>

<style>
.postTitle{margin: auto 0;font-size:40px;font-weight:bold;}
.title-right{display:flex;margin:auto 0 0 auto;}
.title-right .circle{padding: 14px 16px;margin-right:8px;}
#postBody{border-bottom: 1px solid var(--color-border-default);padding-bottom:36px;}
#postBody hr{height:2px;}
#cmButton{height:48px;margin-top:48px;}
#comments{margin-top:64px;}
.g-emoji{font-size:24px;}
@media (max-width: 600px) {
    body {padding: 8px;}
    .postTitle{font-size:24px;}
}
.copy-feedback {
    display: none;
    position: absolute;
    top: 10px;
    right: 50px;
    color: var(--color-fg-on-emphasis);
    background-color: var(--color-fg-muted);
    border-radius: 3px;
    padding: 5px 8px;
    font-size: 12px;
}
</style>




<body>
    <div id="header">
<h1 class="postTitle">实用代码</h1>
<div class="title-right">
    <a href="https://wzh922.github.io/blog" id="buttonHome" class="btn btn-invisible circle" title="首页">
        <svg class="octicon" width="16" height="16">
            <path id="pathHome" fill-rule="evenodd"></path>
        </svg>
    </a>
    
    <a href="https://github.com/wzh922/blog/issues/33" target="_blank" class="btn btn-invisible circle" title="Issue">
        <svg class="octicon" width="16" height="16">
            <path id="pathIssue" fill-rule="evenodd"></path>
        </svg>
    </a>
    

    <a class="btn btn-invisible circle" onclick="modeSwitch();" title="切换主题">
        <svg class="octicon" width="16" height="16" >
            <path id="themeSwitch" fill-rule="evenodd"></path>
        </svg>
    </a>

</div>
</div>
    <div id="content">
<div class="markdown-body" id="postBody"><h1>实用代码</h1>
<h2>geojson 转 shp</h2>
<div class="highlight highlight-source-python"><pre class="notranslate"><span class="pl-k">import</span> <span class="pl-s1">geopandas</span> <span class="pl-k">as</span> <span class="pl-s1">gpd</span>
<span class="pl-k">import</span> <span class="pl-s1">pandas</span> <span class="pl-k">as</span> <span class="pl-s1">pd</span>
<span class="pl-k">import</span> <span class="pl-s1">os</span>
<span class="pl-k">from</span> <span class="pl-s1">shapely</span>.<span class="pl-s1">geometry</span> <span class="pl-k">import</span> <span class="pl-s1">shape</span>
<span class="pl-k">import</span> <span class="pl-s1">fiona</span>

<span class="pl-k">def</span> <span class="pl-en">geojson_to_shp</span>(<span class="pl-s1">geojson_file</span>, <span class="pl-s1">shp_file</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    将GeoJSON文件转换为Shapefile文件</span>
<span class="pl-s">    </span>
<span class="pl-s">    参数:</span>
<span class="pl-s">    geojson_file: 输入的GeoJSON文件路径</span>
<span class="pl-s">    shp_file: 输出的Shapefile文件路径</span>
<span class="pl-s">    """</span>
    <span class="pl-k">try</span>:
        <span class="pl-c"># 读取GeoJSON文件</span>
        <span class="pl-en">print</span>(<span class="pl-s">f"正在读取GeoJSON文件: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">geojson_file</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-s1">gdf</span> <span class="pl-c1">=</span> <span class="pl-s1">gpd</span>.<span class="pl-c1">read_file</span>(<span class="pl-s1">geojson_file</span>)
        
        <span class="pl-c"># 确保输出目录存在</span>
        <span class="pl-s1">output_dir</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">dirname</span>(<span class="pl-s1">shp_file</span>)
        <span class="pl-k">if</span> <span class="pl-s1">output_dir</span> <span class="pl-c1">and</span> <span class="pl-c1">not</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">exists</span>(<span class="pl-s1">output_dir</span>):
            <span class="pl-s1">os</span>.<span class="pl-c1">makedirs</span>(<span class="pl-s1">output_dir</span>)
        
        <span class="pl-c"># 保存为Shapefile</span>
        <span class="pl-en">print</span>(<span class="pl-s">f"正在转换为Shapefile: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">shp_file</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-s1">gdf</span>.<span class="pl-c1">to_file</span>(<span class="pl-s1">shp_file</span>, <span class="pl-s1">encoding</span><span class="pl-c1">=</span><span class="pl-s">'utf-8'</span>)
        
        <span class="pl-en">print</span>(<span class="pl-s">"转换完成!"</span>)
        <span class="pl-k">return</span> <span class="pl-c1">True</span>
        
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"转换过程中发生错误: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">return</span> <span class="pl-c1">False</span>
 <span class="pl-k">def</span> <span class="pl-en">read_shp_info</span>(<span class="pl-s1">shp_file</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    读取Shapefile文件并打印各种信息</span>
<span class="pl-s">    </span>
<span class="pl-s">    参数:</span>
<span class="pl-s">    shp_file: Shapefile文件路径</span>
<span class="pl-s">    """</span>
    <span class="pl-k">try</span>:
        <span class="pl-c"># 读取Shapefile</span>
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>正在读取Shapefile文件: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">shp_file</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-s1">gdf</span> <span class="pl-c1">=</span> <span class="pl-s1">gpd</span>.<span class="pl-c1">read_file</span>(<span class="pl-s1">shp_file</span>)
        
        <span class="pl-c"># 1. 基本信息</span>
        <span class="pl-en">print</span>(<span class="pl-s">"<span class="pl-cce">\n</span>"</span> <span class="pl-c1">+</span> <span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"Shapefile基本信息"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"文件路径: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">shp_file</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"要素数量: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">len</span>(<span class="pl-s1">gdf</span>)<span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"几何类型: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">gdf</span>.<span class="pl-c1">geometry</span>.<span class="pl-c1">type</span>.<span class="pl-c1">unique</span>()<span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"坐标参考系(CRS): <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">gdf</span>.<span class="pl-c1">crs</span><span class="pl-kos">}</span></span>"</span>)
        
        <span class="pl-c"># 2. 字段信息</span>
        <span class="pl-en">print</span>(<span class="pl-s">"<span class="pl-cce">\n</span>"</span> <span class="pl-c1">+</span> <span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"字段信息"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"字段数量: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">len</span>(<span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span>)<span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"字段详情:"</span>)
        <span class="pl-k">for</span> <span class="pl-s1">i</span>, <span class="pl-s1">col</span> <span class="pl-c1">in</span> <span class="pl-en">enumerate</span>(<span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span>, <span class="pl-c1">1</span>):
            <span class="pl-s1">dtype</span> <span class="pl-c1">=</span> <span class="pl-s1">gdf</span>[<span class="pl-s1">col</span>].<span class="pl-c1">dtype</span>
            <span class="pl-en">print</span>(<span class="pl-s">f"  <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">i</span><span class="pl-kos">}</span></span>. <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">col</span><span class="pl-kos">}</span></span> (<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">dtype</span><span class="pl-kos">}</span></span>)"</span>)
        
        <span class="pl-c"># 3. 属性表预览</span>
        <span class="pl-en">print</span>(<span class="pl-s">"<span class="pl-cce">\n</span>"</span> <span class="pl-c1">+</span> <span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"属性表前5行"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-en">print</span>(<span class="pl-s1">gdf</span>.<span class="pl-c1">head</span>())
        
        <span class="pl-c"># 4. 空间范围</span>
        <span class="pl-en">print</span>(<span class="pl-s">"<span class="pl-cce">\n</span>"</span> <span class="pl-c1">+</span> <span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"空间范围"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-s1">bounds</span> <span class="pl-c1">=</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">total_bounds</span>
        <span class="pl-en">print</span>(<span class="pl-s">f"最小X: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">bounds</span>[<span class="pl-c1">0</span>]:.6f<span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"最小Y: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">bounds</span>[<span class="pl-c1">1</span>]:.6f<span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"最大X: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">bounds</span>[<span class="pl-c1">2</span>]:.6f<span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"最大Y: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">bounds</span>[<span class="pl-c1">3</span>]:.6f<span class="pl-kos">}</span></span>"</span>)
        
        <span class="pl-c"># 5. 几何信息统计</span>
        <span class="pl-en">print</span>(<span class="pl-s">"<span class="pl-cce">\n</span>"</span> <span class="pl-c1">+</span> <span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"几何信息统计"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"总面积: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">gdf</span>.<span class="pl-c1">area</span>.<span class="pl-c1">sum</span>():.6f<span class="pl-kos">}</span></span> 平方单位"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"总长度: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">gdf</span>.<span class="pl-c1">length</span>.<span class="pl-c1">sum</span>():.6f<span class="pl-kos">}</span></span> 单位"</span>)
        
        <span class="pl-c"># 6. 各几何类型的数量统计</span>
        <span class="pl-en">print</span>(<span class="pl-s">"<span class="pl-cce">\n</span>"</span> <span class="pl-c1">+</span> <span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"几何类型统计"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-s1">geometry_counts</span> <span class="pl-c1">=</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">geometry</span>.<span class="pl-c1">type</span>.<span class="pl-c1">value_counts</span>()
        <span class="pl-k">for</span> <span class="pl-s1">geom_type</span>, <span class="pl-s1">count</span> <span class="pl-c1">in</span> <span class="pl-s1">geometry_counts</span>.<span class="pl-c1">items</span>():
            <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">geom_type</span><span class="pl-kos">}</span></span>: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">count</span><span class="pl-kos">}</span></span> 个"</span>)
        
        <span class="pl-c"># 7. 空间参考系统详细信息</span>
        <span class="pl-en">print</span>(<span class="pl-s">"<span class="pl-cce">\n</span>"</span> <span class="pl-c1">+</span> <span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"坐标参考系详细信息"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-k">if</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">crs</span> <span class="pl-c1"><span class="pl-c1">is</span> <span class="pl-c1">not</span></span> <span class="pl-c1">None</span>:
            <span class="pl-s1">crs_info</span> <span class="pl-c1">=</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">crs</span>.<span class="pl-c1">to_dict</span>()
            <span class="pl-k">for</span> <span class="pl-s1">key</span>, <span class="pl-s1">value</span> <span class="pl-c1">in</span> <span class="pl-s1">crs_info</span>.<span class="pl-c1">items</span>():
                <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">key</span><span class="pl-kos">}</span></span>: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">value</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">else</span>:
            <span class="pl-en">print</span>(<span class="pl-s">"未定义坐标参考系"</span>)
            
        <span class="pl-c"># 8. 内存使用情况</span>
        <span class="pl-en">print</span>(<span class="pl-s">"<span class="pl-cce">\n</span>"</span> <span class="pl-c1">+</span> <span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"内存使用信息"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-s1">memory_usage</span> <span class="pl-c1">=</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">memory_usage</span>(<span class="pl-s1">deep</span><span class="pl-c1">=</span><span class="pl-c1">True</span>).<span class="pl-c1">sum</span>()
        <span class="pl-en">print</span>(<span class="pl-s">f"总内存使用: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">memory_usage</span> <span class="pl-c1">/</span> <span class="pl-c1">1024</span>:.2f<span class="pl-kos">}</span></span> KB"</span>)
        
        <span class="pl-k">return</span> <span class="pl-s1">gdf</span>
        
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"读取Shapefile时发生错误: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">return</span> <span class="pl-c1">None</span>
<span class="pl-s1">geojson_file</span> <span class="pl-c1">=</span> <span class="pl-s">r"D:\DownLoad\chrome\黔东南苗族侗族自治州_县.geojson"</span>  <span class="pl-c"># 替换为您的GeoJSON文件路径</span>
<span class="pl-s1">shp_file</span> <span class="pl-c1">=</span> <span class="pl-s">"黔东南苗族侗族自治州_县.shp"</span>

<span class="pl-c"># 执行转换</span>
<span class="pl-en">print</span>(<span class="pl-s">"<span class="pl-cce">\n</span>开始GeoJSON到Shapefile的转换..."</span>)
<span class="pl-s1">success</span> <span class="pl-c1">=</span> <span class="pl-en">geojson_to_shp</span>(<span class="pl-s1">geojson_file</span>, <span class="pl-s1">shp_file</span>)

<span class="pl-k">if</span> <span class="pl-s1">success</span>:
    <span class="pl-c"># 读取并显示Shapefile信息</span>
    <span class="pl-s1">gdf</span> <span class="pl-c1">=</span> <span class="pl-en">read_shp_info</span>(<span class="pl-s1">shp_file</span>)
    
    <span class="pl-c"># 可选: 显示更多详细信息</span>
    <span class="pl-k">if</span> <span class="pl-s1">gdf</span> <span class="pl-c1"><span class="pl-c1">is</span> <span class="pl-c1">not</span></span> <span class="pl-c1">None</span>:
        <span class="pl-en">print</span>(<span class="pl-s">"<span class="pl-cce">\n</span>"</span> <span class="pl-c1">+</span> <span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"前3个要素的详细信息"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">50</span>)
        <span class="pl-k">for</span> <span class="pl-s1">i</span>, (<span class="pl-s1">idx</span>, <span class="pl-s1">row</span>) <span class="pl-c1">in</span> <span class="pl-en">enumerate</span>(<span class="pl-s1">gdf</span>.<span class="pl-c1">head</span>(<span class="pl-c1">3</span>).<span class="pl-c1">iterrows</span>()):
            <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>要素 <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">i</span><span class="pl-c1">+</span><span class="pl-c1">1</span><span class="pl-kos">}</span></span>:"</span>)
            <span class="pl-k">for</span> <span class="pl-s1">col</span> <span class="pl-c1">in</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span>:
                <span class="pl-k">if</span> <span class="pl-s1">col</span> <span class="pl-c1">!=</span> <span class="pl-s">'geometry'</span>:
                    <span class="pl-en">print</span>(<span class="pl-s">f"  <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">col</span><span class="pl-kos">}</span></span>: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">row</span>[<span class="pl-s1">col</span>]<span class="pl-kos">}</span></span>"</span>)
            <span class="pl-en">print</span>(<span class="pl-s">f"  几何类型: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">row</span>.<span class="pl-c1">geometry</span>.<span class="pl-c1">geom_type</span><span class="pl-kos">}</span></span>"</span>)
            <span class="pl-en">print</span>(<span class="pl-s">f"  面积: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">row</span>.<span class="pl-c1">geometry</span>.<span class="pl-c1">area</span>:.2f<span class="pl-kos">}</span></span>"</span>)
            <span class="pl-en">print</span>(<span class="pl-s">f"  边界: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">row</span>.<span class="pl-c1">geometry</span>.<span class="pl-c1">bounds</span><span class="pl-kos">}</span></span>"</span>)

<span class="pl-en">print</span>(<span class="pl-s">"<span class="pl-cce">\n</span>程序执行完成!"</span>)</pre></div>
<h2>切分shp，切分县</h2>
<h3>切分2块</h3>
<h4>代码</h4>
<div class="highlight highlight-source-python"><pre class="notranslate"><span class="pl-k">import</span> <span class="pl-s1">geopandas</span> <span class="pl-k">as</span> <span class="pl-s1">gpd</span>
<span class="pl-k">import</span> <span class="pl-s1">pandas</span> <span class="pl-k">as</span> <span class="pl-s1">pd</span>
<span class="pl-k">import</span> <span class="pl-s1">numpy</span> <span class="pl-k">as</span> <span class="pl-s1">np</span>
<span class="pl-k">from</span> <span class="pl-s1">shapely</span>.<span class="pl-s1">geometry</span> <span class="pl-k">import</span> <span class="pl-v">Polygon</span>, <span class="pl-v">MultiPolygon</span>, <span class="pl-v">LineString</span>
<span class="pl-k">from</span> <span class="pl-s1">shapely</span>.<span class="pl-s1">ops</span> <span class="pl-k">import</span> <span class="pl-s1">split</span>
<span class="pl-k">import</span> <span class="pl-s1">os</span>
<span class="pl-k">import</span> <span class="pl-s1">math</span>

<span class="pl-k">def</span> <span class="pl-en">split_polygon_into_two</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">split_direction</span><span class="pl-c1">=</span><span class="pl-s">'longest'</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    将多边形切分为两部分</span>
<span class="pl-s">    """</span>
    <span class="pl-k">try</span>:
        <span class="pl-k">if</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">is_empty</span>:
            <span class="pl-k">return</span> <span class="pl-c1">None</span>, <span class="pl-c1">None</span>
            
        <span class="pl-c"># 获取多边形的边界框</span>
        <span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>, <span class="pl-s1">maxx</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">=</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">bounds</span>
        
        <span class="pl-k">if</span> <span class="pl-s1">split_direction</span> <span class="pl-c1">==</span> <span class="pl-s">'longest'</span>:
            <span class="pl-c"># 按最长边方向切分</span>
            <span class="pl-s1">width</span> <span class="pl-c1">=</span> <span class="pl-s1">maxx</span> <span class="pl-c1">-</span> <span class="pl-s1">minx</span>
            <span class="pl-s1">height</span> <span class="pl-c1">=</span> <span class="pl-s1">maxy</span> <span class="pl-c1">-</span> <span class="pl-s1">miny</span>
            <span class="pl-k">if</span> <span class="pl-s1">width</span> <span class="pl-c1">&gt;</span> <span class="pl-s1">height</span>:
                <span class="pl-s1">split_direction</span> <span class="pl-c1">=</span> <span class="pl-s">'vertical'</span>
            <span class="pl-k">else</span>:
                <span class="pl-s1">split_direction</span> <span class="pl-c1">=</span> <span class="pl-s">'horizontal'</span>
        
        <span class="pl-k">if</span> <span class="pl-s1">split_direction</span> <span class="pl-c1">==</span> <span class="pl-s">'vertical'</span>:
            <span class="pl-c"># 垂直切分（东西方向）</span>
            <span class="pl-s1">mid_x</span> <span class="pl-c1">=</span> (<span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-s1">maxx</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
            <span class="pl-s1">split_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">mid_x</span>, <span class="pl-s1">miny</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>)])
        <span class="pl-k">else</span>:
            <span class="pl-c"># 水平切分（南北方向）</span>
            <span class="pl-s1">mid_y</span> <span class="pl-c1">=</span> (<span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-s1">maxy</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
            <span class="pl-s1">split_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">minx</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>, <span class="pl-s1">mid_y</span>), (<span class="pl-s1">maxx</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>, <span class="pl-s1">mid_y</span>)])
        
        <span class="pl-c"># 执行切分</span>
        <span class="pl-s1">split_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">split_line</span>)
        
        <span class="pl-c"># 过滤有效的多边形</span>
        <span class="pl-s1">valid_parts</span> <span class="pl-c1">=</span> [<span class="pl-s1">part</span> <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">split_parts</span>.<span class="pl-c1">geoms</span> 
                      <span class="pl-k">if</span> <span class="pl-en">isinstance</span>(<span class="pl-s1">part</span>, (<span class="pl-v">Polygon</span>, <span class="pl-v">MultiPolygon</span>)) <span class="pl-c1">and</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>]
        
        <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">valid_parts</span>) <span class="pl-c1">&gt;=</span> <span class="pl-c1">2</span>:
            <span class="pl-k">return</span> <span class="pl-s1">valid_parts</span>[<span class="pl-c1">0</span>], <span class="pl-s1">valid_parts</span>[<span class="pl-c1">1</span>]
        <span class="pl-k">else</span>:
            <span class="pl-c"># 如果切分不成功，尝试对角线切分</span>
            <span class="pl-k">return</span> <span class="pl-en">split_by_diagonal</span>(<span class="pl-s1">polygon</span>)
            
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"切分多边形时出错: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">return</span> <span class="pl-en">split_by_diagonal</span>(<span class="pl-s1">polygon</span>)

<span class="pl-k">def</span> <span class="pl-en">split_by_diagonal</span>(<span class="pl-s1">polygon</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    通过对角线切分的备选方法</span>
<span class="pl-s">    """</span>
    <span class="pl-k">try</span>:
        <span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>, <span class="pl-s1">maxx</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">=</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">bounds</span>
        <span class="pl-c"># 从左上到右下</span>
        <span class="pl-s1">split_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">minx</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">maxx</span>, <span class="pl-s1">miny</span>)])
        <span class="pl-s1">split_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">split_line</span>)
        
        <span class="pl-s1">valid_parts</span> <span class="pl-c1">=</span> [<span class="pl-s1">part</span> <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">split_parts</span>.<span class="pl-c1">geoms</span> 
                      <span class="pl-k">if</span> <span class="pl-en">isinstance</span>(<span class="pl-s1">part</span>, (<span class="pl-v">Polygon</span>, <span class="pl-v">MultiPolygon</span>)) <span class="pl-c1">and</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>]
        
        <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">valid_parts</span>) <span class="pl-c1">&gt;=</span> <span class="pl-c1">2</span>:
            <span class="pl-k">return</span> <span class="pl-s1">valid_parts</span>[<span class="pl-c1">0</span>], <span class="pl-s1">valid_parts</span>[<span class="pl-c1">1</span>]
        <span class="pl-k">else</span>:
            <span class="pl-c"># 从右上到左下</span>
            <span class="pl-s1">split_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">maxx</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>)])
            <span class="pl-s1">split_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">split_line</span>)
            <span class="pl-s1">valid_parts</span> <span class="pl-c1">=</span> [<span class="pl-s1">part</span> <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">split_parts</span>.<span class="pl-c1">geoms</span> 
                          <span class="pl-k">if</span> <span class="pl-en">isinstance</span>(<span class="pl-s1">part</span>, (<span class="pl-v">Polygon</span>, <span class="pl-v">MultiPolygon</span>)) <span class="pl-c1">and</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>]
            
            <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">valid_parts</span>) <span class="pl-c1">&gt;=</span> <span class="pl-c1">2</span>:
                <span class="pl-k">return</span> <span class="pl-s1">valid_parts</span>[<span class="pl-c1">0</span>], <span class="pl-s1">valid_parts</span>[<span class="pl-c1">1</span>]
            <span class="pl-k">else</span>:
                <span class="pl-en">print</span>(<span class="pl-s">"所有切分方法都失败，返回原始多边形"</span>)
                <span class="pl-k">return</span> <span class="pl-s1">polygon</span>, <span class="pl-s1">polygon</span>
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"对角线切分也失败: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">return</span> <span class="pl-s1">polygon</span>, <span class="pl-s1">polygon</span>

<span class="pl-k">def</span> <span class="pl-en">auto_detect_town_field</span>(<span class="pl-s1">gdf</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    自动检测乡镇名字段</span>
<span class="pl-s">    """</span>
    <span class="pl-c"># 常见的中文乡镇字段名</span>
    <span class="pl-s1">town_keywords</span> <span class="pl-c1">=</span> [<span class="pl-s">'镇'</span>, <span class="pl-s">'乡'</span>, <span class="pl-s">'街道'</span>, <span class="pl-s">'town'</span>, <span class="pl-s">'TOWN'</span>, <span class="pl-s">'name'</span>, <span class="pl-s">'NAME'</span>, <span class="pl-s">'名称'</span>, <span class="pl-s">'地名'</span>]
    
    <span class="pl-k">for</span> <span class="pl-s1">field</span> <span class="pl-c1">in</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span>:
        <span class="pl-s1">field_lower</span> <span class="pl-c1">=</span> <span class="pl-en">str</span>(<span class="pl-s1">field</span>).<span class="pl-c1">lower</span>()
        <span class="pl-c"># 检查字段名是否包含乡镇相关关键词</span>
        <span class="pl-k">for</span> <span class="pl-s1">keyword</span> <span class="pl-c1">in</span> <span class="pl-s1">town_keywords</span>:
            <span class="pl-k">if</span> <span class="pl-s1">keyword</span>.<span class="pl-c1">lower</span>() <span class="pl-c1">in</span> <span class="pl-s1">field_lower</span>:
                <span class="pl-k">return</span> <span class="pl-s1">field</span>
        
        <span class="pl-c"># 检查字段内容是否包含乡镇特征</span>
        <span class="pl-s1">sample_values</span> <span class="pl-c1">=</span> <span class="pl-s1">gdf</span>[<span class="pl-s1">field</span>].<span class="pl-c1">dropna</span>().<span class="pl-c1">head</span>(<span class="pl-c1">10</span>)
        <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">sample_values</span>) <span class="pl-c1">&gt;</span> <span class="pl-c1">0</span>:
            <span class="pl-s1">sample_str</span> <span class="pl-c1">=</span> <span class="pl-s">' '</span>.<span class="pl-c1">join</span>(<span class="pl-en">str</span>(<span class="pl-s1">x</span>) <span class="pl-k">for</span> <span class="pl-s1">x</span> <span class="pl-c1">in</span> <span class="pl-s1">sample_values</span>)
            <span class="pl-k">if</span> <span class="pl-en">any</span>(<span class="pl-s1">keyword</span> <span class="pl-c1">in</span> <span class="pl-s1">sample_str</span> <span class="pl-k">for</span> <span class="pl-s1">keyword</span> <span class="pl-c1">in</span> [<span class="pl-s">'镇'</span>, <span class="pl-s">'乡'</span>, <span class="pl-s">'街道'</span>]):
                <span class="pl-k">return</span> <span class="pl-s1">field</span>
    
    <span class="pl-c"># 如果没有找到，返回第一个非几何字段</span>
    <span class="pl-s1">non_geom_fields</span> <span class="pl-c1">=</span> [<span class="pl-s1">col</span> <span class="pl-k">for</span> <span class="pl-s1">col</span> <span class="pl-c1">in</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span> <span class="pl-k">if</span> <span class="pl-s1">col</span> <span class="pl-c1">!=</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">geometry</span>.<span class="pl-c1">name</span>]
    <span class="pl-k">return</span> <span class="pl-s1">non_geom_fields</span>[<span class="pl-c1">0</span>] <span class="pl-k">if</span> <span class="pl-s1">non_geom_fields</span> <span class="pl-k">else</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span>[<span class="pl-c1">0</span>]

<span class="pl-k">def</span> <span class="pl-en">auto_detect_county_field</span>(<span class="pl-s1">gdf</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    自动检测县名字段</span>
<span class="pl-s">    """</span>
    <span class="pl-c"># 常见的中文县字段名</span>
    <span class="pl-s1">county_keywords</span> <span class="pl-c1">=</span> [<span class="pl-s">'县'</span>, <span class="pl-s">'区'</span>, <span class="pl-s">'市'</span>, <span class="pl-s">'county'</span>, <span class="pl-s">'COUNTY'</span>, <span class="pl-s">'city'</span>, <span class="pl-s">'CITY'</span>]
    
    <span class="pl-k">for</span> <span class="pl-s1">field</span> <span class="pl-c1">in</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span>:
        <span class="pl-s1">field_lower</span> <span class="pl-c1">=</span> <span class="pl-en">str</span>(<span class="pl-s1">field</span>).<span class="pl-c1">lower</span>()
        <span class="pl-k">for</span> <span class="pl-s1">keyword</span> <span class="pl-c1">in</span> <span class="pl-s1">county_keywords</span>:
            <span class="pl-k">if</span> <span class="pl-s1">keyword</span>.<span class="pl-c1">lower</span>() <span class="pl-c1">in</span> <span class="pl-s1">field_lower</span>:
                <span class="pl-k">return</span> <span class="pl-s1">field</span>
        
        <span class="pl-c"># 检查字段内容是否包含县区特征</span>
        <span class="pl-s1">sample_values</span> <span class="pl-c1">=</span> <span class="pl-s1">gdf</span>[<span class="pl-s1">field</span>].<span class="pl-c1">dropna</span>().<span class="pl-c1">head</span>(<span class="pl-c1">10</span>)
        <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">sample_values</span>) <span class="pl-c1">&gt;</span> <span class="pl-c1">0</span>:
            <span class="pl-s1">sample_str</span> <span class="pl-c1">=</span> <span class="pl-s">' '</span>.<span class="pl-c1">join</span>(<span class="pl-en">str</span>(<span class="pl-s1">x</span>) <span class="pl-k">for</span> <span class="pl-s1">x</span> <span class="pl-c1">in</span> <span class="pl-s1">sample_values</span>)
            <span class="pl-k">if</span> <span class="pl-en">any</span>(<span class="pl-s1">keyword</span> <span class="pl-c1">in</span> <span class="pl-s1">sample_str</span> <span class="pl-k">for</span> <span class="pl-s1">keyword</span> <span class="pl-c1">in</span> [<span class="pl-s">'县'</span>, <span class="pl-s">'区'</span>, <span class="pl-s">'市'</span>]):
                <span class="pl-k">return</span> <span class="pl-s1">field</span>
    
    <span class="pl-c"># 如果没有找到，尝试用乡镇字段名</span>
    <span class="pl-s1">town_field</span> <span class="pl-c1">=</span> <span class="pl-en">auto_detect_town_field</span>(<span class="pl-s1">gdf</span>)
    <span class="pl-k">if</span> <span class="pl-s1">town_field</span> <span class="pl-c1">!=</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span>[<span class="pl-c1">0</span>]:
        <span class="pl-k">return</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span>[<span class="pl-c1">0</span>]
    <span class="pl-k">else</span>:
        <span class="pl-k">return</span> <span class="pl-s">"未知县"</span>

<span class="pl-k">def</span> <span class="pl-en">clean_filename</span>(<span class="pl-s1">name</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    清理文件名，移除非法字符</span>
<span class="pl-s">    """</span>
    <span class="pl-k">import</span> <span class="pl-s1">re</span>
    <span class="pl-c"># 移除Windows文件名中的非法字符</span>
    <span class="pl-s1">illegal_chars</span> <span class="pl-c1">=</span> <span class="pl-s">r'[&lt;&gt;:"/\\|?*]'</span>
    <span class="pl-s1">cleaned</span> <span class="pl-c1">=</span> <span class="pl-s1">re</span>.<span class="pl-c1">sub</span>(<span class="pl-s1">illegal_chars</span>, <span class="pl-s">'_'</span>, <span class="pl-en">str</span>(<span class="pl-s1">name</span>))
    <span class="pl-c"># 移除开头和结尾的空格和点号</span>
    <span class="pl-s1">cleaned</span> <span class="pl-c1">=</span> <span class="pl-s1">cleaned</span>.<span class="pl-c1">strip</span>().<span class="pl-c1">strip</span>(<span class="pl-s">'.'</span>)
    <span class="pl-c"># 限制文件名长度</span>
    <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">cleaned</span>) <span class="pl-c1">&gt;</span> <span class="pl-c1">100</span>:
        <span class="pl-s1">cleaned</span> <span class="pl-c1">=</span> <span class="pl-s1">cleaned</span>[:<span class="pl-c1">100</span>]
    <span class="pl-k">return</span> <span class="pl-s1">cleaned</span>

<span class="pl-k">def</span> <span class="pl-en">save_single_shapefile</span>(<span class="pl-s1">gdf</span>, <span class="pl-s1">output_path</span>, <span class="pl-s1">file_name</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    保存单个Shapefile文件</span>
<span class="pl-s">    """</span>
    <span class="pl-k">try</span>:
        <span class="pl-c"># 确保输出目录存在</span>
        <span class="pl-s1">output_dir</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">dirname</span>(<span class="pl-s1">output_path</span>)
        <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">exists</span>(<span class="pl-s1">output_dir</span>):
            <span class="pl-s1">os</span>.<span class="pl-c1">makedirs</span>(<span class="pl-s1">output_dir</span>)
        
        <span class="pl-c"># 完整的文件路径</span>
        <span class="pl-s1">full_path</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">join</span>(<span class="pl-s1">output_path</span>, <span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">file_name</span><span class="pl-kos">}</span></span>.shp"</span>)
        
        <span class="pl-c"># 保存为Shapefile</span>
        <span class="pl-s1">gdf</span>.<span class="pl-c1">to_file</span>(<span class="pl-s1">full_path</span>, <span class="pl-s1">encoding</span><span class="pl-c1">=</span><span class="pl-s">'utf-8'</span>)
        
        <span class="pl-en">print</span>(<span class="pl-s">f"  已保存: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">file_name</span><span class="pl-kos">}</span></span>.shp"</span>)
        <span class="pl-k">return</span> <span class="pl-c1">True</span>
        
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"  保存文件 <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">file_name</span><span class="pl-kos">}</span></span>.shp 时出错: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">return</span> <span class="pl-c1">False</span>

<span class="pl-k">def</span> <span class="pl-en">split_towns_to_individual_files</span>(<span class="pl-s1">shp_file</span>, <span class="pl-s1">output_dir</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    自动读取县级shp文件，将每个乡镇切分为两部分，并保存为单独的shp文件</span>
<span class="pl-s">    </span>
<span class="pl-s">    参数:</span>
<span class="pl-s">    shp_file: 输入的县级Shapefile文件路径</span>
<span class="pl-s">    output_dir: 输出目录</span>
<span class="pl-s">    """</span>
    
    <span class="pl-c"># 确保输出目录存在</span>
    <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">exists</span>(<span class="pl-s1">output_dir</span>):
        <span class="pl-s1">os</span>.<span class="pl-c1">makedirs</span>(<span class="pl-s1">output_dir</span>)
    
    <span class="pl-k">try</span>:
        <span class="pl-c"># 读取Shapefile</span>
        <span class="pl-en">print</span>(<span class="pl-s">f"正在读取文件: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">shp_file</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-s1">gdf</span> <span class="pl-c1">=</span> <span class="pl-s1">gpd</span>.<span class="pl-c1">read_file</span>(<span class="pl-s1">shp_file</span>)
        
        <span class="pl-c"># 自动检测字段</span>
        <span class="pl-s1">town_field</span> <span class="pl-c1">=</span> <span class="pl-en">auto_detect_town_field</span>(<span class="pl-s1">gdf</span>)
        <span class="pl-s1">county_field</span> <span class="pl-c1">=</span> <span class="pl-en">auto_detect_county_field</span>(<span class="pl-s1">gdf</span>)
        
        <span class="pl-en">print</span>(<span class="pl-s">f"检测到县字段: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">county_field</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"检测到乡镇字段: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town_field</span><span class="pl-kos">}</span></span>"</span>)
        
        <span class="pl-c"># 显示字段信息</span>
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>所有字段: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">list</span>(<span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span>)<span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"几何类型: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">gdf</span>.<span class="pl-c1">geometry</span>.<span class="pl-c1">type</span>.<span class="pl-c1">unique</span>()<span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"要素数量: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">len</span>(<span class="pl-s1">gdf</span>)<span class="pl-kos">}</span></span>"</span>)
        
        <span class="pl-c"># 显示乡镇列表</span>
        <span class="pl-s1">towns</span> <span class="pl-c1">=</span> <span class="pl-s1">gdf</span>[<span class="pl-s1">town_field</span>].<span class="pl-c1">unique</span>()
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>发现 <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">len</span>(<span class="pl-s1">towns</span>)<span class="pl-kos">}</span></span> 个乡镇:"</span>)
        <span class="pl-k">for</span> <span class="pl-s1">i</span>, <span class="pl-s1">town</span> <span class="pl-c1">in</span> <span class="pl-en">enumerate</span>(<span class="pl-s1">towns</span>, <span class="pl-c1">1</span>):
            <span class="pl-en">print</span>(<span class="pl-s">f"  <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">i</span><span class="pl-kos">}</span></span>. <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town</span><span class="pl-kos">}</span></span>"</span>)
        
        <span class="pl-c"># 获取县名</span>
        <span class="pl-k">if</span> <span class="pl-s1">county_field</span> <span class="pl-c1">in</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span> <span class="pl-c1">and</span> <span class="pl-en">len</span>(<span class="pl-s1">gdf</span>[<span class="pl-s1">county_field</span>].<span class="pl-c1">unique</span>()) <span class="pl-c1">==</span> <span class="pl-c1">1</span>:
            <span class="pl-s1">county_name</span> <span class="pl-c1">=</span> <span class="pl-s1">gdf</span>[<span class="pl-s1">county_field</span>].<span class="pl-c1">iloc</span>[<span class="pl-c1">0</span>]
        <span class="pl-k">else</span>:
            <span class="pl-c"># 从文件名提取县名或使用默认值</span>
            <span class="pl-s1">county_name</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">basename</span>(<span class="pl-s1">shp_file</span>).<span class="pl-c1">replace</span>(<span class="pl-s">'.shp'</span>, <span class="pl-s">''</span>)
            <span class="pl-en">print</span>(<span class="pl-s">f"使用文件名作为县名: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">county_name</span><span class="pl-kos">}</span></span>"</span>)
        
        <span class="pl-c"># 清理县名用于文件名</span>
        <span class="pl-s1">county_name_clean</span> <span class="pl-c1">=</span> <span class="pl-en">clean_filename</span>(<span class="pl-s1">county_name</span>)
        
        <span class="pl-c"># 创建县目录</span>
        <span class="pl-s1">county_dir</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">join</span>(<span class="pl-s1">output_dir</span>, <span class="pl-s1">county_name_clean</span>)
        <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">exists</span>(<span class="pl-s1">county_dir</span>):
            <span class="pl-s1">os</span>.<span class="pl-c1">makedirs</span>(<span class="pl-s1">county_dir</span>)
        
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>开始切分并保存乡镇文件..."</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">60</span>)
        
        <span class="pl-s1">success_count</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>
        <span class="pl-s1">fail_count</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>
        <span class="pl-s1">total_files_created</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>
        
        <span class="pl-k">for</span> <span class="pl-s1">idx</span>, <span class="pl-s1">row</span> <span class="pl-c1">in</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">iterrows</span>():
            <span class="pl-s1">town_name</span> <span class="pl-c1">=</span> <span class="pl-s1">row</span>[<span class="pl-s1">town_field</span>]
            <span class="pl-s1">geometry</span> <span class="pl-c1">=</span> <span class="pl-s1">row</span>.<span class="pl-c1">geometry</span>
            
            <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>处理乡镇: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town_name</span><span class="pl-kos">}</span></span>"</span>)
            
            <span class="pl-c"># 清理乡镇名用于文件名</span>
            <span class="pl-s1">town_name_clean</span> <span class="pl-c1">=</span> <span class="pl-en">clean_filename</span>(<span class="pl-s1">town_name</span>)
            
            <span class="pl-c"># 处理MultiPolygon</span>
            <span class="pl-k">if</span> <span class="pl-en">isinstance</span>(<span class="pl-s1">geometry</span>, <span class="pl-v">MultiPolygon</span>):
                <span class="pl-s1">polygons</span> <span class="pl-c1">=</span> <span class="pl-en">list</span>(<span class="pl-s1">geometry</span>.<span class="pl-c1">geoms</span>)
            <span class="pl-k">else</span>:
                <span class="pl-s1">polygons</span> <span class="pl-c1">=</span> [<span class="pl-s1">geometry</span>]
            
            <span class="pl-s1">town_parts</span> <span class="pl-c1">=</span> []
            
            <span class="pl-k">for</span> <span class="pl-s1">poly_idx</span>, <span class="pl-s1">polygon</span> <span class="pl-c1">in</span> <span class="pl-en">enumerate</span>(<span class="pl-s1">polygons</span>):
                <span class="pl-c"># 切分多边形</span>
                <span class="pl-s1">part1</span>, <span class="pl-s1">part2</span> <span class="pl-c1">=</span> <span class="pl-en">split_polygon_into_two</span>(<span class="pl-s1">polygon</span>)
                
                <span class="pl-k">if</span> <span class="pl-s1">part1</span> <span class="pl-c1"><span class="pl-c1">is</span> <span class="pl-c1">not</span></span> <span class="pl-c1">None</span> <span class="pl-c1">and</span> <span class="pl-s1">part2</span> <span class="pl-c1"><span class="pl-c1">is</span> <span class="pl-c1">not</span></span> <span class="pl-c1">None</span> <span class="pl-c1">and</span> <span class="pl-c1">not</span> <span class="pl-s1">part1</span>.<span class="pl-c1">equals</span>(<span class="pl-s1">part2</span>):
                    <span class="pl-s1">town_parts</span>.<span class="pl-c1">extend</span>([<span class="pl-s1">part1</span>, <span class="pl-s1">part2</span>])
                    <span class="pl-en">print</span>(<span class="pl-s">f"  ✓ 成功切分第<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">poly_idx</span><span class="pl-c1">+</span><span class="pl-c1">1</span><span class="pl-kos">}</span></span>个多边形"</span>)
                <span class="pl-k">else</span>:
                    <span class="pl-c"># 如果切分失败，使用边界框切分</span>
                    <span class="pl-en">print</span>(<span class="pl-s">f"  ⚠ 第<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">poly_idx</span><span class="pl-c1">+</span><span class="pl-c1">1</span><span class="pl-kos">}</span></span>个多边形切分不理想，使用边界框切分"</span>)
                    <span class="pl-s1">part1</span>, <span class="pl-s1">part2</span> <span class="pl-c1">=</span> <span class="pl-en">split_by_bounds</span>(<span class="pl-s1">polygon</span>)
                    <span class="pl-k">if</span> <span class="pl-s1">part1</span> <span class="pl-c1"><span class="pl-c1">is</span> <span class="pl-c1">not</span></span> <span class="pl-c1">None</span> <span class="pl-c1">and</span> <span class="pl-s1">part2</span> <span class="pl-c1"><span class="pl-c1">is</span> <span class="pl-c1">not</span></span> <span class="pl-c1">None</span> <span class="pl-c1">and</span> <span class="pl-c1">not</span> <span class="pl-s1">part1</span>.<span class="pl-c1">equals</span>(<span class="pl-s1">part2</span>):
                        <span class="pl-s1">town_parts</span>.<span class="pl-c1">extend</span>([<span class="pl-s1">part1</span>, <span class="pl-s1">part2</span>])
                    <span class="pl-k">else</span>:
                        <span class="pl-en">print</span>(<span class="pl-s">f"  ✗ 第<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">poly_idx</span><span class="pl-c1">+</span><span class="pl-c1">1</span><span class="pl-kos">}</span></span>个多边形切分完全失败，保留原状"</span>)
                        <span class="pl-s1">town_parts</span>.<span class="pl-c1">append</span>(<span class="pl-s1">polygon</span>)
            
            <span class="pl-c"># 为每个部分创建单独的shp文件</span>
            <span class="pl-k">for</span> <span class="pl-s1">i</span>, <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-en">enumerate</span>(<span class="pl-s1">town_parts</span>[:<span class="pl-c1">2</span>], <span class="pl-c1">1</span>):  <span class="pl-c"># 只取前两个部分</span>
                <span class="pl-c"># 创建新的GeoDataFrame</span>
                <span class="pl-s1">new_row</span> <span class="pl-c1">=</span> <span class="pl-s1">row</span>.<span class="pl-c1">copy</span>()
                <span class="pl-s1">new_row</span>.<span class="pl-c1">geometry</span> <span class="pl-c1">=</span> <span class="pl-s1">part</span>
                <span class="pl-c"># 添加切分信息</span>
                <span class="pl-s1">new_row</span>[<span class="pl-s">'SPLIT_ID'</span>] <span class="pl-c1">=</span> <span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">county_name</span><span class="pl-kos">}</span></span>-<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town_name</span><span class="pl-kos">}</span></span>-<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">i</span><span class="pl-kos">}</span></span>"</span>
                <span class="pl-s1">new_row</span>[<span class="pl-s">'ORIGINAL_TOWN'</span>] <span class="pl-c1">=</span> <span class="pl-s1">town_name</span>
                <span class="pl-s1">new_row</span>[<span class="pl-s">'SPLIT_PART'</span>] <span class="pl-c1">=</span> <span class="pl-s1">i</span>
                <span class="pl-s1">new_row</span>[<span class="pl-s">'COUNTY_NAME'</span>] <span class="pl-c1">=</span> <span class="pl-s1">county_name</span>
                
                <span class="pl-s1">single_gdf</span> <span class="pl-c1">=</span> <span class="pl-s1">gpd</span>.<span class="pl-c1">GeoDataFrame</span>([<span class="pl-s1">new_row</span>], <span class="pl-s1">crs</span><span class="pl-c1">=</span><span class="pl-s1">gdf</span>.<span class="pl-c1">crs</span>)
                
                <span class="pl-c"># 生成文件名</span>
                <span class="pl-s1">file_name</span> <span class="pl-c1">=</span> <span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">county_name_clean</span><span class="pl-kos">}</span></span>-<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town_name_clean</span><span class="pl-kos">}</span></span>-<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">i</span><span class="pl-kos">}</span></span>"</span>
                
                <span class="pl-c"># 保存为单独的shp文件</span>
                <span class="pl-k">if</span> <span class="pl-en">save_single_shapefile</span>(<span class="pl-s1">single_gdf</span>, <span class="pl-s1">county_dir</span>, <span class="pl-s1">file_name</span>):
                    <span class="pl-s1">total_files_created</span> <span class="pl-c1">+=</span> <span class="pl-c1">1</span>
                    <span class="pl-en">print</span>(<span class="pl-s">f"  ✓ 保存: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">file_name</span><span class="pl-kos">}</span></span>.shp"</span>)
                <span class="pl-k">else</span>:
                    <span class="pl-en">print</span>(<span class="pl-s">f"  ✗ 保存失败: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">file_name</span><span class="pl-kos">}</span></span>.shp"</span>)
            
            <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">town_parts</span>) <span class="pl-c1">&gt;=</span> <span class="pl-c1">2</span>:
                <span class="pl-s1">success_count</span> <span class="pl-c1">+=</span> <span class="pl-c1">1</span>
            <span class="pl-k">else</span>:
                <span class="pl-s1">fail_count</span> <span class="pl-c1">+=</span> <span class="pl-c1">1</span>
        
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>"</span> <span class="pl-c1">+</span> <span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">60</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"处理完成!"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">60</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"原始乡镇数量: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">len</span>(<span class="pl-s1">gdf</span>)<span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"成功切分: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">success_count</span><span class="pl-kos">}</span></span> 个乡镇"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"切分失败: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">fail_count</span><span class="pl-kos">}</span></span> 个乡镇"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"创建的shp文件总数: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">total_files_created</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"输出目录: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">county_dir</span><span class="pl-kos">}</span></span>"</span>)
        
        <span class="pl-c"># 显示生成的文件列表</span>
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>生成的文件列表:"</span>)
        <span class="pl-s1">shp_files</span> <span class="pl-c1">=</span> [<span class="pl-s1">f</span> <span class="pl-k">for</span> <span class="pl-s1">f</span> <span class="pl-c1">in</span> <span class="pl-s1">os</span>.<span class="pl-c1">listdir</span>(<span class="pl-s1">county_dir</span>) <span class="pl-k">if</span> <span class="pl-s1">f</span>.<span class="pl-c1">endswith</span>(<span class="pl-s">'.shp'</span>)]
        <span class="pl-k">for</span> <span class="pl-s1">i</span>, <span class="pl-s1">file</span> <span class="pl-c1">in</span> <span class="pl-en">enumerate</span>(<span class="pl-s1">shp_files</span>[:<span class="pl-c1">20</span>], <span class="pl-c1">1</span>):  <span class="pl-c"># 只显示前20个文件</span>
            <span class="pl-en">print</span>(<span class="pl-s">f"  <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">i</span><span class="pl-kos">}</span></span>. <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">file</span><span class="pl-kos">}</span></span>"</span>)
        
        <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">shp_files</span>) <span class="pl-c1">&gt;</span> <span class="pl-c1">20</span>:
            <span class="pl-en">print</span>(<span class="pl-s">f"  ... 还有 <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">len</span>(<span class="pl-s1">shp_files</span>) <span class="pl-c1">-</span> <span class="pl-c1">20</span><span class="pl-kos">}</span></span> 个文件"</span>)
        
        <span class="pl-c"># 保存处理日志</span>
        <span class="pl-en">save_processing_log</span>(<span class="pl-s1">county_dir</span>, <span class="pl-s1">county_name</span>, <span class="pl-s1">gdf</span>, <span class="pl-s1">success_count</span>, <span class="pl-s1">fail_count</span>, <span class="pl-s1">total_files_created</span>)
        
        <span class="pl-k">return</span> <span class="pl-s1">total_files_created</span>
        
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"处理过程中发生错误: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">import</span> <span class="pl-s1">traceback</span>
        <span class="pl-s1">traceback</span>.<span class="pl-c1">print_exc</span>()
        <span class="pl-k">return</span> <span class="pl-c1">0</span>

<span class="pl-k">def</span> <span class="pl-en">split_by_bounds</span>(<span class="pl-s1">polygon</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    使用边界框进行切分</span>
<span class="pl-s">    """</span>
    <span class="pl-k">try</span>:
        <span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>, <span class="pl-s1">maxx</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">=</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">bounds</span>
        <span class="pl-s1">center_x</span>, <span class="pl-s1">center_y</span> <span class="pl-c1">=</span> (<span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-s1">maxx</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>, (<span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-s1">maxy</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
        
        <span class="pl-c"># 创建四个象限的矩形</span>
        <span class="pl-s1">rect1</span> <span class="pl-c1">=</span> <span class="pl-en">Polygon</span>([(<span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">center_x</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">center_x</span>, <span class="pl-s1">center_y</span>), (<span class="pl-s1">minx</span>, <span class="pl-s1">center_y</span>), (<span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>)])
        <span class="pl-s1">rect2</span> <span class="pl-c1">=</span> <span class="pl-en">Polygon</span>([(<span class="pl-s1">center_x</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">maxx</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">maxx</span>, <span class="pl-s1">center_y</span>), (<span class="pl-s1">center_x</span>, <span class="pl-s1">center_y</span>), (<span class="pl-s1">center_x</span>, <span class="pl-s1">miny</span>)])
        <span class="pl-s1">rect3</span> <span class="pl-c1">=</span> <span class="pl-en">Polygon</span>([(<span class="pl-s1">minx</span>, <span class="pl-s1">center_y</span>), (<span class="pl-s1">center_x</span>, <span class="pl-s1">center_y</span>), (<span class="pl-s1">center_x</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">minx</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">minx</span>, <span class="pl-s1">center_y</span>)])
        <span class="pl-s1">rect4</span> <span class="pl-c1">=</span> <span class="pl-en">Polygon</span>([(<span class="pl-s1">center_x</span>, <span class="pl-s1">center_y</span>), (<span class="pl-s1">maxx</span>, <span class="pl-s1">center_y</span>), (<span class="pl-s1">maxx</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">center_x</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">center_x</span>, <span class="pl-s1">center_y</span>)])
        
        <span class="pl-c"># 与原始多边形求交</span>
        <span class="pl-s1">parts</span> <span class="pl-c1">=</span> []
        <span class="pl-k">for</span> <span class="pl-s1">rect</span> <span class="pl-c1">in</span> [<span class="pl-s1">rect1</span>, <span class="pl-s1">rect2</span>, <span class="pl-s1">rect3</span>, <span class="pl-s1">rect4</span>]:
            <span class="pl-s1">intersection</span> <span class="pl-c1">=</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">intersection</span>(<span class="pl-s1">rect</span>)
            <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">intersection</span>.<span class="pl-c1">is_empty</span> <span class="pl-c1">and</span> <span class="pl-s1">intersection</span>.<span class="pl-c1">area</span> <span class="pl-c1">&gt;</span> <span class="pl-c1">0</span>:
                <span class="pl-k">if</span> <span class="pl-en">isinstance</span>(<span class="pl-s1">intersection</span>, <span class="pl-v">MultiPolygon</span>):
                    <span class="pl-s1">parts</span>.<span class="pl-c1">extend</span>(<span class="pl-en">list</span>(<span class="pl-s1">intersection</span>.<span class="pl-c1">geoms</span>))
                <span class="pl-k">else</span>:
                    <span class="pl-s1">parts</span>.<span class="pl-c1">append</span>(<span class="pl-s1">intersection</span>)
        
        <span class="pl-c"># 按面积排序，取前两个最大的部分</span>
        <span class="pl-s1">parts</span>.<span class="pl-c1">sort</span>(<span class="pl-s1">key</span><span class="pl-c1">=</span><span class="pl-k">lambda</span> <span class="pl-s1">x</span>: <span class="pl-s1">x</span>.<span class="pl-c1">area</span>, <span class="pl-s1">reverse</span><span class="pl-c1">=</span><span class="pl-c1">True</span>)
        <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">parts</span>) <span class="pl-c1">&gt;=</span> <span class="pl-c1">2</span>:
            <span class="pl-k">return</span> <span class="pl-s1">parts</span>[<span class="pl-c1">0</span>], <span class="pl-s1">parts</span>[<span class="pl-c1">1</span>]
        <span class="pl-k">elif</span> <span class="pl-en">len</span>(<span class="pl-s1">parts</span>) <span class="pl-c1">==</span> <span class="pl-c1">1</span>:
            <span class="pl-k">return</span> <span class="pl-s1">parts</span>[<span class="pl-c1">0</span>], <span class="pl-s1">parts</span>[<span class="pl-c1">0</span>]
        <span class="pl-k">else</span>:
            <span class="pl-k">return</span> <span class="pl-s1">polygon</span>, <span class="pl-s1">polygon</span>
            
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"边界框切分失败: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">return</span> <span class="pl-s1">polygon</span>, <span class="pl-s1">polygon</span>

<span class="pl-k">def</span> <span class="pl-en">save_processing_log</span>(<span class="pl-s1">output_dir</span>, <span class="pl-s1">county_name</span>, <span class="pl-s1">original_gdf</span>, <span class="pl-s1">success_count</span>, <span class="pl-s1">fail_count</span>, <span class="pl-s1">total_files</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    保存处理日志</span>
<span class="pl-s">    """</span>
    <span class="pl-k">try</span>:
        <span class="pl-s1">log_file</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">join</span>(<span class="pl-s1">output_dir</span>, <span class="pl-s">f"处理日志.txt"</span>)
        
        <span class="pl-k">with</span> <span class="pl-en">open</span>(<span class="pl-s1">log_file</span>, <span class="pl-s">'w'</span>, <span class="pl-s1">encoding</span><span class="pl-c1">=</span><span class="pl-s">'utf-8'</span>) <span class="pl-k">as</span> <span class="pl-s1">f</span>:
            <span class="pl-s1">f</span>.<span class="pl-c1">write</span>(<span class="pl-s">f"乡镇切分处理日志<span class="pl-cce">\n</span>"</span>)
            <span class="pl-s1">f</span>.<span class="pl-c1">write</span>(<span class="pl-s">f"="</span> <span class="pl-c1">*</span> <span class="pl-c1">50</span> <span class="pl-c1">+</span> <span class="pl-s">"<span class="pl-cce">\n</span>"</span>)
            <span class="pl-s1">f</span>.<span class="pl-c1">write</span>(<span class="pl-s">f"处理时间: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">pd</span>.<span class="pl-c1">Timestamp</span>.<span class="pl-c1">now</span>().<span class="pl-c1">strftime</span>(<span class="pl-s">'%Y-%m-%d %H:%M:%S'</span>)<span class="pl-kos">}</span></span><span class="pl-cce">\n</span>"</span>)
            <span class="pl-s1">f</span>.<span class="pl-c1">write</span>(<span class="pl-s">f"县名称: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">county_name</span><span class="pl-kos">}</span></span><span class="pl-cce">\n</span>"</span>)
            <span class="pl-s1">f</span>.<span class="pl-c1">write</span>(<span class="pl-s">f"原始乡镇数量: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">len</span>(<span class="pl-s1">original_gdf</span>)<span class="pl-kos">}</span></span><span class="pl-cce">\n</span>"</span>)
            <span class="pl-s1">f</span>.<span class="pl-c1">write</span>(<span class="pl-s">f"成功切分: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">success_count</span><span class="pl-kos">}</span></span> 个乡镇<span class="pl-cce">\n</span>"</span>)
            <span class="pl-s1">f</span>.<span class="pl-c1">write</span>(<span class="pl-s">f"切分失败: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">fail_count</span><span class="pl-kos">}</span></span> 个乡镇<span class="pl-cce">\n</span>"</span>)
            <span class="pl-s1">f</span>.<span class="pl-c1">write</span>(<span class="pl-s">f"生成的shp文件总数: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">total_files</span><span class="pl-kos">}</span></span><span class="pl-cce">\n</span>"</span>)
            <span class="pl-s1">f</span>.<span class="pl-c1">write</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>原始乡镇列表:<span class="pl-cce">\n</span>"</span>)
            
            <span class="pl-s1">town_field</span> <span class="pl-c1">=</span> <span class="pl-en">auto_detect_town_field</span>(<span class="pl-s1">original_gdf</span>)
            <span class="pl-k">for</span> <span class="pl-s1">town</span> <span class="pl-c1">in</span> <span class="pl-s1">original_gdf</span>[<span class="pl-s1">town_field</span>].<span class="pl-c1">unique</span>():
                <span class="pl-s1">f</span>.<span class="pl-c1">write</span>(<span class="pl-s">f"  - <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town</span><span class="pl-kos">}</span></span><span class="pl-cce">\n</span>"</span>)
        
        <span class="pl-en">print</span>(<span class="pl-s">f"处理日志已保存: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">log_file</span><span class="pl-kos">}</span></span>"</span>)
        
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"保存处理日志时出错: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)

<span class="pl-c"># 使用示例</span>
<span class="pl-k">if</span> <span class="pl-s1">__name__</span> <span class="pl-c1">==</span> <span class="pl-s">"__main__"</span>:
    <span class="pl-c"># 输入文件路径 - 替换为您的县级Shapefile路径</span>
    <span class="pl-s1">input_shp</span> <span class="pl-c1">=</span> <span class="pl-s">"黔东南苗族侗族自治州_县.shp"</span>  <span class="pl-c"># 您的县级shp文件</span>
    <span class="pl-s1">output_directory</span> <span class="pl-c1">=</span> <span class="pl-s1">input_shp</span>.<span class="pl-c1">split</span>(<span class="pl-s">'.'</span>)[<span class="pl-c1">0</span>]
    
    <span class="pl-en">print</span>(<span class="pl-s">"开始自动切分乡镇并保存为单独文件..."</span>)
    <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">60</span>)
    
    <span class="pl-c"># 执行切分</span>
    <span class="pl-s1">files_created</span> <span class="pl-c1">=</span> <span class="pl-en">split_towns_to_individual_files</span>(
        <span class="pl-s1">shp_file</span><span class="pl-c1">=</span><span class="pl-s1">input_shp</span>,
        <span class="pl-s1">output_dir</span><span class="pl-c1">=</span><span class="pl-s1">output_directory</span>
    )
    
    <span class="pl-k">if</span> <span class="pl-s1">files_created</span> <span class="pl-c1">&gt;</span> <span class="pl-c1">0</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>"</span> <span class="pl-c1">+</span> <span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">60</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"处理完成！"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">60</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"总共生成了 <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">files_created</span><span class="pl-kos">}</span></span> 个shp文件"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"文件命名格式: 县名-镇名-编号.shp"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"示例: 某县-某镇-1.shp, 某县-某镇-2.shp"</span>)
    <span class="pl-k">else</span>:
        <span class="pl-en">print</span>(<span class="pl-s">"<span class="pl-cce">\n</span>处理失败，请检查输入文件和错误信息。"</span>)</pre></div>
<h4>效果</h4>
<p><a target="_blank" rel="noopener noreferrer" href=""><img alt="image-20251107164010369" style="max-width: 100%;"></a></p>
<h3>切分多块</h3>
<h4>代码</h4>
<div class="highlight highlight-source-python"><pre class="notranslate"><span class="pl-k">import</span> <span class="pl-s1">geopandas</span> <span class="pl-k">as</span> <span class="pl-s1">gpd</span>
<span class="pl-k">import</span> <span class="pl-s1">pandas</span> <span class="pl-k">as</span> <span class="pl-s1">pd</span>
<span class="pl-k">import</span> <span class="pl-s1">numpy</span> <span class="pl-k">as</span> <span class="pl-s1">np</span>
<span class="pl-k">from</span> <span class="pl-s1">shapely</span>.<span class="pl-s1">geometry</span> <span class="pl-k">import</span> <span class="pl-v">Polygon</span>, <span class="pl-v">MultiPolygon</span>, <span class="pl-v">LineString</span>, <span class="pl-v">Point</span>
<span class="pl-k">from</span> <span class="pl-s1">shapely</span>.<span class="pl-s1">ops</span> <span class="pl-k">import</span> <span class="pl-s1">split</span>, <span class="pl-s1">voronoi_diagram</span>
<span class="pl-k">import</span> <span class="pl-s1">os</span>
<span class="pl-k">import</span> <span class="pl-s1">math</span>

<span class="pl-k">def</span> <span class="pl-en">split_polygon_into_n_parts</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span><span class="pl-c1">=</span><span class="pl-c1">2</span>, <span class="pl-s1">method</span><span class="pl-c1">=</span><span class="pl-s">'grid'</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    将多边形切分为N部分</span>
<span class="pl-s">    </span>
<span class="pl-s">    参数:</span>
<span class="pl-s">    polygon: 要切分的多边形</span>
<span class="pl-s">    n_parts: 切分数量 (2, 3, 4)</span>
<span class="pl-s">    method: 切分方法 ('grid', 'voronoi', 'radial')</span>
<span class="pl-s">    """</span>
    <span class="pl-k">try</span>:
        <span class="pl-k">if</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">is_empty</span>:
            <span class="pl-k">return</span> [<span class="pl-s1">polygon</span>] <span class="pl-c1">*</span> <span class="pl-s1">n_parts</span>
            
        <span class="pl-c"># 获取多边形的边界框</span>
        <span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>, <span class="pl-s1">maxx</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">=</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">bounds</span>
        
        <span class="pl-k">if</span> <span class="pl-s1">method</span> <span class="pl-c1">==</span> <span class="pl-s">'grid'</span>:
            <span class="pl-k">return</span> <span class="pl-en">split_by_grid</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>)
        <span class="pl-k">elif</span> <span class="pl-s1">method</span> <span class="pl-c1">==</span> <span class="pl-s">'voronoi'</span>:
            <span class="pl-k">return</span> <span class="pl-en">split_by_voronoi</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>)
        <span class="pl-k">elif</span> <span class="pl-s1">method</span> <span class="pl-c1">==</span> <span class="pl-s">'radial'</span>:
            <span class="pl-k">return</span> <span class="pl-en">split_by_radial</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>)
        <span class="pl-k">else</span>:
            <span class="pl-k">return</span> <span class="pl-en">split_by_grid</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>)
            
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"切分多边形时出错: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-c"># 如果切分失败，返回原始多边形的多个副本</span>
        <span class="pl-k">return</span> [<span class="pl-s1">polygon</span>] <span class="pl-c1">*</span> <span class="pl-s1">n_parts</span>

<span class="pl-k">def</span> <span class="pl-en">split_by_grid</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    使用网格方法切分多边形</span>
<span class="pl-s">    """</span>
    <span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>, <span class="pl-s1">maxx</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">=</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">bounds</span>
    <span class="pl-s1">width</span> <span class="pl-c1">=</span> <span class="pl-s1">maxx</span> <span class="pl-c1">-</span> <span class="pl-s1">minx</span>
    <span class="pl-s1">height</span> <span class="pl-c1">=</span> <span class="pl-s1">maxy</span> <span class="pl-c1">-</span> <span class="pl-s1">miny</span>
    
    <span class="pl-s1">parts</span> <span class="pl-c1">=</span> []
    
    <span class="pl-k">if</span> <span class="pl-s1">n_parts</span> <span class="pl-c1">==</span> <span class="pl-c1">2</span>:
        <span class="pl-c"># 2等分</span>
        <span class="pl-k">if</span> <span class="pl-s1">width</span> <span class="pl-c1">&gt;</span> <span class="pl-s1">height</span>:
            <span class="pl-c"># 垂直切分</span>
            <span class="pl-s1">mid_x</span> <span class="pl-c1">=</span> (<span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-s1">maxx</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
            <span class="pl-s1">split_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">mid_x</span>, <span class="pl-s1">miny</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>)])
        <span class="pl-k">else</span>:
            <span class="pl-c"># 水平切分</span>
            <span class="pl-s1">mid_y</span> <span class="pl-c1">=</span> (<span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-s1">maxy</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
            <span class="pl-s1">split_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">minx</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>, <span class="pl-s1">mid_y</span>), (<span class="pl-s1">maxx</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>, <span class="pl-s1">mid_y</span>)])
        
        <span class="pl-s1">split_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">split_line</span>)
        <span class="pl-s1">parts</span> <span class="pl-c1">=</span> [<span class="pl-s1">part</span> <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">split_parts</span>.<span class="pl-c1">geoms</span> <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>]
        
    <span class="pl-k">elif</span> <span class="pl-s1">n_parts</span> <span class="pl-c1">==</span> <span class="pl-c1">3</span>:
        <span class="pl-c"># 3等分 - 根据长宽比决定切分方向</span>
        <span class="pl-k">if</span> <span class="pl-s1">width</span> <span class="pl-c1">&gt;</span> <span class="pl-s1">height</span>:
            <span class="pl-c"># 垂直三等分</span>
            <span class="pl-s1">x1</span> <span class="pl-c1">=</span> <span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-s1">width</span> <span class="pl-c1">/</span> <span class="pl-c1">3</span>
            <span class="pl-s1">x2</span> <span class="pl-c1">=</span> <span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-c1">2</span> <span class="pl-c1">*</span> <span class="pl-s1">width</span> <span class="pl-c1">/</span> <span class="pl-c1">3</span>
            <span class="pl-s1">split_line1</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">x1</span>, <span class="pl-s1">miny</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>), (<span class="pl-s1">x1</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>)])
            <span class="pl-s1">split_line2</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">x2</span>, <span class="pl-s1">miny</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>), (<span class="pl-s1">x2</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>)])
        <span class="pl-k">else</span>:
            <span class="pl-c"># 水平三等分</span>
            <span class="pl-s1">y1</span> <span class="pl-c1">=</span> <span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-s1">height</span> <span class="pl-c1">/</span> <span class="pl-c1">3</span>
            <span class="pl-s1">y2</span> <span class="pl-c1">=</span> <span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-c1">2</span> <span class="pl-c1">*</span> <span class="pl-s1">height</span> <span class="pl-c1">/</span> <span class="pl-c1">3</span>
            <span class="pl-s1">split_line1</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">minx</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>, <span class="pl-s1">y1</span>), (<span class="pl-s1">maxx</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>, <span class="pl-s1">y1</span>)])
            <span class="pl-s1">split_line2</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">minx</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>, <span class="pl-s1">y2</span>), (<span class="pl-s1">maxx</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>, <span class="pl-s1">y2</span>)])
        
        <span class="pl-c"># 第一次切分</span>
        <span class="pl-s1">temp_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">split_line1</span>)
        <span class="pl-s1">parts</span> <span class="pl-c1">=</span> []
        <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">temp_parts</span>.<span class="pl-c1">geoms</span>:
            <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>:
                <span class="pl-c"># 第二次切分</span>
                <span class="pl-s1">sub_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">part</span>, <span class="pl-s1">split_line2</span>)
                <span class="pl-s1">parts</span>.<span class="pl-c1">extend</span>([<span class="pl-s1">p</span> <span class="pl-k">for</span> <span class="pl-s1">p</span> <span class="pl-c1">in</span> <span class="pl-s1">sub_parts</span>.<span class="pl-c1">geoms</span> <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">p</span>.<span class="pl-c1">is_empty</span>])
                
    <span class="pl-k">elif</span> <span class="pl-s1">n_parts</span> <span class="pl-c1">==</span> <span class="pl-c1">4</span>:
        <span class="pl-c"># 4等分 - 十字切分</span>
        <span class="pl-s1">mid_x</span> <span class="pl-c1">=</span> (<span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-s1">maxx</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
        <span class="pl-s1">mid_y</span> <span class="pl-c1">=</span> (<span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-s1">maxy</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
        
        <span class="pl-c"># 垂直切分线</span>
        <span class="pl-s1">vert_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">mid_x</span>, <span class="pl-s1">miny</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>)])
        <span class="pl-c"># 水平切分线</span>
        <span class="pl-s1">horz_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">minx</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>, <span class="pl-s1">mid_y</span>), (<span class="pl-s1">maxx</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>, <span class="pl-s1">mid_y</span>)])
        
        <span class="pl-c"># 先垂直切分</span>
        <span class="pl-s1">temp_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">vert_line</span>)
        <span class="pl-s1">parts</span> <span class="pl-c1">=</span> []
        <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">temp_parts</span>.<span class="pl-c1">geoms</span>:
            <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>:
                <span class="pl-c"># 再水平切分</span>
                <span class="pl-s1">sub_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">part</span>, <span class="pl-s1">horz_line</span>)
                <span class="pl-s1">parts</span>.<span class="pl-c1">extend</span>([<span class="pl-s1">p</span> <span class="pl-k">for</span> <span class="pl-s1">p</span> <span class="pl-c1">in</span> <span class="pl-s1">sub_parts</span>.<span class="pl-c1">geoms</span> <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">p</span>.<span class="pl-c1">is_empty</span>])
    
    <span class="pl-c"># 过滤有效的多边形并确保数量正确</span>
    <span class="pl-s1">valid_parts</span> <span class="pl-c1">=</span> [<span class="pl-s1">part</span> <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">parts</span> <span class="pl-k">if</span> <span class="pl-en">isinstance</span>(<span class="pl-s1">part</span>, (<span class="pl-v">Polygon</span>, <span class="pl-v">MultiPolygon</span>)) <span class="pl-c1">and</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>]
    
    <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">valid_parts</span>) <span class="pl-c1">&gt;=</span> <span class="pl-s1">n_parts</span>:
        <span class="pl-c"># 按面积排序，取前n_parts个最大的部分</span>
        <span class="pl-s1">valid_parts</span>.<span class="pl-c1">sort</span>(<span class="pl-s1">key</span><span class="pl-c1">=</span><span class="pl-k">lambda</span> <span class="pl-s1">x</span>: <span class="pl-s1">x</span>.<span class="pl-c1">area</span>, <span class="pl-s1">reverse</span><span class="pl-c1">=</span><span class="pl-c1">True</span>)
        <span class="pl-k">return</span> <span class="pl-s1">valid_parts</span>[:<span class="pl-s1">n_parts</span>]
    <span class="pl-k">else</span>:
        <span class="pl-c"># 如果切分出的部分不够，使用边界框方法</span>
        <span class="pl-k">return</span> <span class="pl-en">split_by_bounds</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>)

<span class="pl-k">def</span> <span class="pl-en">split_by_voronoi</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    使用Voronoi图方法切分多边形</span>
<span class="pl-s">    """</span>
    <span class="pl-k">try</span>:
        <span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>, <span class="pl-s1">maxx</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">=</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">bounds</span>
        <span class="pl-s1">center_x</span>, <span class="pl-s1">center_y</span> <span class="pl-c1">=</span> (<span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-s1">maxx</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>, (<span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-s1">maxy</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
        
        <span class="pl-c"># 生成随机点（在边界框内）</span>
        <span class="pl-s1">points</span> <span class="pl-c1">=</span> []
        <span class="pl-k">for</span> <span class="pl-s1">_</span> <span class="pl-c1">in</span> <span class="pl-en">range</span>(<span class="pl-s1">n_parts</span>):
            <span class="pl-c"># 在边界框内随机生成点，但偏向中心区域</span>
            <span class="pl-s1">x</span> <span class="pl-c1">=</span> <span class="pl-s1">np</span>.<span class="pl-c1">random</span>.<span class="pl-c1">uniform</span>(<span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-c1">0.2</span><span class="pl-c1">*</span>(<span class="pl-s1">maxx</span><span class="pl-c1">-</span><span class="pl-s1">minx</span>), <span class="pl-s1">maxx</span> <span class="pl-c1">-</span> <span class="pl-c1">0.2</span><span class="pl-c1">*</span>(<span class="pl-s1">maxx</span><span class="pl-c1">-</span><span class="pl-s1">minx</span>))
            <span class="pl-s1">y</span> <span class="pl-c1">=</span> <span class="pl-s1">np</span>.<span class="pl-c1">random</span>.<span class="pl-c1">uniform</span>(<span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-c1">0.2</span><span class="pl-c1">*</span>(<span class="pl-s1">maxy</span><span class="pl-c1">-</span><span class="pl-s1">miny</span>), <span class="pl-s1">maxy</span> <span class="pl-c1">-</span> <span class="pl-c1">0.2</span><span class="pl-c1">*</span>(<span class="pl-s1">maxy</span><span class="pl-c1">-</span><span class="pl-s1">miny</span>))
            <span class="pl-s1">points</span>.<span class="pl-c1">append</span>(<span class="pl-en">Point</span>(<span class="pl-s1">x</span>, <span class="pl-s1">y</span>))
        
        <span class="pl-c"># 添加中心点确保覆盖</span>
        <span class="pl-s1">points</span>.<span class="pl-c1">append</span>(<span class="pl-en">Point</span>(<span class="pl-s1">center_x</span>, <span class="pl-s1">center_y</span>))
        
        <span class="pl-c"># 创建Voronoi图</span>
        <span class="pl-s1">voronoi</span> <span class="pl-c1">=</span> <span class="pl-en">voronoi_diagram</span>(<span class="pl-en">MultiPoint</span>(<span class="pl-s1">points</span>))
        
        <span class="pl-s1">parts</span> <span class="pl-c1">=</span> []
        <span class="pl-k">for</span> <span class="pl-s1">region</span> <span class="pl-c1">in</span> <span class="pl-s1">voronoi</span>.<span class="pl-c1">geoms</span>:
            <span class="pl-k">if</span> <span class="pl-s1">region</span>.<span class="pl-c1">intersects</span>(<span class="pl-s1">polygon</span>):
                <span class="pl-s1">intersection</span> <span class="pl-c1">=</span> <span class="pl-s1">region</span>.<span class="pl-c1">intersection</span>(<span class="pl-s1">polygon</span>)
                <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">intersection</span>.<span class="pl-c1">is_empty</span>:
                    <span class="pl-s1">parts</span>.<span class="pl-c1">append</span>(<span class="pl-s1">intersection</span>)
        
        <span class="pl-c"># 按面积排序，取前n_parts个最大的部分</span>
        <span class="pl-s1">parts</span>.<span class="pl-c1">sort</span>(<span class="pl-s1">key</span><span class="pl-c1">=</span><span class="pl-k">lambda</span> <span class="pl-s1">x</span>: <span class="pl-s1">x</span>.<span class="pl-c1">area</span>, <span class="pl-s1">reverse</span><span class="pl-c1">=</span><span class="pl-c1">True</span>)
        <span class="pl-k">return</span> <span class="pl-s1">parts</span>[:<span class="pl-s1">n_parts</span>] <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">parts</span>) <span class="pl-c1">&gt;=</span> <span class="pl-s1">n_parts</span> <span class="pl-k">else</span> <span class="pl-en">split_by_bounds</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>)
        
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"Voronoi切分失败: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">return</span> <span class="pl-en">split_by_bounds</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>)

<span class="pl-k">def</span> <span class="pl-en">split_by_radial</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    使用径向切分方法</span>
<span class="pl-s">    """</span>
    <span class="pl-k">try</span>:
        <span class="pl-s1">centroid</span> <span class="pl-c1">=</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">centroid</span>
        <span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>, <span class="pl-s1">maxx</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">=</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">bounds</span>
        
        <span class="pl-s1">parts</span> <span class="pl-c1">=</span> []
        <span class="pl-s1">angle_step</span> <span class="pl-c1">=</span> <span class="pl-c1">360</span> <span class="pl-c1">/</span> <span class="pl-s1">n_parts</span>
        
        <span class="pl-k">for</span> <span class="pl-s1">i</span> <span class="pl-c1">in</span> <span class="pl-en">range</span>(<span class="pl-s1">n_parts</span>):
            <span class="pl-c"># 计算径向线的角度</span>
            <span class="pl-s1">angle1</span> <span class="pl-c1">=</span> <span class="pl-s1">math</span>.<span class="pl-c1">radians</span>(<span class="pl-s1">i</span> <span class="pl-c1">*</span> <span class="pl-s1">angle_step</span>)
            <span class="pl-s1">angle2</span> <span class="pl-c1">=</span> <span class="pl-s1">math</span>.<span class="pl-c1">radians</span>((<span class="pl-s1">i</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>) <span class="pl-c1">*</span> <span class="pl-s1">angle_step</span>)
            
            <span class="pl-c"># 创建扇形（从中心到边界）</span>
            <span class="pl-s1">distance</span> <span class="pl-c1">=</span> <span class="pl-s1">math</span>.<span class="pl-c1">sqrt</span>((<span class="pl-s1">maxx</span><span class="pl-c1">-</span><span class="pl-s1">minx</span>)<span class="pl-c1">**</span><span class="pl-c1">2</span> <span class="pl-c1">+</span> (<span class="pl-s1">maxy</span><span class="pl-c1">-</span><span class="pl-s1">miny</span>)<span class="pl-c1">**</span><span class="pl-c1">2</span>)
            <span class="pl-s1">x1</span> <span class="pl-c1">=</span> <span class="pl-s1">centroid</span>.<span class="pl-c1">x</span> <span class="pl-c1">+</span> <span class="pl-s1">distance</span> <span class="pl-c1">*</span> <span class="pl-s1">math</span>.<span class="pl-c1">cos</span>(<span class="pl-s1">angle1</span>)
            <span class="pl-s1">y1</span> <span class="pl-c1">=</span> <span class="pl-s1">centroid</span>.<span class="pl-c1">y</span> <span class="pl-c1">+</span> <span class="pl-s1">distance</span> <span class="pl-c1">*</span> <span class="pl-s1">math</span>.<span class="pl-c1">sin</span>(<span class="pl-s1">angle1</span>)
            <span class="pl-s1">x2</span> <span class="pl-c1">=</span> <span class="pl-s1">centroid</span>.<span class="pl-c1">x</span> <span class="pl-c1">+</span> <span class="pl-s1">distance</span> <span class="pl-c1">*</span> <span class="pl-s1">math</span>.<span class="pl-c1">cos</span>(<span class="pl-s1">angle2</span>)
            <span class="pl-s1">y2</span> <span class="pl-c1">=</span> <span class="pl-s1">centroid</span>.<span class="pl-c1">y</span> <span class="pl-c1">+</span> <span class="pl-s1">distance</span> <span class="pl-c1">*</span> <span class="pl-s1">math</span>.<span class="pl-c1">sin</span>(<span class="pl-s1">angle2</span>)
            
            <span class="pl-c"># 创建三角形扇形</span>
            <span class="pl-s1">triangle</span> <span class="pl-c1">=</span> <span class="pl-en">Polygon</span>([(<span class="pl-s1">centroid</span>.<span class="pl-c1">x</span>, <span class="pl-s1">centroid</span>.<span class="pl-c1">y</span>), (<span class="pl-s1">x1</span>, <span class="pl-s1">y1</span>), (<span class="pl-s1">x2</span>, <span class="pl-s1">y2</span>), (<span class="pl-s1">centroid</span>.<span class="pl-c1">x</span>, <span class="pl-s1">centroid</span>.<span class="pl-c1">y</span>)])
            
            <span class="pl-c"># 与原始多边形求交</span>
            <span class="pl-s1">intersection</span> <span class="pl-c1">=</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">intersection</span>(<span class="pl-s1">triangle</span>)
            <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">intersection</span>.<span class="pl-c1">is_empty</span>:
                <span class="pl-s1">parts</span>.<span class="pl-c1">append</span>(<span class="pl-s1">intersection</span>)
        
        <span class="pl-k">return</span> <span class="pl-s1">parts</span> <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">parts</span>) <span class="pl-c1">&gt;=</span> <span class="pl-s1">n_parts</span> <span class="pl-k">else</span> <span class="pl-en">split_by_bounds</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>)
        
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"径向切分失败: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">return</span> <span class="pl-en">split_by_bounds</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>)

<span class="pl-k">def</span> <span class="pl-en">split_by_bounds</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    使用边界框方法切分多边形</span>
<span class="pl-s">    """</span>
    <span class="pl-k">try</span>:
        <span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>, <span class="pl-s1">maxx</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">=</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">bounds</span>
        
        <span class="pl-k">if</span> <span class="pl-s1">n_parts</span> <span class="pl-c1">==</span> <span class="pl-c1">2</span>:
            <span class="pl-c"># 2等分</span>
            <span class="pl-s1">mid_x</span> <span class="pl-c1">=</span> (<span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-s1">maxx</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
            <span class="pl-s1">rect1</span> <span class="pl-c1">=</span> <span class="pl-en">Polygon</span>([(<span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">minx</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>)])
            <span class="pl-s1">rect2</span> <span class="pl-c1">=</span> <span class="pl-en">Polygon</span>([(<span class="pl-s1">mid_x</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">maxx</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">maxx</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">miny</span>)])
            <span class="pl-s1">parts</span> <span class="pl-c1">=</span> [<span class="pl-s1">rect1</span>.<span class="pl-c1">intersection</span>(<span class="pl-s1">polygon</span>), <span class="pl-s1">rect2</span>.<span class="pl-c1">intersection</span>(<span class="pl-s1">polygon</span>)]
            
        <span class="pl-k">elif</span> <span class="pl-s1">n_parts</span> <span class="pl-c1">==</span> <span class="pl-c1">3</span>:
            <span class="pl-c"># 3等分</span>
            <span class="pl-s1">x1</span> <span class="pl-c1">=</span> <span class="pl-s1">minx</span> <span class="pl-c1">+</span> (<span class="pl-s1">maxx</span> <span class="pl-c1">-</span> <span class="pl-s1">minx</span>) <span class="pl-c1">/</span> <span class="pl-c1">3</span>
            <span class="pl-s1">x2</span> <span class="pl-c1">=</span> <span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-c1">2</span> <span class="pl-c1">*</span> (<span class="pl-s1">maxx</span> <span class="pl-c1">-</span> <span class="pl-s1">minx</span>) <span class="pl-c1">/</span> <span class="pl-c1">3</span>
            <span class="pl-s1">rect1</span> <span class="pl-c1">=</span> <span class="pl-en">Polygon</span>([(<span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">x1</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">x1</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">minx</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>)])
            <span class="pl-s1">rect2</span> <span class="pl-c1">=</span> <span class="pl-en">Polygon</span>([(<span class="pl-s1">x1</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">x2</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">x2</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">x1</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">x1</span>, <span class="pl-s1">miny</span>)])
            <span class="pl-s1">rect3</span> <span class="pl-c1">=</span> <span class="pl-en">Polygon</span>([(<span class="pl-s1">x2</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">maxx</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">maxx</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">x2</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">x2</span>, <span class="pl-s1">miny</span>)])
            <span class="pl-s1">parts</span> <span class="pl-c1">=</span> [<span class="pl-s1">rect1</span>.<span class="pl-c1">intersection</span>(<span class="pl-s1">polygon</span>), <span class="pl-s1">rect2</span>.<span class="pl-c1">intersection</span>(<span class="pl-s1">polygon</span>), <span class="pl-s1">rect3</span>.<span class="pl-c1">intersection</span>(<span class="pl-s1">polygon</span>)]
            
        <span class="pl-k">elif</span> <span class="pl-s1">n_parts</span> <span class="pl-c1">==</span> <span class="pl-c1">4</span>:
            <span class="pl-c"># 4等分</span>
            <span class="pl-s1">mid_x</span> <span class="pl-c1">=</span> (<span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-s1">maxx</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
            <span class="pl-s1">mid_y</span> <span class="pl-c1">=</span> (<span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-s1">maxy</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
            <span class="pl-s1">rect1</span> <span class="pl-c1">=</span> <span class="pl-en">Polygon</span>([(<span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">mid_y</span>), (<span class="pl-s1">minx</span>, <span class="pl-s1">mid_y</span>), (<span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>)])
            <span class="pl-s1">rect2</span> <span class="pl-c1">=</span> <span class="pl-en">Polygon</span>([(<span class="pl-s1">mid_x</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">maxx</span>, <span class="pl-s1">miny</span>), (<span class="pl-s1">maxx</span>, <span class="pl-s1">mid_y</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">mid_y</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">miny</span>)])
            <span class="pl-s1">rect3</span> <span class="pl-c1">=</span> <span class="pl-en">Polygon</span>([(<span class="pl-s1">minx</span>, <span class="pl-s1">mid_y</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">mid_y</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">minx</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">minx</span>, <span class="pl-s1">mid_y</span>)])
            <span class="pl-s1">rect4</span> <span class="pl-c1">=</span> <span class="pl-en">Polygon</span>([(<span class="pl-s1">mid_x</span>, <span class="pl-s1">mid_y</span>), (<span class="pl-s1">maxx</span>, <span class="pl-s1">mid_y</span>), (<span class="pl-s1">maxx</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">maxy</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">mid_y</span>)])
            <span class="pl-s1">parts</span> <span class="pl-c1">=</span> [<span class="pl-s1">rect1</span>.<span class="pl-c1">intersection</span>(<span class="pl-s1">polygon</span>), <span class="pl-s1">rect2</span>.<span class="pl-c1">intersection</span>(<span class="pl-s1">polygon</span>), 
                    <span class="pl-s1">rect3</span>.<span class="pl-c1">intersection</span>(<span class="pl-s1">polygon</span>), <span class="pl-s1">rect4</span>.<span class="pl-c1">intersection</span>(<span class="pl-s1">polygon</span>)]
        
        <span class="pl-c"># 过滤空的部分</span>
        <span class="pl-s1">valid_parts</span> <span class="pl-c1">=</span> [<span class="pl-s1">part</span> <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">parts</span> <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>]
        <span class="pl-k">return</span> <span class="pl-s1">valid_parts</span> <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">valid_parts</span>) <span class="pl-c1">&gt;=</span> <span class="pl-s1">n_parts</span> <span class="pl-k">else</span> [<span class="pl-s1">polygon</span>] <span class="pl-c1">*</span> <span class="pl-s1">n_parts</span>
        
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"边界框切分失败: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">return</span> [<span class="pl-s1">polygon</span>] <span class="pl-c1">*</span> <span class="pl-s1">n_parts</span>

<span class="pl-k">def</span> <span class="pl-en">auto_detect_town_field</span>(<span class="pl-s1">gdf</span>):
    <span class="pl-s">"""自动检测乡镇名字段"""</span>
    <span class="pl-s1">town_keywords</span> <span class="pl-c1">=</span> [<span class="pl-s">'镇'</span>, <span class="pl-s">'乡'</span>, <span class="pl-s">'街道'</span>, <span class="pl-s">'town'</span>, <span class="pl-s">'TOWN'</span>, <span class="pl-s">'name'</span>, <span class="pl-s">'NAME'</span>, <span class="pl-s">'名称'</span>, <span class="pl-s">'地名'</span>]
    <span class="pl-k">for</span> <span class="pl-s1">field</span> <span class="pl-c1">in</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span>:
        <span class="pl-s1">field_lower</span> <span class="pl-c1">=</span> <span class="pl-en">str</span>(<span class="pl-s1">field</span>).<span class="pl-c1">lower</span>()
        <span class="pl-k">for</span> <span class="pl-s1">keyword</span> <span class="pl-c1">in</span> <span class="pl-s1">town_keywords</span>:
            <span class="pl-k">if</span> <span class="pl-s1">keyword</span>.<span class="pl-c1">lower</span>() <span class="pl-c1">in</span> <span class="pl-s1">field_lower</span>:
                <span class="pl-k">return</span> <span class="pl-s1">field</span>
    <span class="pl-s1">non_geom_fields</span> <span class="pl-c1">=</span> [<span class="pl-s1">col</span> <span class="pl-k">for</span> <span class="pl-s1">col</span> <span class="pl-c1">in</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span> <span class="pl-k">if</span> <span class="pl-s1">col</span> <span class="pl-c1">!=</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">geometry</span>.<span class="pl-c1">name</span>]
    <span class="pl-k">return</span> <span class="pl-s1">non_geom_fields</span>[<span class="pl-c1">0</span>] <span class="pl-k">if</span> <span class="pl-s1">non_geom_fields</span> <span class="pl-k">else</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span>[<span class="pl-c1">0</span>]

<span class="pl-k">def</span> <span class="pl-en">auto_detect_county_field</span>(<span class="pl-s1">gdf</span>):
    <span class="pl-s">"""自动检测县名字段"""</span>
    <span class="pl-s1">county_keywords</span> <span class="pl-c1">=</span> [<span class="pl-s">'县'</span>, <span class="pl-s">'区'</span>, <span class="pl-s">'市'</span>, <span class="pl-s">'county'</span>, <span class="pl-s">'COUNTY'</span>, <span class="pl-s">'city'</span>, <span class="pl-s">'CITY'</span>]
    <span class="pl-k">for</span> <span class="pl-s1">field</span> <span class="pl-c1">in</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span>:
        <span class="pl-s1">field_lower</span> <span class="pl-c1">=</span> <span class="pl-en">str</span>(<span class="pl-s1">field</span>).<span class="pl-c1">lower</span>()
        <span class="pl-k">for</span> <span class="pl-s1">keyword</span> <span class="pl-c1">in</span> <span class="pl-s1">county_keywords</span>:
            <span class="pl-k">if</span> <span class="pl-s1">keyword</span>.<span class="pl-c1">lower</span>() <span class="pl-c1">in</span> <span class="pl-s1">field_lower</span>:
                <span class="pl-k">return</span> <span class="pl-s1">field</span>
    <span class="pl-s1">town_field</span> <span class="pl-c1">=</span> <span class="pl-en">auto_detect_town_field</span>(<span class="pl-s1">gdf</span>)
    <span class="pl-k">return</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span>[<span class="pl-c1">0</span>] <span class="pl-k">if</span> <span class="pl-s1">town_field</span> <span class="pl-c1">!=</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span>[<span class="pl-c1">0</span>] <span class="pl-k">else</span> <span class="pl-s">"未知县"</span>

<span class="pl-k">def</span> <span class="pl-en">clean_filename</span>(<span class="pl-s1">name</span>):
    <span class="pl-s">"""清理文件名"""</span>
    <span class="pl-k">import</span> <span class="pl-s1">re</span>
    <span class="pl-s1">illegal_chars</span> <span class="pl-c1">=</span> <span class="pl-s">r'[&lt;&gt;:"/\\|?*]'</span>
    <span class="pl-s1">cleaned</span> <span class="pl-c1">=</span> <span class="pl-s1">re</span>.<span class="pl-c1">sub</span>(<span class="pl-s1">illegal_chars</span>, <span class="pl-s">'_'</span>, <span class="pl-en">str</span>(<span class="pl-s1">name</span>))
    <span class="pl-s1">cleaned</span> <span class="pl-c1">=</span> <span class="pl-s1">cleaned</span>.<span class="pl-c1">strip</span>().<span class="pl-c1">strip</span>(<span class="pl-s">'.'</span>)
    <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">cleaned</span>) <span class="pl-c1">&gt;</span> <span class="pl-c1">100</span>:
        <span class="pl-s1">cleaned</span> <span class="pl-c1">=</span> <span class="pl-s1">cleaned</span>[:<span class="pl-c1">100</span>]
    <span class="pl-k">return</span> <span class="pl-s1">cleaned</span>

<span class="pl-k">def</span> <span class="pl-en">split_towns_to_individual_files</span>(<span class="pl-s1">shp_file</span>, <span class="pl-s1">output_dir</span>, <span class="pl-s1">n_parts</span><span class="pl-c1">=</span><span class="pl-c1">2</span>, <span class="pl-s1">method</span><span class="pl-c1">=</span><span class="pl-s">'grid'</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    将每个乡镇切分为N部分，并保存为单独的shp文件</span>
<span class="pl-s">    </span>
<span class="pl-s">    参数:</span>
<span class="pl-s">    shp_file: 输入的县级Shapefile文件路径</span>
<span class="pl-s">    output_dir: 输出目录</span>
<span class="pl-s">    n_parts: 切分数量 (2, 3, 4)</span>
<span class="pl-s">    method: 切分方法 ('grid', 'voronoi', 'radial')</span>
<span class="pl-s">    """</span>
    
    <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">exists</span>(<span class="pl-s1">output_dir</span>):
        <span class="pl-s1">os</span>.<span class="pl-c1">makedirs</span>(<span class="pl-s1">output_dir</span>)
    
    <span class="pl-k">try</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"正在读取文件: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">shp_file</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-s1">gdf</span> <span class="pl-c1">=</span> <span class="pl-s1">gpd</span>.<span class="pl-c1">read_file</span>(<span class="pl-s1">shp_file</span>)
        
        <span class="pl-s1">town_field</span> <span class="pl-c1">=</span> <span class="pl-en">auto_detect_town_field</span>(<span class="pl-s1">gdf</span>)
        <span class="pl-s1">county_field</span> <span class="pl-c1">=</span> <span class="pl-en">auto_detect_county_field</span>(<span class="pl-s1">gdf</span>)
        
        <span class="pl-en">print</span>(<span class="pl-s">f"检测到县字段: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">county_field</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"检测到乡镇字段: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town_field</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"切分数量: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">n_parts</span><span class="pl-kos">}</span></span>块"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"切分方法: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">method</span><span class="pl-kos">}</span></span>"</span>)
        
        <span class="pl-c"># 获取县名</span>
        <span class="pl-k">if</span> <span class="pl-s1">county_field</span> <span class="pl-c1">in</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span> <span class="pl-c1">and</span> <span class="pl-en">len</span>(<span class="pl-s1">gdf</span>[<span class="pl-s1">county_field</span>].<span class="pl-c1">unique</span>()) <span class="pl-c1">==</span> <span class="pl-c1">1</span>:
            <span class="pl-s1">county_name</span> <span class="pl-c1">=</span> <span class="pl-s1">gdf</span>[<span class="pl-s1">county_field</span>].<span class="pl-c1">iloc</span>[<span class="pl-c1">0</span>]
        <span class="pl-k">else</span>:
            <span class="pl-s1">county_name</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">basename</span>(<span class="pl-s1">shp_file</span>).<span class="pl-c1">replace</span>(<span class="pl-s">'.shp'</span>, <span class="pl-s">''</span>)
        
        <span class="pl-s1">county_name_clean</span> <span class="pl-c1">=</span> <span class="pl-en">clean_filename</span>(<span class="pl-s1">county_name</span>)
        <span class="pl-s1">county_dir</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">join</span>(<span class="pl-s1">output_dir</span>, <span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">county_name_clean</span><span class="pl-kos">}</span></span>_<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">n_parts</span><span class="pl-kos">}</span></span>等分"</span>)
        <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">exists</span>(<span class="pl-s1">county_dir</span>):
            <span class="pl-s1">os</span>.<span class="pl-c1">makedirs</span>(<span class="pl-s1">county_dir</span>)
        
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>开始切分并保存乡镇文件..."</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">60</span>)
        
        <span class="pl-s1">success_count</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>
        <span class="pl-s1">fail_count</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>
        <span class="pl-s1">total_files_created</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>
        
        <span class="pl-k">for</span> <span class="pl-s1">idx</span>, <span class="pl-s1">row</span> <span class="pl-c1">in</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">iterrows</span>():
            <span class="pl-s1">town_name</span> <span class="pl-c1">=</span> <span class="pl-s1">row</span>[<span class="pl-s1">town_field</span>]
            <span class="pl-s1">geometry</span> <span class="pl-c1">=</span> <span class="pl-s1">row</span>.<span class="pl-c1">geometry</span>
            
            <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>处理乡镇: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town_name</span><span class="pl-kos">}</span></span>"</span>)
            <span class="pl-s1">town_name_clean</span> <span class="pl-c1">=</span> <span class="pl-en">clean_filename</span>(<span class="pl-s1">town_name</span>)
            
            <span class="pl-k">if</span> <span class="pl-en">isinstance</span>(<span class="pl-s1">geometry</span>, <span class="pl-v">MultiPolygon</span>):
                <span class="pl-s1">polygons</span> <span class="pl-c1">=</span> <span class="pl-en">list</span>(<span class="pl-s1">geometry</span>.<span class="pl-c1">geoms</span>)
            <span class="pl-k">else</span>:
                <span class="pl-s1">polygons</span> <span class="pl-c1">=</span> [<span class="pl-s1">geometry</span>]
            
            <span class="pl-s1">all_parts</span> <span class="pl-c1">=</span> []
            
            <span class="pl-k">for</span> <span class="pl-s1">poly_idx</span>, <span class="pl-s1">polygon</span> <span class="pl-c1">in</span> <span class="pl-en">enumerate</span>(<span class="pl-s1">polygons</span>):
                <span class="pl-en">print</span>(<span class="pl-s">f"  切分第<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">poly_idx</span><span class="pl-c1">+</span><span class="pl-c1">1</span><span class="pl-kos">}</span></span>个多边形..."</span>)
                <span class="pl-s1">parts</span> <span class="pl-c1">=</span> <span class="pl-en">split_polygon_into_n_parts</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>, <span class="pl-s1">method</span>)
                <span class="pl-s1">all_parts</span>.<span class="pl-c1">extend</span>(<span class="pl-s1">parts</span>)
                <span class="pl-en">print</span>(<span class="pl-s">f"  ✓ 成功切分为 <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">len</span>(<span class="pl-s1">parts</span>)<span class="pl-kos">}</span></span> 部分"</span>)
            
            <span class="pl-c"># 为每个部分创建单独的shp文件</span>
            <span class="pl-k">for</span> <span class="pl-s1">i</span>, <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-en">enumerate</span>(<span class="pl-s1">all_parts</span>[:<span class="pl-s1">n_parts</span>], <span class="pl-c1">1</span>):  <span class="pl-c"># 只取前n_parts个部分</span>
                <span class="pl-s1">new_row</span> <span class="pl-c1">=</span> <span class="pl-s1">row</span>.<span class="pl-c1">copy</span>()
                <span class="pl-s1">new_row</span>.<span class="pl-c1">geometry</span> <span class="pl-c1">=</span> <span class="pl-s1">part</span>
                <span class="pl-s1">new_row</span>[<span class="pl-s">'SPLIT_ID'</span>] <span class="pl-c1">=</span> <span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">county_name</span><span class="pl-kos">}</span></span>-<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town_name</span><span class="pl-kos">}</span></span>-<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">i</span><span class="pl-kos">}</span></span>"</span>
                <span class="pl-s1">new_row</span>[<span class="pl-s">'ORIGINAL_TOWN'</span>] <span class="pl-c1">=</span> <span class="pl-s1">town_name</span>
                <span class="pl-s1">new_row</span>[<span class="pl-s">'SPLIT_PART'</span>] <span class="pl-c1">=</span> <span class="pl-s1">i</span>
                <span class="pl-s1">new_row</span>[<span class="pl-s">'COUNTY_NAME'</span>] <span class="pl-c1">=</span> <span class="pl-s1">county_name</span>
                <span class="pl-s1">new_row</span>[<span class="pl-s">'TOTAL_PARTS'</span>] <span class="pl-c1">=</span> <span class="pl-s1">n_parts</span>
                
                <span class="pl-s1">single_gdf</span> <span class="pl-c1">=</span> <span class="pl-s1">gpd</span>.<span class="pl-c1">GeoDataFrame</span>([<span class="pl-s1">new_row</span>], <span class="pl-s1">crs</span><span class="pl-c1">=</span><span class="pl-s1">gdf</span>.<span class="pl-c1">crs</span>)
                
                <span class="pl-s1">file_name</span> <span class="pl-c1">=</span> <span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">county_name_clean</span><span class="pl-kos">}</span></span>-<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town_name_clean</span><span class="pl-kos">}</span></span>-<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">i</span><span class="pl-kos">}</span></span>"</span>
                <span class="pl-s1">output_path</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">join</span>(<span class="pl-s1">county_dir</span>, <span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">file_name</span><span class="pl-kos">}</span></span>.shp"</span>)
                
                <span class="pl-k">try</span>:
                    <span class="pl-s1">single_gdf</span>.<span class="pl-c1">to_file</span>(<span class="pl-s1">output_path</span>, <span class="pl-s1">encoding</span><span class="pl-c1">=</span><span class="pl-s">'utf-8'</span>)
                    <span class="pl-s1">total_files_created</span> <span class="pl-c1">+=</span> <span class="pl-c1">1</span>
                    <span class="pl-en">print</span>(<span class="pl-s">f"  ✓ 保存: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">file_name</span><span class="pl-kos">}</span></span>.shp (面积: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">part</span>.<span class="pl-c1">area</span>:.2f<span class="pl-kos">}</span></span>)"</span>)
                <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
                    <span class="pl-en">print</span>(<span class="pl-s">f"  ✗ 保存失败: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">file_name</span><span class="pl-kos">}</span></span>.shp - <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
            
            <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">all_parts</span>) <span class="pl-c1">&gt;=</span> <span class="pl-s1">n_parts</span>:
                <span class="pl-s1">success_count</span> <span class="pl-c1">+=</span> <span class="pl-c1">1</span>
            <span class="pl-k">else</span>:
                <span class="pl-s1">fail_count</span> <span class="pl-c1">+=</span> <span class="pl-c1">1</span>
        
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>"</span> <span class="pl-c1">+</span> <span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">60</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"处理完成!"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">60</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"原始乡镇数量: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">len</span>(<span class="pl-s1">gdf</span>)<span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"成功切分: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">success_count</span><span class="pl-kos">}</span></span> 个乡镇"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"切分失败: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">fail_count</span><span class="pl-kos">}</span></span> 个乡镇"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"创建的shp文件总数: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">total_files_created</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"输出目录: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">county_dir</span><span class="pl-kos">}</span></span>"</span>)
        
        <span class="pl-c"># 显示生成的文件列表</span>
        <span class="pl-s1">shp_files</span> <span class="pl-c1">=</span> [<span class="pl-s1">f</span> <span class="pl-k">for</span> <span class="pl-s1">f</span> <span class="pl-c1">in</span> <span class="pl-s1">os</span>.<span class="pl-c1">listdir</span>(<span class="pl-s1">county_dir</span>) <span class="pl-k">if</span> <span class="pl-s1">f</span>.<span class="pl-c1">endswith</span>(<span class="pl-s">'.shp'</span>)]
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>生成的文件列表 (前20个):"</span>)
        <span class="pl-k">for</span> <span class="pl-s1">i</span>, <span class="pl-s1">file</span> <span class="pl-c1">in</span> <span class="pl-en">enumerate</span>(<span class="pl-s1">shp_files</span>[:<span class="pl-c1">20</span>], <span class="pl-c1">1</span>):
            <span class="pl-en">print</span>(<span class="pl-s">f"  <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">i</span><span class="pl-kos">}</span></span>. <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">file</span><span class="pl-kos">}</span></span>"</span>)
        
        <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">shp_files</span>) <span class="pl-c1">&gt;</span> <span class="pl-c1">20</span>:
            <span class="pl-en">print</span>(<span class="pl-s">f"  ... 还有 <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">len</span>(<span class="pl-s1">shp_files</span>) <span class="pl-c1">-</span> <span class="pl-c1">20</span><span class="pl-kos">}</span></span> 个文件"</span>)
        
        <span class="pl-k">return</span> <span class="pl-s1">total_files_created</span>
        
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"处理过程中发生错误: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">import</span> <span class="pl-s1">traceback</span>
        <span class="pl-s1">traceback</span>.<span class="pl-c1">print_exc</span>()
        <span class="pl-k">return</span> <span class="pl-c1">0</span>

<span class="pl-c"># 使用示例</span>
<span class="pl-k">if</span> <span class="pl-s1">__name__</span> <span class="pl-c1">==</span> <span class="pl-s">"__main__"</span>:
    <span class="pl-s1">input_shp</span> <span class="pl-c1">=</span> <span class="pl-s">"黔东南苗族侗族自治州_县.shp"</span>
    <span class="pl-s1">output_directory</span> <span class="pl-c1">=</span> <span class="pl-s">"乡镇切分结果"</span>
    
    <span class="pl-c"># 可以选择切分数量和切分方法</span>
    <span class="pl-s1">n_parts</span> <span class="pl-c1">=</span> <span class="pl-c1">3</span>  <span class="pl-c"># 可以改为 2, 3, 4</span>
    <span class="pl-s1">method</span> <span class="pl-c1">=</span> <span class="pl-s">'grid'</span>  <span class="pl-c"># 可以改为 'grid', 'voronoi', 'radial'</span>
    
    <span class="pl-en">print</span>(<span class="pl-s">f"开始自动切分乡镇为 <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">n_parts</span><span class="pl-kos">}</span></span> 块..."</span>)
    <span class="pl-en">print</span>(<span class="pl-s">"="</span><span class="pl-c1">*</span><span class="pl-c1">60</span>)
    
    <span class="pl-s1">files_created</span> <span class="pl-c1">=</span> <span class="pl-en">split_towns_to_individual_files</span>(
        <span class="pl-s1">shp_file</span><span class="pl-c1">=</span><span class="pl-s1">input_shp</span>,
        <span class="pl-s1">output_dir</span><span class="pl-c1">=</span><span class="pl-s1">output_directory</span>,
        <span class="pl-s1">n_parts</span><span class="pl-c1">=</span><span class="pl-s1">n_parts</span>,
        <span class="pl-s1">method</span><span class="pl-c1">=</span><span class="pl-s1">method</span>
    )
    
    <span class="pl-k">if</span> <span class="pl-s1">files_created</span> <span class="pl-c1">&gt;</span> <span class="pl-c1">0</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>处理完成！总共生成了 <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">files_created</span><span class="pl-kos">}</span></span> 个shp文件"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"文件命名格式: 县名-镇名-编号.shp"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"示例: 某县-某镇-1.shp, 某县-某镇-2.shp, 某县-某镇-3.shp"</span>)</pre></div>
<h4>效果</h4>
<p><a target="_blank" rel="noopener noreferrer" href=""><img alt="image-20251107164421396" style="max-width: 100%;"></a></p>
<h2>切分shp，切分镇（多块）</h2>
<p>首先需要有省市县镇四级行政区划的数据，我的数据来源：点点GIS公众号，<a href="https://www.bilibili.com/video/BV1eR4y1m7Pm/?spm_id_from=333.337.search-card.all.click&amp;vd_source=c0981ce15cd64f30336d91bc5a665dee" rel="nofollow">哔哩哔哩</a>—&gt;适合切分多个乡镇</p>
<p>通过网盘分享的文件：2021年7月中国乡镇行政区划shp.rar<br>
链接: <a href="https://pan.baidu.com/s/1bnG5ShtNTe0uL3KAVMf6Jg?pwd=nefu" rel="nofollow">https://pan.baidu.com/s/1bnG5ShtNTe0uL3KAVMf6Jg?pwd=nefu</a> 提取码: nefu<br>
--来自百度网盘超级会员v4的分享</p>
<p>或者到<a href="https://map.ruiduobao.com/" rel="nofollow">五级区划查询与下载</a>挨个搜索，要麻烦一些—&gt;适合切分单个乡镇</p>
<h3>代码</h3>
<h4>版本1，整个省的乡镇边界切割</h4>
<div class="highlight highlight-source-python"><pre class="notranslate"><span class="pl-k">import</span> <span class="pl-s1">geopandas</span> <span class="pl-k">as</span> <span class="pl-s1">gpd</span>
<span class="pl-k">import</span> <span class="pl-s1">pandas</span> <span class="pl-k">as</span> <span class="pl-s1">pd</span>
<span class="pl-k">import</span> <span class="pl-s1">numpy</span> <span class="pl-k">as</span> <span class="pl-s1">np</span>
<span class="pl-k">from</span> <span class="pl-s1">shapely</span>.<span class="pl-s1">geometry</span> <span class="pl-k">import</span> <span class="pl-v">Polygon</span>, <span class="pl-v">MultiPolygon</span>, <span class="pl-v">LineString</span>
<span class="pl-k">from</span> <span class="pl-s1">shapely</span>.<span class="pl-s1">ops</span> <span class="pl-k">import</span> <span class="pl-s1">split</span>
<span class="pl-k">import</span> <span class="pl-s1">os</span>
<span class="pl-k">import</span> <span class="pl-s1">math</span>
<span class="pl-k">import</span> <span class="pl-s1">warnings</span>
<span class="pl-k">from</span> <span class="pl-s1">tqdm</span> <span class="pl-k">import</span> <span class="pl-s1">tqdm</span>

<span class="pl-c"># 忽略所有警告</span>
<span class="pl-s1">warnings</span>.<span class="pl-c1">filterwarnings</span>(<span class="pl-s">'ignore'</span>)

<span class="pl-k">def</span> <span class="pl-en">read_shp_with_encoding</span>(<span class="pl-s1">shp_file</span>):
    <span class="pl-s">"""尝试多种编码方式读取SHP文件"""</span>
    <span class="pl-s1">encodings</span> <span class="pl-c1">=</span> [<span class="pl-s">'gbk'</span>, <span class="pl-s">'gb2312'</span>, <span class="pl-s">'utf-8'</span>, <span class="pl-s">'latin1'</span>, <span class="pl-s">'cp936'</span>, <span class="pl-s">'big5'</span>]
    
    <span class="pl-k">for</span> <span class="pl-s1">encoding</span> <span class="pl-c1">in</span> <span class="pl-s1">encodings</span>:
        <span class="pl-k">try</span>:
            <span class="pl-s1">gdf</span> <span class="pl-c1">=</span> <span class="pl-s1">gpd</span>.<span class="pl-c1">read_file</span>(<span class="pl-s1">shp_file</span>, <span class="pl-s1">encoding</span><span class="pl-c1">=</span><span class="pl-s1">encoding</span>)
            <span class="pl-k">return</span> <span class="pl-s1">gdf</span>, <span class="pl-s1">encoding</span>
        <span class="pl-k">except</span>:
            <span class="pl-k">continue</span>
    
    <span class="pl-k">try</span>:
        <span class="pl-s1">gdf</span> <span class="pl-c1">=</span> <span class="pl-s1">gpd</span>.<span class="pl-c1">read_file</span>(<span class="pl-s1">shp_file</span>)
        <span class="pl-k">return</span> <span class="pl-s1">gdf</span>, <span class="pl-s">'unknown'</span>
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"❌ 读取文件失败: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">return</span> <span class="pl-c1">None</span>, <span class="pl-c1">None</span>

<span class="pl-k">def</span> <span class="pl-en">split_polygon_into_n_parts</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span><span class="pl-c1">=</span><span class="pl-c1">2</span>):
    <span class="pl-s">"""将多边形切分为N部分"""</span>
    <span class="pl-k">try</span>:
        <span class="pl-k">if</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">is_empty</span>:
            <span class="pl-k">return</span> [<span class="pl-s1">polygon</span>] <span class="pl-c1">*</span> <span class="pl-s1">n_parts</span>
            
        <span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>, <span class="pl-s1">maxx</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">=</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">bounds</span>
        <span class="pl-s1">width</span> <span class="pl-c1">=</span> <span class="pl-s1">maxx</span> <span class="pl-c1">-</span> <span class="pl-s1">minx</span>
        <span class="pl-s1">height</span> <span class="pl-c1">=</span> <span class="pl-s1">maxy</span> <span class="pl-c1">-</span> <span class="pl-s1">miny</span>
        
        <span class="pl-s1">parts</span> <span class="pl-c1">=</span> []
        
        <span class="pl-k">if</span> <span class="pl-s1">n_parts</span> <span class="pl-c1">==</span> <span class="pl-c1">2</span>:
            <span class="pl-k">if</span> <span class="pl-s1">width</span> <span class="pl-c1">&gt;</span> <span class="pl-s1">height</span>:
                <span class="pl-s1">mid_x</span> <span class="pl-c1">=</span> (<span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-s1">maxx</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
                <span class="pl-s1">split_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">mid_x</span>, <span class="pl-s1">miny</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>)])
            <span class="pl-k">else</span>:
                <span class="pl-s1">mid_y</span> <span class="pl-c1">=</span> (<span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-s1">maxy</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
                <span class="pl-s1">split_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">minx</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>, <span class="pl-s1">mid_y</span>), (<span class="pl-s1">maxx</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>, <span class="pl-s1">mid_y</span>)])
            
            <span class="pl-s1">split_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">split_line</span>)
            <span class="pl-s1">parts</span> <span class="pl-c1">=</span> [<span class="pl-s1">part</span> <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">split_parts</span>.<span class="pl-c1">geoms</span> <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>]
            
        <span class="pl-k">elif</span> <span class="pl-s1">n_parts</span> <span class="pl-c1">==</span> <span class="pl-c1">3</span>:
            <span class="pl-k">if</span> <span class="pl-s1">width</span> <span class="pl-c1">&gt;</span> <span class="pl-s1">height</span>:
                <span class="pl-s1">x1</span> <span class="pl-c1">=</span> <span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-s1">width</span> <span class="pl-c1">/</span> <span class="pl-c1">3</span>
                <span class="pl-s1">x2</span> <span class="pl-c1">=</span> <span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-c1">2</span> <span class="pl-c1">*</span> <span class="pl-s1">width</span> <span class="pl-c1">/</span> <span class="pl-c1">3</span>
                <span class="pl-s1">split_line1</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">x1</span>, <span class="pl-s1">miny</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>), (<span class="pl-s1">x1</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>)])
                <span class="pl-s1">split_line2</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">x2</span>, <span class="pl-s1">miny</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>), (<span class="pl-s1">x2</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>)])
            <span class="pl-k">else</span>:
                <span class="pl-s1">y1</span> <span class="pl-c1">=</span> <span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-s1">height</span> <span class="pl-c1">/</span> <span class="pl-c1">3</span>
                <span class="pl-s1">y2</span> <span class="pl-c1">=</span> <span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-c1">2</span> <span class="pl-c1">*</span> <span class="pl-s1">height</span> <span class="pl-c1">/</span> <span class="pl-c1">3</span>
                <span class="pl-s1">split_line1</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">minx</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>, <span class="pl-s1">y1</span>), (<span class="pl-s1">maxx</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>, <span class="pl-s1">y1</span>)])
                <span class="pl-s1">split_line2</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">minx</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>, <span class="pl-s1">y2</span>), (<span class="pl-s1">maxx</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>, <span class="pl-s1">y2</span>)])
            
            <span class="pl-s1">temp_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">split_line1</span>)
            <span class="pl-s1">parts</span> <span class="pl-c1">=</span> []
            <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">temp_parts</span>.<span class="pl-c1">geoms</span>:
                <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>:
                    <span class="pl-s1">sub_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">part</span>, <span class="pl-s1">split_line2</span>)
                    <span class="pl-s1">parts</span>.<span class="pl-c1">extend</span>([<span class="pl-s1">p</span> <span class="pl-k">for</span> <span class="pl-s1">p</span> <span class="pl-c1">in</span> <span class="pl-s1">sub_parts</span>.<span class="pl-c1">geoms</span> <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">p</span>.<span class="pl-c1">is_empty</span>])
                    
        <span class="pl-k">elif</span> <span class="pl-s1">n_parts</span> <span class="pl-c1">==</span> <span class="pl-c1">4</span>:
            <span class="pl-s1">mid_x</span> <span class="pl-c1">=</span> (<span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-s1">maxx</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
            <span class="pl-s1">mid_y</span> <span class="pl-c1">=</span> (<span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-s1">maxy</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
            
            <span class="pl-s1">vert_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">mid_x</span>, <span class="pl-s1">miny</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>)])
            <span class="pl-s1">horz_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">minx</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>, <span class="pl-s1">mid_y</span>), (<span class="pl-s1">maxx</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>, <span class="pl-s1">mid_y</span>)])
            
            <span class="pl-s1">temp_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">vert_line</span>)
            <span class="pl-s1">parts</span> <span class="pl-c1">=</span> []
            <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">temp_parts</span>.<span class="pl-c1">geoms</span>:
                <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>:
                    <span class="pl-s1">sub_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">part</span>, <span class="pl-s1">horz_line</span>)
                    <span class="pl-s1">parts</span>.<span class="pl-c1">extend</span>([<span class="pl-s1">p</span> <span class="pl-k">for</span> <span class="pl-s1">p</span> <span class="pl-c1">in</span> <span class="pl-s1">sub_parts</span>.<span class="pl-c1">geoms</span> <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">p</span>.<span class="pl-c1">is_empty</span>])
        
        <span class="pl-s1">valid_parts</span> <span class="pl-c1">=</span> [<span class="pl-s1">part</span> <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">parts</span> <span class="pl-k">if</span> <span class="pl-en">isinstance</span>(<span class="pl-s1">part</span>, (<span class="pl-v">Polygon</span>, <span class="pl-v">MultiPolygon</span>)) <span class="pl-c1">and</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>]
        
        <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">valid_parts</span>) <span class="pl-c1">&gt;=</span> <span class="pl-s1">n_parts</span>:
            <span class="pl-s1">valid_parts</span>.<span class="pl-c1">sort</span>(<span class="pl-s1">key</span><span class="pl-c1">=</span><span class="pl-k">lambda</span> <span class="pl-s1">x</span>: <span class="pl-s1">x</span>.<span class="pl-c1">area</span>, <span class="pl-s1">reverse</span><span class="pl-c1">=</span><span class="pl-c1">True</span>)
            <span class="pl-k">return</span> <span class="pl-s1">valid_parts</span>[:<span class="pl-s1">n_parts</span>]
        <span class="pl-k">else</span>:
            <span class="pl-k">return</span> [<span class="pl-s1">polygon</span>] <span class="pl-c1">*</span> <span class="pl-s1">n_parts</span>
            
    <span class="pl-k">except</span> <span class="pl-v">Exception</span>:
        <span class="pl-k">return</span> [<span class="pl-s1">polygon</span>] <span class="pl-c1">*</span> <span class="pl-s1">n_parts</span>

<span class="pl-k">def</span> <span class="pl-en">auto_detect_admin_fields</span>(<span class="pl-s1">gdf</span>):
    <span class="pl-s">"""自动检测行政区划字段"""</span>
    <span class="pl-s1">admin_keywords</span> <span class="pl-c1">=</span> {
        <span class="pl-s">'name'</span>: [<span class="pl-s">'name'</span>, <span class="pl-s">'名称'</span>, <span class="pl-s">'地名'</span>]
    }
    
    <span class="pl-s1">detected_fields</span> <span class="pl-c1">=</span> {}
    
    <span class="pl-k">for</span> <span class="pl-s1">field</span> <span class="pl-c1">in</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span>:
        <span class="pl-k">if</span> <span class="pl-s1">field</span> <span class="pl-c1">==</span> <span class="pl-s">'geometry'</span>:
            <span class="pl-k">continue</span>
            
        <span class="pl-s1">field_lower</span> <span class="pl-c1">=</span> <span class="pl-s1">field</span>.<span class="pl-c1">lower</span>()
        <span class="pl-k">for</span> <span class="pl-s1">field_type</span>, <span class="pl-s1">keywords</span> <span class="pl-c1">in</span> <span class="pl-s1">admin_keywords</span>.<span class="pl-c1">items</span>():
            <span class="pl-k">for</span> <span class="pl-s1">keyword</span> <span class="pl-c1">in</span> <span class="pl-s1">keywords</span>:
                <span class="pl-k">if</span> <span class="pl-s1">keyword</span>.<span class="pl-c1">lower</span>() <span class="pl-c1">in</span> <span class="pl-s1">field_lower</span>:
                    <span class="pl-k">if</span> <span class="pl-s1">field_type</span> <span class="pl-c1"><span class="pl-c1">not</span> <span class="pl-c1">in</span></span> <span class="pl-s1">detected_fields</span>:
                        <span class="pl-s1">detected_fields</span>[<span class="pl-s1">field_type</span>] <span class="pl-c1">=</span> <span class="pl-s1">field</span>
                    <span class="pl-k">break</span>
    
    <span class="pl-k">if</span> <span class="pl-s">'name'</span> <span class="pl-c1"><span class="pl-c1">not</span> <span class="pl-c1">in</span></span> <span class="pl-s1">detected_fields</span>:
        <span class="pl-s1">non_geom_fields</span> <span class="pl-c1">=</span> [<span class="pl-s1">col</span> <span class="pl-k">for</span> <span class="pl-s1">col</span> <span class="pl-c1">in</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span> <span class="pl-k">if</span> <span class="pl-s1">col</span> <span class="pl-c1">!=</span> <span class="pl-s">'geometry'</span>]
        <span class="pl-k">if</span> <span class="pl-s1">non_geom_fields</span>:
            <span class="pl-s1">detected_fields</span>[<span class="pl-s">'name'</span>] <span class="pl-c1">=</span> <span class="pl-s1">non_geom_fields</span>[<span class="pl-c1">0</span>]
    
    <span class="pl-k">return</span> <span class="pl-s1">detected_fields</span>

<span class="pl-k">def</span> <span class="pl-en">clean_town_name</span>(<span class="pl-s1">name</span>):
    <span class="pl-s">"""清理乡镇名称"""</span>
    <span class="pl-k">import</span> <span class="pl-s1">re</span>
    <span class="pl-k">if</span> <span class="pl-s1">name</span> <span class="pl-c1">is</span> <span class="pl-c1">None</span>:
        <span class="pl-k">return</span> <span class="pl-s">"未知乡镇"</span>
    
    <span class="pl-s1">illegal_chars</span> <span class="pl-c1">=</span> <span class="pl-s">r'[&lt;&gt;:"/\\|?*]'</span>
    <span class="pl-s1">cleaned</span> <span class="pl-c1">=</span> <span class="pl-s1">re</span>.<span class="pl-c1">sub</span>(<span class="pl-s1">illegal_chars</span>, <span class="pl-s">''</span>, <span class="pl-en">str</span>(<span class="pl-s1">name</span>))
    <span class="pl-s1">cleaned</span> <span class="pl-c1">=</span> <span class="pl-s1">cleaned</span>.<span class="pl-c1">strip</span>().<span class="pl-c1">strip</span>(<span class="pl-s">'.'</span>)
    
    <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">cleaned</span>) <span class="pl-c1">&gt;</span> <span class="pl-c1">50</span>:
        <span class="pl-s1">cleaned</span> <span class="pl-c1">=</span> <span class="pl-s1">cleaned</span>[:<span class="pl-c1">50</span>]
    
    <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">cleaned</span>:
        <span class="pl-s1">cleaned</span> <span class="pl-c1">=</span> <span class="pl-s">"未知乡镇"</span>
    
    <span class="pl-k">return</span> <span class="pl-s1">cleaned</span>

<span class="pl-k">def</span> <span class="pl-en">get_field_value</span>(<span class="pl-s1">row</span>, <span class="pl-s1">field_name</span>):
    <span class="pl-s">"""安全获取字段值"""</span>
    <span class="pl-k">if</span> <span class="pl-s1">field_name</span> <span class="pl-c1">and</span> <span class="pl-s1">field_name</span> <span class="pl-c1">in</span> <span class="pl-s1">row</span>:
        <span class="pl-s1">value</span> <span class="pl-c1">=</span> <span class="pl-s1">row</span>[<span class="pl-s1">field_name</span>]
        <span class="pl-k">return</span> <span class="pl-s1">value</span> <span class="pl-k">if</span> <span class="pl-s1">pd</span>.<span class="pl-c1">notna</span>(<span class="pl-s1">value</span>) <span class="pl-c1">and</span> <span class="pl-s1">value</span> <span class="pl-c1">!=</span> <span class="pl-s">""</span> <span class="pl-k">else</span> <span class="pl-c1">None</span>
    <span class="pl-k">return</span> <span class="pl-c1">None</span>

<span class="pl-k">def</span> <span class="pl-en">split_all_towns_silent</span>(<span class="pl-s1">town_shp_file</span>, <span class="pl-s1">output_base_dir</span>, <span class="pl-s1">n_parts</span><span class="pl-c1">=</span><span class="pl-c1">2</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    静默版本：批量切分所有乡镇，忽略警告</span>
<span class="pl-s">    """</span>
    <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">exists</span>(<span class="pl-s1">output_base_dir</span>):
        <span class="pl-s1">os</span>.<span class="pl-c1">makedirs</span>(<span class="pl-s1">output_base_dir</span>)
    
    <span class="pl-k">try</span>:
        <span class="pl-en">print</span>(<span class="pl-s">"📥 读取乡镇数据..."</span>)
        <span class="pl-s1">town_gdf</span>, <span class="pl-s1">encoding</span> <span class="pl-c1">=</span> <span class="pl-en">read_shp_with_encoding</span>(<span class="pl-s1">town_shp_file</span>)
        
        <span class="pl-k">if</span> <span class="pl-s1">town_gdf</span> <span class="pl-c1">is</span> <span class="pl-c1">None</span>:
            <span class="pl-en">print</span>(<span class="pl-s">"❌ 无法读取乡镇文件"</span>)
            <span class="pl-k">return</span> <span class="pl-c1">0</span>
        
        <span class="pl-s1">town_fields</span> <span class="pl-c1">=</span> <span class="pl-en">auto_detect_admin_fields</span>(<span class="pl-s1">town_gdf</span>)
        
        <span class="pl-en">print</span>(<span class="pl-s">f"📊 找到 <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">len</span>(<span class="pl-s1">town_gdf</span>)<span class="pl-kos">}</span></span> 个乡镇"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"🔪 开始切分为 <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">n_parts</span><span class="pl-kos">}</span></span> 块..."</span>)
        
        <span class="pl-s1">total_files_created</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>
        <span class="pl-s1">success_count</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>
        
        <span class="pl-c"># 使用进度条</span>
        <span class="pl-k">with</span> <span class="pl-en">tqdm</span>(<span class="pl-s1">total</span><span class="pl-c1">=</span><span class="pl-en">len</span>(<span class="pl-s1">town_gdf</span>), <span class="pl-s1">desc</span><span class="pl-c1">=</span><span class="pl-s">"切分进度"</span>) <span class="pl-k">as</span> <span class="pl-s1">pbar</span>:
            <span class="pl-k">for</span> <span class="pl-s1">idx</span>, <span class="pl-s1">row</span> <span class="pl-c1">in</span> <span class="pl-s1">town_gdf</span>.<span class="pl-c1">iterrows</span>():
                <span class="pl-s1">town_name</span> <span class="pl-c1">=</span> <span class="pl-en">get_field_value</span>(<span class="pl-s1">row</span>, <span class="pl-s1">town_fields</span>.<span class="pl-c1">get</span>(<span class="pl-s">'name'</span>)) <span class="pl-c1">or</span> <span class="pl-s">f"乡镇_<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">idx</span><span class="pl-c1">+</span><span class="pl-c1">1</span><span class="pl-kos">}</span></span>"</span>
                <span class="pl-s1">town_name_clean</span> <span class="pl-c1">=</span> <span class="pl-en">clean_town_name</span>(<span class="pl-s1">town_name</span>)
                
                <span class="pl-s1">geometry</span> <span class="pl-c1">=</span> <span class="pl-s1">row</span>.<span class="pl-c1">geometry</span>
                <span class="pl-k">if</span> <span class="pl-en">isinstance</span>(<span class="pl-s1">geometry</span>, <span class="pl-v">MultiPolygon</span>):
                    <span class="pl-s1">polygons</span> <span class="pl-c1">=</span> <span class="pl-en">list</span>(<span class="pl-s1">geometry</span>.<span class="pl-c1">geoms</span>)
                <span class="pl-k">else</span>:
                    <span class="pl-s1">polygons</span> <span class="pl-c1">=</span> [<span class="pl-s1">geometry</span>]
                
                <span class="pl-c"># 创建乡镇目录</span>
                <span class="pl-s1">town_dir</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">join</span>(<span class="pl-s1">output_base_dir</span>, <span class="pl-s1">town_name_clean</span>)
                <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">exists</span>(<span class="pl-s1">town_dir</span>):
                    <span class="pl-s1">os</span>.<span class="pl-c1">makedirs</span>(<span class="pl-s1">town_dir</span>)
                
                <span class="pl-c"># 切分每个多边形</span>
                <span class="pl-s1">all_parts</span> <span class="pl-c1">=</span> []
                <span class="pl-k">for</span> <span class="pl-s1">polygon</span> <span class="pl-c1">in</span> <span class="pl-s1">polygons</span>:
                    <span class="pl-s1">parts</span> <span class="pl-c1">=</span> <span class="pl-en">split_polygon_into_n_parts</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>)
                    <span class="pl-s1">all_parts</span>.<span class="pl-c1">extend</span>(<span class="pl-s1">parts</span>)
                
                <span class="pl-c"># 保存切分结果</span>
                <span class="pl-s1">parts_created</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>
                <span class="pl-k">for</span> <span class="pl-s1">i</span>, <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-en">enumerate</span>(<span class="pl-s1">all_parts</span>[:<span class="pl-s1">n_parts</span>], <span class="pl-c1">1</span>):
                    <span class="pl-s1">new_row</span> <span class="pl-c1">=</span> <span class="pl-s1">row</span>.<span class="pl-c1">copy</span>()
                    <span class="pl-s1">new_row</span>.<span class="pl-c1">geometry</span> <span class="pl-c1">=</span> <span class="pl-s1">part</span>
                    
                    <span class="pl-c"># 添加切分信息</span>
                    <span class="pl-s1">new_row</span>[<span class="pl-s">'SPLIT_ID'</span>] <span class="pl-c1">=</span> <span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town_name_clean</span><span class="pl-kos">}</span></span>-<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">i</span><span class="pl-kos">}</span></span>"</span>
                    <span class="pl-s1">new_row</span>[<span class="pl-s">'ORIGINAL_TOWN'</span>] <span class="pl-c1">=</span> <span class="pl-s1">town_name</span>
                    <span class="pl-s1">new_row</span>[<span class="pl-s">'SPLIT_PART'</span>] <span class="pl-c1">=</span> <span class="pl-s1">i</span>
                    <span class="pl-s1">new_row</span>[<span class="pl-s">'TOTAL_PARTS'</span>] <span class="pl-c1">=</span> <span class="pl-s1">n_parts</span>
                    
                    <span class="pl-s1">single_gdf</span> <span class="pl-c1">=</span> <span class="pl-s1">gpd</span>.<span class="pl-c1">GeoDataFrame</span>([<span class="pl-s1">new_row</span>], <span class="pl-s1">geometry</span><span class="pl-c1">=</span><span class="pl-s">'geometry'</span>, <span class="pl-s1">crs</span><span class="pl-c1">=</span><span class="pl-s1">town_gdf</span>.<span class="pl-c1">crs</span>)
                    
                    <span class="pl-s1">file_name</span> <span class="pl-c1">=</span> <span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town_name_clean</span><span class="pl-kos">}</span></span>-<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">i</span><span class="pl-kos">}</span></span>"</span>
                    <span class="pl-s1">output_path</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">join</span>(<span class="pl-s1">town_dir</span>, <span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">file_name</span><span class="pl-kos">}</span></span>.shp"</span>)
                    
                    <span class="pl-k">try</span>:
                        <span class="pl-s1">single_gdf</span>.<span class="pl-c1">to_file</span>(<span class="pl-s1">output_path</span>, <span class="pl-s1">encoding</span><span class="pl-c1">=</span><span class="pl-s">'utf-8'</span>)
                        <span class="pl-s1">total_files_created</span> <span class="pl-c1">+=</span> <span class="pl-c1">1</span>
                        <span class="pl-s1">parts_created</span> <span class="pl-c1">+=</span> <span class="pl-c1">1</span>
                    <span class="pl-k">except</span> <span class="pl-v">Exception</span>:
                        <span class="pl-k">pass</span>
                
                <span class="pl-k">if</span> <span class="pl-s1">parts_created</span> <span class="pl-c1">&gt;</span> <span class="pl-c1">0</span>:
                    <span class="pl-s1">success_count</span> <span class="pl-c1">+=</span> <span class="pl-c1">1</span>
                
                <span class="pl-s1">pbar</span>.<span class="pl-c1">update</span>(<span class="pl-c1">1</span>)
        
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>🎉 切分完成!"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"📊 统计信息:"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"  • 总乡镇数量: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">len</span>(<span class="pl-s1">town_gdf</span>)<span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"  • 成功处理: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">success_count</span><span class="pl-kos">}</span></span> 个乡镇"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"  • 创建文件: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">total_files_created</span><span class="pl-kos">}</span></span> 个"</span>)
        
        <span class="pl-k">return</span> <span class="pl-s1">total_files_created</span>
        
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"❌ 处理失败: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">return</span> <span class="pl-c1">0</span>

<span class="pl-c"># 使用示例</span>
<span class="pl-k">if</span> <span class="pl-s1">__name__</span> <span class="pl-c1">==</span> <span class="pl-s">"__main__"</span>:
    <span class="pl-c"># 文件路径配置</span>
    <span class="pl-s1">town_shp_file</span> <span class="pl-c1">=</span> <span class="pl-s">"data/贵州省/贵州省_乡镇边界.shp"</span>
    <span class="pl-s1">output_base_dir</span> <span class="pl-c1">=</span> <span class="pl-s">"贵州省乡镇切分结果"</span>
    <span class="pl-s1">n_parts</span> <span class="pl-c1">=</span> <span class="pl-c1">4</span>
    
    <span class="pl-en">print</span>(<span class="pl-s">"🗺️  乡镇边界切分工具 (静默版)"</span>)
    <span class="pl-en">print</span>(<span class="pl-s">"="</span> <span class="pl-c1">*</span> <span class="pl-c1">40</span>)
    
    <span class="pl-s1">files_created</span> <span class="pl-c1">=</span> <span class="pl-en">split_all_towns_silent</span>(
        <span class="pl-s1">town_shp_file</span><span class="pl-c1">=</span><span class="pl-s1">town_shp_file</span>,
        <span class="pl-s1">output_base_dir</span><span class="pl-c1">=</span><span class="pl-s1">output_base_dir</span>,
        <span class="pl-s1">n_parts</span><span class="pl-c1">=</span><span class="pl-s1">n_parts</span>
    )
    
    <span class="pl-k">if</span> <span class="pl-s1">files_created</span> <span class="pl-c1">&gt;</span> <span class="pl-c1">0</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"✅ 任务完成! 生成 <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">files_created</span><span class="pl-kos">}</span></span> 个文件"</span>)
    <span class="pl-k">else</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"❌ 处理失败"</span>)</pre></div>
<h4>版本2，单个乡镇切割</h4>
<div class="highlight highlight-source-python"><pre class="notranslate"><span class="pl-k">import</span> <span class="pl-s1">geopandas</span> <span class="pl-k">as</span> <span class="pl-s1">gpd</span>
<span class="pl-k">import</span> <span class="pl-s1">pandas</span> <span class="pl-k">as</span> <span class="pl-s1">pd</span>
<span class="pl-k">import</span> <span class="pl-s1">numpy</span> <span class="pl-k">as</span> <span class="pl-s1">np</span>
<span class="pl-k">from</span> <span class="pl-s1">shapely</span>.<span class="pl-s1">geometry</span> <span class="pl-k">import</span> <span class="pl-v">Polygon</span>, <span class="pl-v">MultiPolygon</span>, <span class="pl-v">LineString</span>
<span class="pl-k">from</span> <span class="pl-s1">shapely</span>.<span class="pl-s1">ops</span> <span class="pl-k">import</span> <span class="pl-s1">split</span>
<span class="pl-k">import</span> <span class="pl-s1">os</span>
<span class="pl-k">import</span> <span class="pl-s1">math</span>
<span class="pl-k">import</span> <span class="pl-s1">warnings</span>
<span class="pl-k">from</span> <span class="pl-s1">tqdm</span> <span class="pl-k">import</span> <span class="pl-s1">tqdm</span>

<span class="pl-c"># 忽略所有警告</span>
<span class="pl-s1">warnings</span>.<span class="pl-c1">filterwarnings</span>(<span class="pl-s">'ignore'</span>)

<span class="pl-k">def</span> <span class="pl-en">read_shp_with_encoding</span>(<span class="pl-s1">shp_file</span>):
    <span class="pl-s">"""尝试多种编码方式读取SHP文件"""</span>
    <span class="pl-s1">encodings</span> <span class="pl-c1">=</span> [<span class="pl-s">'gbk'</span>, <span class="pl-s">'gb2312'</span>, <span class="pl-s">'utf-8'</span>, <span class="pl-s">'latin1'</span>, <span class="pl-s">'cp936'</span>, <span class="pl-s">'big5'</span>]
    
    <span class="pl-k">for</span> <span class="pl-s1">encoding</span> <span class="pl-c1">in</span> <span class="pl-s1">encodings</span>:
        <span class="pl-k">try</span>:
            <span class="pl-s1">gdf</span> <span class="pl-c1">=</span> <span class="pl-s1">gpd</span>.<span class="pl-c1">read_file</span>(<span class="pl-s1">shp_file</span>, <span class="pl-s1">encoding</span><span class="pl-c1">=</span><span class="pl-s1">encoding</span>)
            <span class="pl-k">return</span> <span class="pl-s1">gdf</span>, <span class="pl-s1">encoding</span>
        <span class="pl-k">except</span>:
            <span class="pl-k">continue</span>
    
    <span class="pl-k">try</span>:
        <span class="pl-s1">gdf</span> <span class="pl-c1">=</span> <span class="pl-s1">gpd</span>.<span class="pl-c1">read_file</span>(<span class="pl-s1">shp_file</span>)
        <span class="pl-k">return</span> <span class="pl-s1">gdf</span>, <span class="pl-s">'unknown'</span>
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"❌ 读取文件失败: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">return</span> <span class="pl-c1">None</span>, <span class="pl-c1">None</span>

<span class="pl-k">def</span> <span class="pl-en">split_polygon_into_n_parts</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span><span class="pl-c1">=</span><span class="pl-c1">2</span>):
    <span class="pl-s">"""将多边形切分为N部分"""</span>
    <span class="pl-k">try</span>:
        <span class="pl-k">if</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">is_empty</span>:
            <span class="pl-k">return</span> [<span class="pl-s1">polygon</span>] <span class="pl-c1">*</span> <span class="pl-s1">n_parts</span>
            
        <span class="pl-s1">minx</span>, <span class="pl-s1">miny</span>, <span class="pl-s1">maxx</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">=</span> <span class="pl-s1">polygon</span>.<span class="pl-c1">bounds</span>
        <span class="pl-s1">width</span> <span class="pl-c1">=</span> <span class="pl-s1">maxx</span> <span class="pl-c1">-</span> <span class="pl-s1">minx</span>
        <span class="pl-s1">height</span> <span class="pl-c1">=</span> <span class="pl-s1">maxy</span> <span class="pl-c1">-</span> <span class="pl-s1">miny</span>
        
        <span class="pl-s1">parts</span> <span class="pl-c1">=</span> []
        
        <span class="pl-k">if</span> <span class="pl-s1">n_parts</span> <span class="pl-c1">==</span> <span class="pl-c1">2</span>:
            <span class="pl-k">if</span> <span class="pl-s1">width</span> <span class="pl-c1">&gt;</span> <span class="pl-s1">height</span>:
                <span class="pl-s1">mid_x</span> <span class="pl-c1">=</span> (<span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-s1">maxx</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
                <span class="pl-s1">split_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">mid_x</span>, <span class="pl-s1">miny</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>)])
            <span class="pl-k">else</span>:
                <span class="pl-s1">mid_y</span> <span class="pl-c1">=</span> (<span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-s1">maxy</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
                <span class="pl-s1">split_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">minx</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>, <span class="pl-s1">mid_y</span>), (<span class="pl-s1">maxx</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>, <span class="pl-s1">mid_y</span>)])
            
            <span class="pl-s1">split_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">split_line</span>)
            <span class="pl-s1">parts</span> <span class="pl-c1">=</span> [<span class="pl-s1">part</span> <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">split_parts</span>.<span class="pl-c1">geoms</span> <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>]
            
        <span class="pl-k">elif</span> <span class="pl-s1">n_parts</span> <span class="pl-c1">==</span> <span class="pl-c1">3</span>:
            <span class="pl-k">if</span> <span class="pl-s1">width</span> <span class="pl-c1">&gt;</span> <span class="pl-s1">height</span>:
                <span class="pl-s1">x1</span> <span class="pl-c1">=</span> <span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-s1">width</span> <span class="pl-c1">/</span> <span class="pl-c1">3</span>
                <span class="pl-s1">x2</span> <span class="pl-c1">=</span> <span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-c1">2</span> <span class="pl-c1">*</span> <span class="pl-s1">width</span> <span class="pl-c1">/</span> <span class="pl-c1">3</span>
                <span class="pl-s1">split_line1</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">x1</span>, <span class="pl-s1">miny</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>), (<span class="pl-s1">x1</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>)])
                <span class="pl-s1">split_line2</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">x2</span>, <span class="pl-s1">miny</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>), (<span class="pl-s1">x2</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>)])
            <span class="pl-k">else</span>:
                <span class="pl-s1">y1</span> <span class="pl-c1">=</span> <span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-s1">height</span> <span class="pl-c1">/</span> <span class="pl-c1">3</span>
                <span class="pl-s1">y2</span> <span class="pl-c1">=</span> <span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-c1">2</span> <span class="pl-c1">*</span> <span class="pl-s1">height</span> <span class="pl-c1">/</span> <span class="pl-c1">3</span>
                <span class="pl-s1">split_line1</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">minx</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>, <span class="pl-s1">y1</span>), (<span class="pl-s1">maxx</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>, <span class="pl-s1">y1</span>)])
                <span class="pl-s1">split_line2</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">minx</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>, <span class="pl-s1">y2</span>), (<span class="pl-s1">maxx</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>, <span class="pl-s1">y2</span>)])
            
            <span class="pl-s1">temp_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">split_line1</span>)
            <span class="pl-s1">parts</span> <span class="pl-c1">=</span> []
            <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">temp_parts</span>.<span class="pl-c1">geoms</span>:
                <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>:
                    <span class="pl-s1">sub_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">part</span>, <span class="pl-s1">split_line2</span>)
                    <span class="pl-s1">parts</span>.<span class="pl-c1">extend</span>([<span class="pl-s1">p</span> <span class="pl-k">for</span> <span class="pl-s1">p</span> <span class="pl-c1">in</span> <span class="pl-s1">sub_parts</span>.<span class="pl-c1">geoms</span> <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">p</span>.<span class="pl-c1">is_empty</span>])
                    
        <span class="pl-k">elif</span> <span class="pl-s1">n_parts</span> <span class="pl-c1">==</span> <span class="pl-c1">4</span>:
            <span class="pl-s1">mid_x</span> <span class="pl-c1">=</span> (<span class="pl-s1">minx</span> <span class="pl-c1">+</span> <span class="pl-s1">maxx</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
            <span class="pl-s1">mid_y</span> <span class="pl-c1">=</span> (<span class="pl-s1">miny</span> <span class="pl-c1">+</span> <span class="pl-s1">maxy</span>) <span class="pl-c1">/</span> <span class="pl-c1">2</span>
            
            <span class="pl-s1">vert_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">mid_x</span>, <span class="pl-s1">miny</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>), (<span class="pl-s1">mid_x</span>, <span class="pl-s1">maxy</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>)])
            <span class="pl-s1">horz_line</span> <span class="pl-c1">=</span> <span class="pl-en">LineString</span>([(<span class="pl-s1">minx</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>, <span class="pl-s1">mid_y</span>), (<span class="pl-s1">maxx</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span>, <span class="pl-s1">mid_y</span>)])
            
            <span class="pl-s1">temp_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">vert_line</span>)
            <span class="pl-s1">parts</span> <span class="pl-c1">=</span> []
            <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">temp_parts</span>.<span class="pl-c1">geoms</span>:
                <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>:
                    <span class="pl-s1">sub_parts</span> <span class="pl-c1">=</span> <span class="pl-en">split</span>(<span class="pl-s1">part</span>, <span class="pl-s1">horz_line</span>)
                    <span class="pl-s1">parts</span>.<span class="pl-c1">extend</span>([<span class="pl-s1">p</span> <span class="pl-k">for</span> <span class="pl-s1">p</span> <span class="pl-c1">in</span> <span class="pl-s1">sub_parts</span>.<span class="pl-c1">geoms</span> <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">p</span>.<span class="pl-c1">is_empty</span>])
        
        <span class="pl-s1">valid_parts</span> <span class="pl-c1">=</span> [<span class="pl-s1">part</span> <span class="pl-k">for</span> <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-s1">parts</span> <span class="pl-k">if</span> <span class="pl-en">isinstance</span>(<span class="pl-s1">part</span>, (<span class="pl-v">Polygon</span>, <span class="pl-v">MultiPolygon</span>)) <span class="pl-c1">and</span> <span class="pl-c1">not</span> <span class="pl-s1">part</span>.<span class="pl-c1">is_empty</span>]
        
        <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">valid_parts</span>) <span class="pl-c1">&gt;=</span> <span class="pl-s1">n_parts</span>:
            <span class="pl-s1">valid_parts</span>.<span class="pl-c1">sort</span>(<span class="pl-s1">key</span><span class="pl-c1">=</span><span class="pl-k">lambda</span> <span class="pl-s1">x</span>: <span class="pl-s1">x</span>.<span class="pl-c1">area</span>, <span class="pl-s1">reverse</span><span class="pl-c1">=</span><span class="pl-c1">True</span>)
            <span class="pl-k">return</span> <span class="pl-s1">valid_parts</span>[:<span class="pl-s1">n_parts</span>]
        <span class="pl-k">else</span>:
            <span class="pl-k">return</span> [<span class="pl-s1">polygon</span>] <span class="pl-c1">*</span> <span class="pl-s1">n_parts</span>
            
    <span class="pl-k">except</span> <span class="pl-v">Exception</span>:
        <span class="pl-k">return</span> [<span class="pl-s1">polygon</span>] <span class="pl-c1">*</span> <span class="pl-s1">n_parts</span>

<span class="pl-k">def</span> <span class="pl-en">get_town_name_from_file</span>(<span class="pl-s1">shp_file</span>, <span class="pl-s1">gdf</span>):
    <span class="pl-s">"""从SHP文件获取乡镇名称"""</span>
    <span class="pl-c"># 尝试从字段中获取</span>
    <span class="pl-s1">name_fields</span> <span class="pl-c1">=</span> [<span class="pl-s">'名称'</span>, <span class="pl-s">'地名'</span>, <span class="pl-s">'name'</span>, <span class="pl-s">'NAME'</span>, <span class="pl-s">'乡镇名'</span>, <span class="pl-s">'镇名'</span>, <span class="pl-s">'town'</span>, <span class="pl-s">'TOWN'</span>]
    
    <span class="pl-k">for</span> <span class="pl-s1">field</span> <span class="pl-c1">in</span> <span class="pl-s1">name_fields</span>:
        <span class="pl-k">if</span> <span class="pl-s1">field</span> <span class="pl-c1">in</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">columns</span> <span class="pl-c1">and</span> <span class="pl-en">len</span>(<span class="pl-s1">gdf</span>) <span class="pl-c1">&gt;</span> <span class="pl-c1">0</span>:
            <span class="pl-s1">town_name</span> <span class="pl-c1">=</span> <span class="pl-s1">gdf</span>[<span class="pl-s1">field</span>].<span class="pl-c1">iloc</span>[<span class="pl-c1">0</span>]
            <span class="pl-k">if</span> <span class="pl-s1">pd</span>.<span class="pl-c1">notna</span>(<span class="pl-s1">town_name</span>) <span class="pl-c1">and</span> <span class="pl-s1">town_name</span> <span class="pl-c1">!=</span> <span class="pl-s">""</span>:
                <span class="pl-k">return</span> <span class="pl-en">str</span>(<span class="pl-s1">town_name</span>).<span class="pl-c1">strip</span>()
    
    <span class="pl-c"># 从文件名提取</span>
    <span class="pl-s1">base_name</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">splitext</span>(<span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">basename</span>(<span class="pl-s1">shp_file</span>))[<span class="pl-c1">0</span>]
    <span class="pl-s1">suffixes</span> <span class="pl-c1">=</span> [<span class="pl-s">'_边界'</span>, <span class="pl-s">'_polygon'</span>, <span class="pl-s">'_town'</span>, <span class="pl-s">'_乡镇'</span>, <span class="pl-s">'_boundary'</span>, <span class="pl-s">'_shp'</span>]
    
    <span class="pl-s1">town_name</span> <span class="pl-c1">=</span> <span class="pl-s1">base_name</span>
    <span class="pl-k">for</span> <span class="pl-s1">suffix</span> <span class="pl-c1">in</span> <span class="pl-s1">suffixes</span>:
        <span class="pl-k">if</span> <span class="pl-s1">town_name</span>.<span class="pl-c1">endswith</span>(<span class="pl-s1">suffix</span>):
            <span class="pl-s1">town_name</span> <span class="pl-c1">=</span> <span class="pl-s1">town_name</span>[:<span class="pl-c1">-</span><span class="pl-en">len</span>(<span class="pl-s1">suffix</span>)]
            <span class="pl-k">break</span>
    
    <span class="pl-k">return</span> <span class="pl-s1">town_name</span>

<span class="pl-k">def</span> <span class="pl-en">clean_town_name</span>(<span class="pl-s1">name</span>):
    <span class="pl-s">"""清理乡镇名称"""</span>
    <span class="pl-k">import</span> <span class="pl-s1">re</span>
    <span class="pl-k">if</span> <span class="pl-s1">name</span> <span class="pl-c1">is</span> <span class="pl-c1">None</span>:
        <span class="pl-k">return</span> <span class="pl-s">"未知乡镇"</span>
    
    <span class="pl-s1">illegal_chars</span> <span class="pl-c1">=</span> <span class="pl-s">r'[&lt;&gt;:"/\\|?*]'</span>
    <span class="pl-s1">cleaned</span> <span class="pl-c1">=</span> <span class="pl-s1">re</span>.<span class="pl-c1">sub</span>(<span class="pl-s1">illegal_chars</span>, <span class="pl-s">''</span>, <span class="pl-en">str</span>(<span class="pl-s1">name</span>))
    <span class="pl-s1">cleaned</span> <span class="pl-c1">=</span> <span class="pl-s1">cleaned</span>.<span class="pl-c1">strip</span>().<span class="pl-c1">strip</span>(<span class="pl-s">'.'</span>)
    
    <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">cleaned</span>) <span class="pl-c1">&gt;</span> <span class="pl-c1">50</span>:
        <span class="pl-s1">cleaned</span> <span class="pl-c1">=</span> <span class="pl-s1">cleaned</span>[:<span class="pl-c1">50</span>]
    
    <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">cleaned</span>:
        <span class="pl-s1">cleaned</span> <span class="pl-c1">=</span> <span class="pl-s">"未知乡镇"</span>
    
    <span class="pl-k">return</span> <span class="pl-s1">cleaned</span>

<span class="pl-k">def</span> <span class="pl-en">split_single_town_shp</span>(<span class="pl-s1">shp_file</span>, <span class="pl-s1">output_base_dir</span>, <span class="pl-s1">n_parts</span><span class="pl-c1">=</span><span class="pl-c1">2</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    切分单个乡镇SHP文件</span>
<span class="pl-s">    保存为: 输出目录/乡镇名/乡镇名-编号.shp</span>
<span class="pl-s">    """</span>
    <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">exists</span>(<span class="pl-s1">output_base_dir</span>):
        <span class="pl-s1">os</span>.<span class="pl-c1">makedirs</span>(<span class="pl-s1">output_base_dir</span>)
    
    <span class="pl-k">try</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"📥 读取文件: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">basename</span>(<span class="pl-s1">shp_file</span>)<span class="pl-kos">}</span></span>"</span>)
        <span class="pl-s1">gdf</span>, <span class="pl-s1">encoding</span> <span class="pl-c1">=</span> <span class="pl-en">read_shp_with_encoding</span>(<span class="pl-s1">shp_file</span>)
        
        <span class="pl-k">if</span> <span class="pl-s1">gdf</span> <span class="pl-c1">is</span> <span class="pl-c1">None</span>:
            <span class="pl-en">print</span>(<span class="pl-s">"❌ 无法读取SHP文件"</span>)
            <span class="pl-k">return</span> <span class="pl-c1">0</span>
        
        <span class="pl-c"># 获取乡镇名称</span>
        <span class="pl-s1">town_name</span> <span class="pl-c1">=</span> <span class="pl-en">get_town_name_from_file</span>(<span class="pl-s1">shp_file</span>, <span class="pl-s1">gdf</span>)
        <span class="pl-s1">town_name_clean</span> <span class="pl-c1">=</span> <span class="pl-en">clean_town_name</span>(<span class="pl-s1">town_name</span>)
        
        <span class="pl-en">print</span>(<span class="pl-s">f"🏘️  乡镇名称: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town_name_clean</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"📊 要素数量: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">len</span>(<span class="pl-s1">gdf</span>)<span class="pl-kos">}</span></span>"</span>)
        
        <span class="pl-c"># 创建乡镇目录</span>
        <span class="pl-s1">town_dir</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">join</span>(<span class="pl-s1">output_base_dir</span>, <span class="pl-s1">town_name_clean</span>)
        <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">exists</span>(<span class="pl-s1">town_dir</span>):
            <span class="pl-s1">os</span>.<span class="pl-c1">makedirs</span>(<span class="pl-s1">town_dir</span>)
        
        <span class="pl-s1">total_files_created</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>
        
        <span class="pl-en">print</span>(<span class="pl-s">f"🔪 开始切分为 <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">n_parts</span><span class="pl-kos">}</span></span> 块..."</span>)
        
        <span class="pl-c"># 使用进度条</span>
        <span class="pl-k">with</span> <span class="pl-en">tqdm</span>(<span class="pl-s1">total</span><span class="pl-c1">=</span><span class="pl-en">len</span>(<span class="pl-s1">gdf</span>), <span class="pl-s1">desc</span><span class="pl-c1">=</span><span class="pl-s">"切分进度"</span>) <span class="pl-k">as</span> <span class="pl-s1">pbar</span>:
            <span class="pl-k">for</span> <span class="pl-s1">idx</span>, <span class="pl-s1">row</span> <span class="pl-c1">in</span> <span class="pl-s1">gdf</span>.<span class="pl-c1">iterrows</span>():
                <span class="pl-s1">geometry</span> <span class="pl-c1">=</span> <span class="pl-s1">row</span>.<span class="pl-c1">geometry</span>
                
                <span class="pl-k">if</span> <span class="pl-en">isinstance</span>(<span class="pl-s1">geometry</span>, <span class="pl-v">MultiPolygon</span>):
                    <span class="pl-s1">polygons</span> <span class="pl-c1">=</span> <span class="pl-en">list</span>(<span class="pl-s1">geometry</span>.<span class="pl-c1">geoms</span>)
                <span class="pl-k">else</span>:
                    <span class="pl-s1">polygons</span> <span class="pl-c1">=</span> [<span class="pl-s1">geometry</span>]
                
                <span class="pl-c"># 切分每个多边形</span>
                <span class="pl-k">for</span> <span class="pl-s1">poly_idx</span>, <span class="pl-s1">polygon</span> <span class="pl-c1">in</span> <span class="pl-en">enumerate</span>(<span class="pl-s1">polygons</span>):
                    <span class="pl-s1">parts</span> <span class="pl-c1">=</span> <span class="pl-en">split_polygon_into_n_parts</span>(<span class="pl-s1">polygon</span>, <span class="pl-s1">n_parts</span>)
                    
                    <span class="pl-c"># 保存每个部分</span>
                    <span class="pl-k">for</span> <span class="pl-s1">i</span>, <span class="pl-s1">part</span> <span class="pl-c1">in</span> <span class="pl-en">enumerate</span>(<span class="pl-s1">parts</span>[:<span class="pl-s1">n_parts</span>], <span class="pl-c1">1</span>):
                        <span class="pl-s1">new_row</span> <span class="pl-c1">=</span> <span class="pl-s1">row</span>.<span class="pl-c1">copy</span>()
                        <span class="pl-s1">new_row</span>.<span class="pl-c1">geometry</span> <span class="pl-c1">=</span> <span class="pl-s1">part</span>
                        
                        <span class="pl-c"># 添加切分信息</span>
                        <span class="pl-s1">new_row</span>[<span class="pl-s">'SPLIT_ID'</span>] <span class="pl-c1">=</span> <span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town_name_clean</span><span class="pl-kos">}</span></span>-<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">i</span><span class="pl-kos">}</span></span>"</span>
                        <span class="pl-s1">new_row</span>[<span class="pl-s">'ORIGINAL_TOWN'</span>] <span class="pl-c1">=</span> <span class="pl-s1">town_name</span>
                        <span class="pl-s1">new_row</span>[<span class="pl-s">'SPLIT_PART'</span>] <span class="pl-c1">=</span> <span class="pl-s1">i</span>
                        <span class="pl-s1">new_row</span>[<span class="pl-s">'TOTAL_PARTS'</span>] <span class="pl-c1">=</span> <span class="pl-s1">n_parts</span>
                        
                        <span class="pl-s1">single_gdf</span> <span class="pl-c1">=</span> <span class="pl-s1">gpd</span>.<span class="pl-c1">GeoDataFrame</span>([<span class="pl-s1">new_row</span>], <span class="pl-s1">geometry</span><span class="pl-c1">=</span><span class="pl-s">'geometry'</span>, <span class="pl-s1">crs</span><span class="pl-c1">=</span><span class="pl-s1">gdf</span>.<span class="pl-c1">crs</span>)
                        
                        <span class="pl-c"># 生成文件名</span>
                        <span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">polygons</span>) <span class="pl-c1">&gt;</span> <span class="pl-c1">1</span>:
                            <span class="pl-s1">file_name</span> <span class="pl-c1">=</span> <span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town_name_clean</span><span class="pl-kos">}</span></span>-<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">poly_idx</span><span class="pl-c1">+</span><span class="pl-c1">1</span><span class="pl-kos">}</span></span>-<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">i</span><span class="pl-kos">}</span></span>"</span>
                        <span class="pl-k">else</span>:
                            <span class="pl-s1">file_name</span> <span class="pl-c1">=</span> <span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town_name_clean</span><span class="pl-kos">}</span></span>-<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">i</span><span class="pl-kos">}</span></span>"</span>
                        
                        <span class="pl-s1">output_path</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">join</span>(<span class="pl-s1">town_dir</span>, <span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">file_name</span><span class="pl-kos">}</span></span>.shp"</span>)
                        
                        <span class="pl-k">try</span>:
                            <span class="pl-s1">single_gdf</span>.<span class="pl-c1">to_file</span>(<span class="pl-s1">output_path</span>, <span class="pl-s1">encoding</span><span class="pl-c1">=</span><span class="pl-s">'utf-8'</span>)
                            <span class="pl-s1">total_files_created</span> <span class="pl-c1">+=</span> <span class="pl-c1">1</span>
                        <span class="pl-k">except</span> <span class="pl-v">Exception</span>:
                            <span class="pl-k">pass</span>
                
                <span class="pl-s1">pbar</span>.<span class="pl-c1">update</span>(<span class="pl-c1">1</span>)
        
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>🎉 切分完成!"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"📊 创建文件: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">total_files_created</span><span class="pl-kos">}</span></span> 个"</span>)
        <span class="pl-en">print</span>(<span class="pl-s">f"📁 输出目录: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">town_dir</span><span class="pl-kos">}</span></span>"</span>)
        
        <span class="pl-c"># 显示生成的文件</span>
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>📄 生成的文件:"</span>)
        <span class="pl-s1">shp_files</span> <span class="pl-c1">=</span> [<span class="pl-s1">f</span> <span class="pl-k">for</span> <span class="pl-s1">f</span> <span class="pl-c1">in</span> <span class="pl-s1">os</span>.<span class="pl-c1">listdir</span>(<span class="pl-s1">town_dir</span>) <span class="pl-k">if</span> <span class="pl-s1">f</span>.<span class="pl-c1">endswith</span>(<span class="pl-s">'.shp'</span>)]
        <span class="pl-k">for</span> <span class="pl-s1">file</span> <span class="pl-c1">in</span> <span class="pl-s1">shp_files</span>:
            <span class="pl-en">print</span>(<span class="pl-s">f"  • <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">file</span><span class="pl-kos">}</span></span>"</span>)
        
        <span class="pl-k">return</span> <span class="pl-s1">total_files_created</span>
        
    <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"❌ 处理失败: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">e</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">return</span> <span class="pl-c1">0</span>

<span class="pl-c"># 使用示例</span>
<span class="pl-k">if</span> <span class="pl-s1">__name__</span> <span class="pl-c1">==</span> <span class="pl-s">"__main__"</span>:
    <span class="pl-c"># 单个文件切分示例</span>
    <span class="pl-s1">town_shp_file</span> <span class="pl-c1">=</span> <span class="pl-s">"停洞镇.shp"</span>  <span class="pl-c"># 替换为您的乡镇SHP文件</span>
    <span class="pl-s1">output_base_dir</span> <span class="pl-c1">=</span> <span class="pl-s">"单个乡镇切分结果"</span>
    <span class="pl-s1">n_parts</span> <span class="pl-c1">=</span> <span class="pl-c1">4</span>
    
    <span class="pl-en">print</span>(<span class="pl-s">"🗺️  单个乡镇边界切分工具"</span>)
    <span class="pl-en">print</span>(<span class="pl-s">"="</span> <span class="pl-c1">*</span> <span class="pl-c1">40</span>)
    <span class="pl-en">print</span>(<span class="pl-s">f"目标结构: 乡镇名/乡镇名-编号.shp"</span>)
    <span class="pl-en">print</span>(<span class="pl-s">"="</span> <span class="pl-c1">*</span> <span class="pl-c1">40</span>)
    
    <span class="pl-s1">files_created</span> <span class="pl-c1">=</span> <span class="pl-en">split_single_town_shp</span>(
        <span class="pl-s1">shp_file</span><span class="pl-c1">=</span><span class="pl-s1">town_shp_file</span>,
        <span class="pl-s1">output_base_dir</span><span class="pl-c1">=</span><span class="pl-s1">output_base_dir</span>,
        <span class="pl-s1">n_parts</span><span class="pl-c1">=</span><span class="pl-s1">n_parts</span>
    )
    
    <span class="pl-k">if</span> <span class="pl-s1">files_created</span> <span class="pl-c1">&gt;</span> <span class="pl-c1">0</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>✅ 任务完成! 生成 <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">files_created</span><span class="pl-kos">}</span></span> 个文件"</span>)
    <span class="pl-k">else</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>❌ 处理失败"</span>)</pre></div>
<h3>效果</h3>
<p><a target="_blank" rel="noopener noreferrer" href=""><img alt="image-20251107203916757" style="max-width: 100%;"></a></p>
<h2>最后一个跳转</h2></div>
<div style="font-size:small;margin-top:8px;float:right;"></div>

<button class="btn btn-block" type="button" onclick="openComments()" id="cmButton">评论</button>
<div class="comments" id="comments"></div>

</div>
    <div id="footer"><div id="footer1">Copyright © <span id="copyrightYear"></span> <a href="https://wzh922.github.io/blog">狒材的blog</a></div>
<div id="footer2">
    <span id="runday"></span><span>Powered by <a href="https://meekdai.com/Gmeek.html" target="_blank">Gmeek</a></span>
</div>

<script>
var now=new Date();
document.getElementById("copyrightYear").innerHTML=now.getFullYear();

if("05/29/2025"!=""){
    var startSite=new Date("05/29/2025");
    var diff=now.getTime()-startSite.getTime();
    var diffDay=Math.floor(diff/(1000*60*60*24));
    document.getElementById("runday").innerHTML="网站运行 "+diffDay+" 天"+" • ";
}
</script></div>
</body>
<script>
var IconList={'sun': 'M8 10.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0V.75A.75.75 0 018 0zm0 13a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 018 13zM2.343 2.343a.75.75 0 011.061 0l1.06 1.061a.75.75 0 01-1.06 1.06l-1.06-1.06a.75.75 0 010-1.06zm9.193 9.193a.75.75 0 011.06 0l1.061 1.06a.75.75 0 01-1.06 1.061l-1.061-1.06a.75.75 0 010-1.061zM16 8a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 0116 8zM3 8a.75.75 0 01-.75.75H.75a.75.75 0 010-1.5h1.5A.75.75 0 013 8zm10.657-5.657a.75.75 0 010 1.061l-1.061 1.06a.75.75 0 11-1.06-1.06l1.06-1.06a.75.75 0 011.06 0zm-9.193 9.193a.75.75 0 010 1.06l-1.06 1.061a.75.75 0 11-1.061-1.06l1.06-1.061a.75.75 0 011.061 0z', 'moon': 'M9.598 1.591a.75.75 0 01.785-.175 7 7 0 11-8.967 8.967.75.75 0 01.961-.96 5.5 5.5 0 007.046-7.046.75.75 0 01.175-.786zm1.616 1.945a7 7 0 01-7.678 7.678 5.5 5.5 0 107.678-7.678z', 'sync': 'M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z', 'home': 'M6.906.664a1.749 1.749 0 0 1 2.187 0l5.25 4.2c.415.332.657.835.657 1.367v7.019A1.75 1.75 0 0 1 13.25 15h-3.5a.75.75 0 0 1-.75-.75V9H7v5.25a.75.75 0 0 1-.75.75h-3.5A1.75 1.75 0 0 1 1 13.25V6.23c0-.531.242-1.034.657-1.366l5.25-4.2Zm1.25 1.171a.25.25 0 0 0-.312 0l-5.25 4.2a.25.25 0 0 0-.094.196v7.019c0 .138.112.25.25.25H5.5V8.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .75.75v5.25h2.75a.25.25 0 0 0 .25-.25V6.23a.25.25 0 0 0-.094-.195Z', 'github': 'M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z', 'copy': 'M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z', 'check': 'M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z'};
var utterancesLoad=0;

let themeSettings={
    "dark": ["dark","moon","#00f0ff","dark-blue"],
    "light": ["light","sun","#ff5000","github-light"],
    "auto": ["auto","sync","","preferred-color-scheme"]
};
function changeTheme(mode, icon, color, utheme){
    document.documentElement.setAttribute("data-color-mode",mode);
    document.getElementById("themeSwitch").setAttribute("d",value=IconList[icon]);
    document.getElementById("themeSwitch").parentNode.style.color=color;
    if(utterancesLoad==1){utterancesTheme(utheme);}
}
function modeSwitch(){
    let currentMode=document.documentElement.getAttribute('data-color-mode');
    let newMode = currentMode === "light" ? "dark" : currentMode === "dark" ? "auto" : "light";
    localStorage.setItem("meek_theme", newMode);
    if(themeSettings[newMode]){
        changeTheme(...themeSettings[newMode]);
    }
}
function utterancesTheme(theme){
    const message={type:'set-theme',theme: theme};
    const iframe=document.getElementsByClassName('utterances-frame')[0];
    iframe.contentWindow.postMessage(message,'https://utteranc.es');
}
if(themeSettings[theme]){changeTheme(...themeSettings[theme]);}
console.log("\n %c Gmeek last https://github.com/Meekdai/Gmeek \n","padding:5px 0;background:#02d81d;color:#fff");
</script>

<script>
document.getElementById("pathHome").setAttribute("d",IconList["home"]);
document.getElementById("pathIssue").setAttribute("d",IconList["github"]);



function openComments(){
    cm=document.getElementById("comments");
    cmButton=document.getElementById("cmButton");
    cmButton.disabled=true;
    cmButton.innerHTML="loading";
    span=document.createElement("span");
    span.setAttribute("class","AnimatedEllipsis");
    cmButton.appendChild(span);

    script=document.createElement("script");
    script.setAttribute("src","https://utteranc.es/client.js");
    script.setAttribute("repo","wzh922/blog");
    script.setAttribute("issue-term","title");
    
    if(localStorage.getItem("meek_theme")=="dark"){script.setAttribute("theme","dark-blue");}
    else if(localStorage.getItem("meek_theme")=="light") {script.setAttribute("theme","github-light");}
    else{script.setAttribute("theme","preferred-color-scheme");}
    
    script.setAttribute("crossorigin","anonymous");
    script.setAttribute("async","");
    cm.appendChild(script);

    int=self.setInterval("iFrameLoading()",200);
}

function iFrameLoading(){
    var utterances=document.getElementsByClassName('utterances');
    if(utterances.length==1){
        if(utterances[0].style.height!=""){
            utterancesLoad=1;
            int=window.clearInterval(int);
            document.getElementById("cmButton").style.display="none";
            console.log("utterances Load OK");
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const createClipboardHTML = (codeContent, additionalClasses = '') => `
        <pre class="notranslate"><code class="notranslate">${codeContent}</code></pre>
        <div class="clipboard-container position-absolute right-0 top-0 ${additionalClasses}">
            <clipboard-copy class="ClipboardButton btn m-2 p-0" role="button" style="display: inherit;">
                <svg height="16" width="16" class="octicon octicon-copy m-2"><path d="${IconList["copy"]}"></path></svg>
                <svg height="16" width="16" class="octicon octicon-check color-fg-success m-2 d-none"><path d="${IconList["check"]}"></path></svg>
            </clipboard-copy>
            <div class="copy-feedback">Copied!</div>
        </div>
    `;

    const handleCodeElements = (selector = '') => {
        document.querySelectorAll(selector).forEach(codeElement => {
            const codeContent = codeElement.innerHTML;
            const newStructure = document.createElement('div');
            newStructure.className = 'snippet-clipboard-content position-relative overflow-auto';
            newStructure.innerHTML = createClipboardHTML(codeContent);

            const parentElement = codeElement.parentElement;
            if (selector.includes('highlight')) {
                parentElement.insertBefore(newStructure, codeElement.nextSibling);
                parentElement.removeChild(codeElement);
            } else {
                parentElement.parentElement.replaceChild(newStructure, parentElement);
            }
        });
    };

    handleCodeElements('pre.notranslate > code.notranslate');
    handleCodeElements('div.highlight > pre.notranslate');

    let currentFeedback = null;
    document.querySelectorAll('clipboard-copy').forEach(copyButton => {
        copyButton.addEventListener('click', () => {
            const codeContent = copyButton.closest('.snippet-clipboard-content').innerText;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = codeContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            const copyIcon = copyButton.querySelector('.octicon-copy');
            const checkIcon = copyButton.querySelector('.octicon-check');
            const copyFeedback = copyButton.nextElementSibling;

            if (currentFeedback && currentFeedback !== copyFeedback) {currentFeedback.style.display = 'none';}
            currentFeedback = copyFeedback;

            copyIcon.classList.add('d-none');
            checkIcon.classList.remove('d-none');
            copyFeedback.style.display = 'block';
            copyButton.style.borderColor = 'var(--color-success-fg)';

            setTimeout(() => {
                copyIcon.classList.remove('d-none');
                checkIcon.classList.add('d-none');
                copyFeedback.style.display = 'none';
                copyButton.style.borderColor = '';
            }, 2000);
        });
    });
});

</script>
<script src='https://blog.meekdai.com/Gmeek/plugins/GmeekTOC.js'></script><script src='https://blog.meekdai.com/Gmeek/plugins/lightbox.js'></script>

</html>
